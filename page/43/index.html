<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="越努力越幸运">
<meta property="og:type" content="website">
<meta property="og:title" content="默默">
<meta property="og:url" content="https://yangjinheng.github.io/page/43/index.html">
<meta property="og:site_name" content="默默">
<meta property="og:description" content="越努力越幸运">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="默默">
<meta name="twitter:description" content="越努力越幸运">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yangjinheng.github.io/page/43/">





  <title>默默</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?be46574a10a6c2b7f67e9c32a008cbd5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">默默</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-前端知识">
          <a href="/categories/web/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-asterisk"></i> <br>
            
            前端知识
          </a>
        </li>
      
        
        <li class="menu-item menu-item-kubernetes">
          <a href="/categories/Kubernetes/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cog"></i> <br>
            
            Kubernetes
          </a>
        </li>
      
        
        <li class="menu-item menu-item-运维笔记">
          <a href="/categories/运维笔记/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            运维笔记
          </a>
        </li>
      
        
        <li class="menu-item menu-item-python">
          <a href="/categories/Python/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-laptop"></i> <br>
            
            Python
          </a>
        </li>
      
        
        <li class="menu-item menu-item-golang">
          <a href="/categories/golang/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>
            
            Golang
          </a>
        </li>
      
        
        <li class="menu-item menu-item-个人日志">
          <a href="/categories/个人日志/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-github-alt"></i> <br>
            
            个人日志
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            给我留言
          </a>
        </li>
      

      
    </ul>
  

  
</nav>


 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yangjinheng.github.io/2017/03/20/Linux/Ansible/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jin Heng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="默默">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/03/20/Linux/Ansible/" itemprop="url">Ansible学习记录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-20T00:00:00+08:00">
                2017-03-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维笔记/" itemprop="url" rel="index">
                    <span itemprop="name">运维笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="Ansible简介"><a href="#Ansible简介" class="headerlink" title="Ansible简介"></a>Ansible简介</h1><p>Ansible是一款轻量级自动化运维工具，由 Python 语言开发，结合了多种自动化运维工具的特性，实现了批量系统配置、批量程序部署、批量命令执行等功能；Ansible 是基于模块化实现批量操作的。</p>
<p>Ansible官网：<a href="https://www.ansible.com/，github地址：https://github.com/Ansible" target="_blank" rel="noopener">https://www.ansible.com/，github地址：https://github.com/Ansible</a></p>
<ul>
<li>特点</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-   模块化，调用特定的模块，完成特定的任务</span><br><span class="line">-   支持 API 及自定义模块，可通过 Python 轻松扩展</span><br><span class="line">-   部署简单，只需在主控端部署 Ansible 环境，远程主机无需做任何操作</span><br><span class="line">-   默认使用 SSH 协议对设备进行管理</span><br><span class="line">-   主从集中化管理</span><br><span class="line">-   配置简单、功能强大、扩展性强</span><br><span class="line">-   通过 Playbooks 来定制强大的配置、状态管理</span><br><span class="line">-   对云计算平台、大数据都有很好的支持</span><br><span class="line">-   提供一个功能强大、操作性强的 Web 管理界面和 REST API 接口 —— AWS平台</span><br><span class="line">-   幂等性：一种操作重复多次结果相同，幂等性不会重复执行相同的指令。</span><br></pre></td></tr></table></figure>
<ul>
<li>基本组件</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ansible</td>
<td>核心程序</td>
<td>Ansible的核心程序</td>
</tr>
<tr>
<td>Host Inventory</td>
<td>主机库</td>
<td>主机清单，记录了被 Ansible 管理的主机信息，包括 ssh 端口，root帐号密码，ip地址等等。可以通过file来加载，可以通过 CMDB 加载</td>
</tr>
<tr>
<td>Playbooks</td>
<td>剧本</td>
<td>YAML格式文件，多个任务定义在一个文件中，使用时可以统一调用，“剧本”用来定义那些主机需要调用那些模块来完成的功能.</td>
</tr>
<tr>
<td>Core Modules</td>
<td>核心模块</td>
<td>各种模块核心模块、command模块</td>
</tr>
<tr>
<td>Custom Modules</td>
<td>自定义模块</td>
<td>完成Ansible核心模块无法完成的功能，此模块支持任何语言编写</td>
</tr>
<tr>
<td>Connection Plugins</td>
<td>连接插件</td>
<td>负责和被监控端实现通信。</td>
</tr>
</tbody>
</table>
<h2 id="Ansible安装"><a href="#Ansible安装" class="headerlink" title="Ansible安装"></a>Ansible安装</h2><ul>
<li>yum 安装</li>
</ul>
<p>Ansible 基于 Python 开发，所以需要系统内 Python 2.6 或 Python 2.7 才可以运行 Ansible，linux 默认集成的 python，所以远程主机的主机无须安装任何客户端。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum install ansible</span><br></pre></td></tr></table></figure>
<h2 id="virtualenv-安装"><a href="#virtualenv-安装" class="headerlink" title="virtualenv 安装"></a>virtualenv 安装</h2><ul>
<li>安装 Python</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./configure --prefix=/usr/<span class="built_in">local</span>/python3.7 --<span class="built_in">enable</span>-optimizations --<span class="built_in">enable</span>-shared LDFLAGS=-Wl,-rpath=/usr/<span class="built_in">local</span>/python3.7/lib</span><br><span class="line"></span><br><span class="line">$ make &amp;&amp; make altinstall</span><br><span class="line"></span><br><span class="line">$ ln -svf /usr/<span class="built_in">local</span>/python3.7/bin/python3.7 /usr/<span class="built_in">local</span>/bin/</span><br><span class="line">$ ln -svf /usr/<span class="built_in">local</span>/python3.7/bin/pip3.7 /usr/<span class="built_in">local</span>/bin/</span><br></pre></td></tr></table></figure>
<ul>
<li>安装虚拟环境并进入</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip3 install virtualenv</span><br><span class="line">$ ln -svf /usr/<span class="built_in">local</span>/python3.7/bin/virtualenv /usr/<span class="built_in">local</span>/bin/</span><br><span class="line"></span><br><span class="line">$ virtualenv --no-site-packages .venv   <span class="comment"># 创建没有任何包的 env</span></span><br><span class="line">$ <span class="built_in">source</span> .venv/bin/activate             <span class="comment"># 激活虚拟环境，使用 deactivate 退出</span></span><br></pre></td></tr></table></figure>
<ul>
<li>安装 ansible 依赖</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install paramiko PyYAML jinja2</span><br><span class="line">$ pip freeze &gt; requirements.txt</span><br></pre></td></tr></table></figure>
<ul>
<li>克隆 ansible 并进入源码目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/ansible/ansible.git</span><br><span class="line">$ <span class="built_in">cd</span> ansible</span><br><span class="line">$ git checkout stable-2.5</span><br></pre></td></tr></table></figure>
<ul>
<li>在虚拟环境下安装 ansible ，并验证 ansible 版本</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">source</span> ansible/hacking/env-setup -q</span><br><span class="line">$ ansible --version</span><br></pre></td></tr></table></figure>
<ul>
<li>设置环境变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PATH=/root/.venv/ansible/bin:/root/.venv/bin:/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/usr/sbin:/usr/bin:/root/bin</span><br><span class="line">PYTHONPATH=/root/.venv/ansible/lib</span><br><span class="line">MANPATH=/root/.venv/ansible/docs/man</span><br></pre></td></tr></table></figure>
<h2 id="程序文件"><a href="#程序文件" class="headerlink" title="程序文件"></a>程序文件</h2><table>
<thead>
<tr>
<th>文件</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>/usr/bin/ansible</td>
<td>主程序，临时命令执行工具</td>
</tr>
<tr>
<td>/etc/ansible/hosts</td>
<td>主机清单</td>
</tr>
<tr>
<td>/etc/ansible/roles/</td>
<td>存放角色的目录</td>
</tr>
<tr>
<td>/etc/ansible/ansible.cfg</td>
<td>主配置文件，配置 ansible 工作特性</td>
</tr>
<tr>
<td>/usr/bin/ansible-doc</td>
<td>查看配置文档，模块功能查看工具</td>
</tr>
<tr>
<td>/usr/bin/ansible-galaxy</td>
<td>下载/上传优秀代码或 Roles 模块的官网平台</td>
</tr>
<tr>
<td>/usr/bin/ansible-playbook</td>
<td>定制自动化任务，编排剧本工具</td>
</tr>
<tr>
<td>/usr/bin/ansible-pull</td>
<td>远程执行命令的工具</td>
</tr>
<tr>
<td>/usr/bin/ansible-vault</td>
<td>文件加密工具</td>
</tr>
<tr>
<td>/usr/bin/ansible-console</td>
<td>基于 Console 界面与用户交互的执行工具</td>
</tr>
<tr>
<td>/usr/share/ansible_plugins/</td>
<td>插件目录</td>
</tr>
</tbody>
</table>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><ul>
<li>/etc/ansible/ansible.cfg</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[defaults]</span><br><span class="line">inventory = /etc/ansible/hosts          # 主机列表配置文件</span><br><span class="line">library = /usr/share/my_modules/        # 库文件存放目录</span><br><span class="line">remote_tmp = $HOME/.ansible/tmp         # 临时py命令文件存放在远程主机目录</span><br><span class="line">local_tmp = $HOME/.ansible/tmp          # 本机的临时命令执行目录</span><br><span class="line">forks = 5                               # 默认并发数</span><br><span class="line">sudo_user = root                        # 默认 sudo 用户</span><br><span class="line">ask_sudo_pass = True                    # 每次执行ansible命令是否询问 ssh 密码</span><br><span class="line">ask_pass = True                         # 连接时提示输入 ssh 密码</span><br><span class="line">remote_port = 22                        # 远程主机的默认端口，生产中这个端口应该会不同</span><br><span class="line">log_path = /var/log/ansible.log         # 日志</span><br><span class="line">host_key_checking = False               # 检查对应服务器的 host_key，建议取消注释。也就是不会弹出</span><br></pre></td></tr></table></figure>
<h1 id="inventory"><a href="#inventory" class="headerlink" title="inventory"></a>inventory</h1><h2 id="inventory-主机清单"><a href="#inventory-主机清单" class="headerlink" title="inventory 主机清单"></a>inventory 主机清单</h2><p>Inventory 是主机清单，记录了被 Ansible 管理的主机信息，包括ssh端口，root帐号密码，ip 地址等等，默认的 Inventory file 在 /etc/ansible/hosts，格式与 ini 配置文件类似。</p>
<ul>
<li>主机</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">node1.example.com</span><br><span class="line">node2.example.com</span><br><span class="line">node3.example.com</span><br></pre></td></tr></table></figure>
<ul>
<li>不使用域名解析对 IP 主机设置别名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">jumper ansible_ssh_host=192.168.1.50 ansible_ssh_port=5555</span><br></pre></td></tr></table></figure>
<ul>
<li>主机组，方括号是组的名称</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[webservers]</span><br><span class="line">foo.example.com</span><br><span class="line">bar.example.com</span><br><span class="line">badwolf.example.com:5309     # 如果有主机不是通过 22 端口连接，那么可以使用冒号来标识这个主机的 SSH 端口</span><br><span class="line"></span><br><span class="line">[connect]</span><br><span class="line">www[01:50].example.com       # 可以通过范围简写模式来表示多个主机</span><br><span class="line"></span><br><span class="line">[databases]</span><br><span class="line">db-[a:f].example.com         # 可以通过范围简写模式来表示多个主机</span><br></pre></td></tr></table></figure>
<ul>
<li>特殊的连接方式可选项</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[targets]</span><br><span class="line"></span><br><span class="line">localhost              ansible_connection=local</span><br><span class="line">other1.example.com     ansible_connection=ssh        ansible_ssh_user=mpdehaan</span><br><span class="line">other2.example.com     ansible_connection=ssh        ansible_ssh_user=mdehaan</span><br></pre></td></tr></table></figure>
<h3 id="可用选项"><a href="#可用选项" class="headerlink" title="可用选项"></a>可用选项</h3><table>
<thead>
<tr>
<th>值</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>ansible_ssh_host</td>
<td>指定主机别名对应的真实 IP，如web ansible_ssh_host=183.60.41.251，随后连接该主机无须指定完整 IP，只需指定 web 就行</td>
</tr>
<tr>
<td>ansible_ssh_port</td>
<td>指定连接到这个主机的 ssh 端口，默认 22</td>
</tr>
<tr>
<td>ansible_ssh_user</td>
<td>连接到该主机的 ssh 用户</td>
</tr>
<tr>
<td>ansible_ssh_pass</td>
<td>ssh 密码(这种方式并不安全,我们强烈建议使用 -k参数 或 SSH 密钥)</td>
</tr>
<tr>
<td>ansible_sudo_pass</td>
<td>sudo 密码(这种方式并不安全,我们强烈建议使用 –ask-sudo-pass)</td>
</tr>
<tr>
<td>ansible_sudo_exe</td>
<td>sudo 命令路径</td>
</tr>
<tr>
<td>ansible_connection</td>
<td>连接类型，可以是 local、ssh 或 paramiko，ansible1.2 之前默认为 paramiko</td>
</tr>
<tr>
<td>ansible_ssh_private_key_file</td>
<td>私钥文件路径</td>
</tr>
<tr>
<td>ansible_shell_type</td>
<td>目标系统的 shell 类型，默认为 sh,如果设置 csh/fish，那么命令需要遵循它们语法</td>
</tr>
<tr>
<td>ansible_python_interpreter</td>
<td>python 解释器路径，默认是/usr/bin/python，但是如要要连*BSD系统的话，就需要该指令修改 python 路径</td>
</tr>
</tbody>
</table>
<h3 id="超集组"><a href="#超集组" class="headerlink" title="超集组"></a>超集组</h3><ul>
<li>可以把一个组作为另外一个组的子成员，使用 :children 将组作为另外一个组的子成员</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[other]</span><br><span class="line">web1.example.com</span><br><span class="line">web2.example.com</span><br><span class="line"></span><br><span class="line">[db]</span><br><span class="line">db1.example.com</span><br><span class="line">db2.example.com</span><br><span class="line"></span><br><span class="line">[vserver:children]    </span><br><span class="line">other</span><br><span class="line">db</span><br></pre></td></tr></table></figure>
<h3 id="变量定义"><a href="#变量定义" class="headerlink" title="变量定义"></a>变量定义</h3><p>分配变量给主机、组，那么这些变量定义后可在 playbooks 中使用。</p>
<ul>
<li>定义主机变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[atlanta]</span><br><span class="line">other1.example.com http_port=80 maxRequestsPerChild=808</span><br><span class="line">other2.example.com http_port=303 maxRequestsPerChild=909</span><br></pre></td></tr></table></figure>
<ul>
<li>定义组变量，使用 :vars 来标记一个组的变量定义</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[atlanta]</span><br><span class="line">other1.example.com</span><br><span class="line">other2.example.com</span><br><span class="line"></span><br><span class="line">[atlanta:vars]</span><br><span class="line">ntp_server=ntp.atlanta.example.com</span><br><span class="line">proxy=proxy.atlanta.example.com</span><br></pre></td></tr></table></figure>
<h3 id="变量配置文件"><a href="#变量配置文件" class="headerlink" title="变量配置文件"></a>变量配置文件</h3><p>可以将主机、组的配置文件分开存放，假设 inventory 文件的路径为: /etc/ansible/hosts。</p>
<ul>
<li>/etc/ansible/hosts</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[web]</span><br><span class="line">web1.example.com</span><br><span class="line"></span><br><span class="line">[atlanta]</span><br><span class="line">other1.example.com</span><br><span class="line">other2.example.com</span><br></pre></td></tr></table></figure>
<ul>
<li>为 web1.example.com 主机定义变量可以写在 /etc/ansible/host_vars/web1.example.com 文件中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">http_port: 80</span><br><span class="line">maxRequestsPerChild: 808</span><br></pre></td></tr></table></figure>
<ul>
<li>为 atlanta 组定义变量可以写在 /etc/ansible/group_vars/atlanta 文件中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">ntp_server: acme.example.org</span><br><span class="line">database_server: storage.example.org</span><br></pre></td></tr></table></figure>
<h2 id="动态-inventory"><a href="#动态-inventory" class="headerlink" title="动态 inventory"></a>动态 inventory</h2><p>除默认文件外，你还可以同时使用多个 inventory 文件，也可以从动态源，或云上拉取 inventory 配置信息。</p>
<h3 id="多inventory文件"><a href="#多inventory文件" class="headerlink" title="多inventory文件"></a>多inventory文件</h3><p>语法：<code>ansible -i &lt;INVENTORY&gt;</code></p>
<p>如果 -i 选项后给出的地址是一个目录，Ansible 可以同一时间使用多个 inventory 源，这样在同一个 ansible 运行操作中，可混合的使用动态和静态的 inventory 源。</p>
<h3 id="inventory-脚本"><a href="#inventory-脚本" class="headerlink" title="inventory 脚本"></a>inventory 脚本</h3><p>如果 -i 选项后给出的地址是一个脚本，Ansible 可以执行这个脚本，使用脚本返回的结果中的主机列表。</p>
<ul>
<li>脚本规约</li>
</ul>
<p>用于生成 JSON 的脚本对实现语言没有要求，它可以是一个可执行脚本、二进制文件，或者其他任何可以运行文件，但是必须输出为 JSON 格式，这个脚本同时必须支持两个参数：</p>
<table>
<thead>
<tr>
<th>脚本参数</th>
<th>执行结果</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--list</code></td>
<td>返回所有的主机组信息</td>
</tr>
<tr>
<td><code>--host &lt;hostname&gt;</code></td>
<td>返回指定主机的变量列表，或者返回一个空的字典</td>
</tr>
</tbody>
</table>
<ul>
<li>这是一份主机清单，下面我们将它转化为 inventory 脚本的输出</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">example.com ansible_ssh_host=10.0.0.10 ensible_ssh_pass=123456 prodction=False</span><br><span class="line"></span><br><span class="line"><span class="section">[registry]</span></span><br><span class="line">registry.example.com ansible_ssh_host=172.16.100.10 ansible_ssh_port=2222 ansible_ssh_pass=123456 prodction=True</span><br><span class="line"></span><br><span class="line"><span class="section">[kubernetes]</span></span><br><span class="line">node1.example.com ansible_ssh_host=172.16.100.11 ansible_ssh_pass=123456 master=True</span><br><span class="line">node2.example.com ansible_ssh_host=172.16.100.12 ansible_ssh_pass=123456 worker=True</span><br><span class="line">node3.example.com ansible_ssh_host=172.16.100.13 ansible_ssh_pass=123456 worker=True</span><br><span class="line"></span><br><span class="line"><span class="section">[kubernetes:vars]</span></span><br><span class="line"><span class="attr">prodction</span>=<span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="section">[develop]</span></span><br><span class="line">dev1.example.com ansible_ssh_host=192.168.0.11 ansible_ssh_pass=123456 role=nginx</span><br><span class="line">dev2.example.com ansible_ssh_host=192.168.0.12 ansible_ssh_pass=123456 role=php</span><br><span class="line">dev3.example.com ansible_ssh_host=192.168.0.13 ansible_ssh_pass=123456 role=mysql</span><br><span class="line"></span><br><span class="line"><span class="section">[develop:vars]</span></span><br><span class="line"><span class="attr">prodction</span>=<span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="section">[operator:children]</span></span><br><span class="line">registry</span><br><span class="line">kubernetes</span><br></pre></td></tr></table></figure>
<ul>
<li>下面是 inventory 的输出：all 表示所有的组，ungrouped 表示所有未分组的主机，_meta 表示了每个主机拥有的变量。</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"all"</span>: &#123;</span><br><span class="line">        <span class="attr">"children"</span>: [<span class="string">"develop"</span>, <span class="string">"operator"</span>, <span class="string">"ungrouped"</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"ungrouped"</span>: &#123;</span><br><span class="line">        <span class="attr">"hosts"</span>: [<span class="string">"example.com"</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"_meta"</span>: &#123;</span><br><span class="line">        <span class="attr">"hostvars"</span>: &#123;</span><br><span class="line">            <span class="attr">"example.com"</span>: &#123;<span class="attr">"ansible_ssh_host"</span>: <span class="string">"10.0.0.10"</span>, <span class="attr">"ensible_ssh_pass"</span>: <span class="number">123456</span>, <span class="attr">"prodction"</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">            <span class="attr">"registry.example.com"</span>: &#123;<span class="attr">"ansible_ssh_host"</span>: <span class="string">"172.16.100.10"</span>, <span class="attr">"ansible_ssh_pass"</span>: <span class="number">123456</span>, <span class="attr">"ansible_ssh_port"</span>: <span class="number">9527</span>, <span class="attr">"prodction"</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">            <span class="attr">"node1.example.com"</span>: &#123;<span class="attr">"ansible_ssh_host"</span>: <span class="string">"172.16.100.11"</span>, <span class="attr">"ansible_ssh_pass"</span>: <span class="number">123456</span>, <span class="attr">"master"</span>: <span class="literal">true</span>, <span class="attr">"prodction"</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">            <span class="attr">"node2.example.com"</span>: &#123;<span class="attr">"ansible_ssh_host"</span>: <span class="string">"172.16.100.12"</span>, <span class="attr">"ansible_ssh_pass"</span>: <span class="number">123456</span>, <span class="attr">"prodction"</span>: <span class="literal">true</span>, <span class="attr">"worker"</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">            <span class="attr">"node3.example.com"</span>: &#123;<span class="attr">"ansible_ssh_host"</span>: <span class="string">"172.16.100.13"</span>, <span class="attr">"ansible_ssh_pass"</span>: <span class="number">123456</span>, <span class="attr">"prodction"</span>: <span class="literal">true</span>, <span class="attr">"worker"</span>: <span class="literal">true</span>&#125;,</span><br><span class="line">            <span class="attr">"dev1.example.com"</span>: &#123;<span class="attr">"ansible_ssh_host"</span>: <span class="string">"192.168.0.11"</span>, <span class="attr">"ansible_ssh_pass"</span>: <span class="number">123456</span>, <span class="attr">"prodction"</span>: <span class="literal">false</span>, <span class="attr">"role"</span>: <span class="string">"nginx"</span>&#125;,</span><br><span class="line">            <span class="attr">"dev2.example.com"</span>: &#123;<span class="attr">"ansible_ssh_host"</span>: <span class="string">"192.168.0.12"</span>, <span class="attr">"ansible_ssh_pass"</span>: <span class="number">123456</span>, <span class="attr">"prodction"</span>: <span class="literal">false</span>, <span class="attr">"role"</span>: <span class="string">"php"</span>&#125;,</span><br><span class="line">            <span class="attr">"dev3.example.com"</span>: &#123;<span class="attr">"ansible_ssh_host"</span>: <span class="string">"192.168.0.13"</span>, <span class="attr">"ansible_ssh_pass"</span>: <span class="number">123456</span>, <span class="attr">"prodction"</span>: <span class="literal">false</span>, <span class="attr">"role"</span>: <span class="string">"mysql"</span>&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"registry"</span>: &#123;</span><br><span class="line">        <span class="attr">"hosts"</span>: [<span class="string">"registry.example.com"</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"kubernetes"</span>: &#123;</span><br><span class="line">        <span class="attr">"hosts"</span>: [<span class="string">"node1.example.com"</span>, <span class="string">"node2.example.com"</span>, <span class="string">"node3.example.com"</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"develop"</span>: &#123;</span><br><span class="line">        <span class="attr">"hosts"</span>: [<span class="string">"dev1.example.com"</span>, <span class="string">"dev2.example.com"</span>, <span class="string">"dev3.example.com"</span>]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"operator"</span>: &#123;</span><br><span class="line">        <span class="attr">"children"</span>: [<span class="string">"kubernetes"</span>, <span class="string">"registry"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>--host db2.example.com</code> 返回示例</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"example_variable"</span>: <span class="string">"value"</span>,</span><br><span class="line">    <span class="attr">"ansible_ssh_user"</span>: <span class="string">"johndoe"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h1><h2 id="SSH连接"><a href="#SSH连接" class="headerlink" title="SSH连接"></a>SSH连接</h2><p>Ansible 是基于 SSH 连接控制节点的，所以 Ansible 的主控机需要能够连接到受控主机，下面采用共享密钥方式集群互信通信（仅测试）。</p>
<ul>
<li>创建密钥</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ssh-keygen -b 1024 -qt rsa -P <span class="string">''</span> -f ~/.ssh/id_rsa</span><br></pre></td></tr></table></figure>
<ul>
<li>将自己的公钥写入自己的 authorized_keys</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat ~/.ssh/id_rsa.pub &gt;&gt;~/.ssh/authorized_keys</span><br><span class="line">chmod 600 ~/.ssh/authorized_keys</span><br></pre></td></tr></table></figure>
<ul>
<li>发送私钥和认证列表到集群每台主机</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> HOST <span class="keyword">in</span> 172.16.100.10&#123;1..4&#125; ;<span class="keyword">do</span></span><br><span class="line">    scp -p ~/.ssh/&#123;id_rsa,authorized_keys&#125; root@<span class="variable">$HOST</span>:~/.ssh</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="创建主机组"><a href="#创建主机组" class="headerlink" title="创建主机组"></a>创建主机组</h2><ul>
<li>编辑默认 inventory 文件 /etc/ansible/hosts，建立一个主机组</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[claster]</span><br><span class="line">172.16.100.101</span><br><span class="line">172.16.100.102</span><br><span class="line">172.16.100.103</span><br><span class="line">172.16.100.104</span><br></pre></td></tr></table></figure>
<h2 id="基本用法-1"><a href="#基本用法-1" class="headerlink" title="基本用法"></a>基本用法</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible &lt;主机或组&gt; -m MODULE_NAME [ -a MODULE_ARGS ]</span><br></pre></td></tr></table></figure>
<ul>
<li>例如：在 web 主机组上调用 command 模块执行 hostname 命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible claster -m <span class="built_in">command</span> -a hostname</span><br></pre></td></tr></table></figure>
<h2 id="可用选项-1"><a href="#可用选项-1" class="headerlink" title="可用选项"></a>可用选项</h2><table>
<thead>
<tr>
<th>选项</th>
<th>别名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>-v</td>
<td>–verbose</td>
<td>详细模式，如果命令执行成功，输出详细的结果(-vv –vvv -vvvv)，V越多，详细信息越多</td>
</tr>
<tr>
<td>-i \<path or script\></path></td>
<td>–inventory=PATH</td>
<td>指定host文件的路径，默认是在/etc/ansible/hosts</td>
</tr>
<tr>
<td>-f num</td>
<td>–forks=NUM</td>
<td>指定fork同步进程的个数，默认是5</td>
</tr>
<tr>
<td>-m NAME</td>
<td>–module-name=NAME</td>
<td>指定使用的module名称，默认是command</td>
</tr>
<tr>
<td>-M DIRECTORY</td>
<td>–module-path=DIRECTORY</td>
<td>指定模块的目录来加载模块，默认/usr/share/ansible</td>
</tr>
<tr>
<td>-a ‘ARGUMENTS’</td>
<td>–args=’ARGUMENTS’</td>
<td>指定模块的参数</td>
</tr>
<tr>
<td>-k</td>
<td>–ask-pass</td>
<td>需要SSH密码连接的，提示连接密码</td>
</tr>
<tr>
<td>-K</td>
<td>–ask-sudo-pass</td>
<td>指定使用sudo获得root权限</td>
</tr>
<tr>
<td>-sudo</td>
<td>–sudo</td>
<td>提示输入sudo密码，与–sudo一起使用</td>
</tr>
<tr>
<td>-u USERNAME</td>
<td>–user=USERNAME</td>
<td>指定移动端的执行用户</td>
</tr>
<tr>
<td>-C</td>
<td>–check</td>
<td>测试此命令执行会改变什么内容，不会真正的去执行</td>
</tr>
</tbody>
</table>
<h2 id="查看帮助"><a href="#查看帮助" class="headerlink" title="查看帮助"></a>查看帮助</h2><ul>
<li>查看全部模块</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ansible-doc</span><br></pre></td></tr></table></figure>
<ul>
<li>查看模块帮助</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ansible-doc &lt;module&gt;</span><br></pre></td></tr></table></figure>
<h1 id="常用模块"><a href="#常用模块" class="headerlink" title="常用模块"></a>常用模块</h1><h2 id="模块表"><a href="#模块表" class="headerlink" title="模块表"></a>模块表</h2><table>
<thead>
<tr>
<th>模块名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ping</strong></td>
<td>检查指定节点机器是否还能连通</td>
</tr>
<tr>
<td><strong>command</strong></td>
<td>执行命令模块，可以不填，是ansible默认的模块，命令中无法使用变量，管道。</td>
</tr>
<tr>
<td><strong>shell</strong></td>
<td>启动一个子shell执行命令，执行的命令中有管道或者变量，就需要使用shell模块。</td>
</tr>
<tr>
<td><strong>script</strong></td>
<td>将本机的shell脚本在被管理主机运行</td>
</tr>
<tr>
<td><strong>copy</strong></td>
<td>将本机复制文件到远程位置</td>
</tr>
<tr>
<td><strong>service</strong></td>
<td>用于控制远程主机的服务</td>
</tr>
<tr>
<td><strong>cron</strong></td>
<td>用于管理定时任务</td>
</tr>
<tr>
<td><strong>file</strong></td>
<td>用于远程主机上的文件操作</td>
</tr>
<tr>
<td><strong>yum</strong></td>
<td>使用yum包管理器来管理软件包</td>
</tr>
<tr>
<td><strong>user、group</strong></td>
<td>user、goup分别请求：useradd、userdel、usermod；groupadd、groupdel、groupmod</td>
</tr>
<tr>
<td><strong>filesystem</strong></td>
<td>在块设备上创建文件系统</td>
</tr>
<tr>
<td><strong>get_url</strong></td>
<td>下载文件</td>
</tr>
<tr>
<td><strong>synchronize</strong></td>
<td>同步文件模块</td>
</tr>
</tbody>
</table>
<h2 id="ping测试连通性"><a href="#ping测试连通性" class="headerlink" title="ping测试连通性"></a>ping测试连通性</h2><ul>
<li>与 ping 命令不同 ping 模块是 ansible 实现的 ping 连通性测试模块</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible claster -m ping</span><br><span class="line"></span><br><span class="line">172.16.100.102 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">172.16.100.101 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">172.16.100.103 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">172.16.100.104 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="command简单命令"><a href="#command简单命令" class="headerlink" title="command简单命令"></a>command简单命令</h2><ul>
<li>command 只能执行简单的命令，它不能识别管道</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible claster -m <span class="built_in">command</span> -a ls</span><br><span class="line"></span><br><span class="line">172.16.100.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line"></span><br><span class="line">172.16.100.104 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line"></span><br><span class="line">172.16.100.103 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line"></span><br><span class="line">172.16.100.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br></pre></td></tr></table></figure>
<h2 id="shell调用bash"><a href="#shell调用bash" class="headerlink" title="shell调用bash"></a>shell调用bash</h2><ul>
<li>shell 模块可以识别带有管道符的命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible claster -m shell -a <span class="string">"ss -tan | grep -o LISTEN | wc -l"</span></span><br><span class="line"></span><br><span class="line">172.16.100.102 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">4</span><br><span class="line"></span><br><span class="line">172.16.100.104 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">4</span><br><span class="line"></span><br><span class="line">172.16.100.101 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">4</span><br><span class="line"></span><br><span class="line">172.16.100.103 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">4</span><br></pre></td></tr></table></figure>
<h2 id="script执行脚本"><a href="#script执行脚本" class="headerlink" title="script执行脚本"></a>script执行脚本</h2><ul>
<li>script 模块能够将主控机上的脚本在远程主机上执行</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible claster -m script -a hostname.sh</span><br><span class="line"></span><br><span class="line">172.16.100.102 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"rc"</span>: 0, </span><br><span class="line">    <span class="string">"stderr"</span>: <span class="string">"Shared connection to 172.16.100.102 closed.\r\n"</span>, </span><br><span class="line">    <span class="string">"stderr_lines"</span>: [</span><br><span class="line">        <span class="string">"Shared connection to 172.16.100.102 closed."</span></span><br><span class="line">    ], </span><br><span class="line">    <span class="string">"stdout"</span>: <span class="string">"node2\r\n"</span>, </span><br><span class="line">    <span class="string">"stdout_lines"</span>: [</span><br><span class="line">        <span class="string">"node2"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">172.16.100.101 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"rc"</span>: 0, </span><br><span class="line">    <span class="string">"stderr"</span>: <span class="string">"Shared connection to 172.16.100.101 closed.\r\n"</span>, </span><br><span class="line">    <span class="string">"stderr_lines"</span>: [</span><br><span class="line">        <span class="string">"Shared connection to 172.16.100.101 closed."</span></span><br><span class="line">    ], </span><br><span class="line">    <span class="string">"stdout"</span>: <span class="string">"node1\r\n"</span>, </span><br><span class="line">    <span class="string">"stdout_lines"</span>: [</span><br><span class="line">        <span class="string">"node1"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<h2 id="copy复制文件"><a href="#copy复制文件" class="headerlink" title="copy复制文件"></a>copy复制文件</h2><ul>
<li>复制主控机上的文件到远程主机</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible claster -m copy -a <span class="string">"src=~/file.txt dest=/tmp owner=nobody group=nobody mode=744"</span></span><br><span class="line"></span><br><span class="line">172.16.100.101 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"d567e36b2c31f03ef470a76137d081709c1afc56"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/file.txt"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: 99, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"nobody"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"568a43614dd5ec9978f61ef9ff96ccd0"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0744"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"nobody"</span>, </span><br><span class="line">    <span class="string">"size"</span>: 206, </span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1550023618.71-108548461989947/source"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: 99</span><br><span class="line">&#125;</span><br><span class="line">172.16.100.104 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"checksum"</span>: <span class="string">"d567e36b2c31f03ef470a76137d081709c1afc56"</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/file.txt"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: 99, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"nobody"</span>, </span><br><span class="line">    <span class="string">"md5sum"</span>: <span class="string">"568a43614dd5ec9978f61ef9ff96ccd0"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0744"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"nobody"</span>, </span><br><span class="line">    <span class="string">"size"</span>: 206, </span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"/root/.ansible/tmp/ansible-tmp-1550023618.75-6769805552233/source"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"file"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: 99</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<ul>
<li>copy模块可用选项</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>src</td>
<td>指定本机的源文件，如果是目录，则递归，如果以“/”结尾则只复制目录下内容</td>
</tr>
<tr>
<td>dest</td>
<td>远程主机的绝对路径，如果src是目录，则目标必须是目录</td>
</tr>
<tr>
<td>owner</td>
<td>文件的所有者</td>
</tr>
<tr>
<td>group</td>
<td>文件的所在组</td>
</tr>
<tr>
<td>mode</td>
<td>文件的权限，可选：八进制模式0755；或u + rwx，或u=r</td>
</tr>
<tr>
<td>backup</td>
<td>备份目标文件，可选：yes，no</td>
</tr>
<tr>
<td>force</td>
<td>是否覆盖远程文件，可选：yes，no</td>
</tr>
</tbody>
</table>
<h2 id="service服务管理"><a href="#service服务管理" class="headerlink" title="service服务管理"></a>service服务管理</h2><ul>
<li>管理受控主机上的服务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible claster -m service -a <span class="string">"name=chronyd state=restarted"</span></span><br><span class="line"></span><br><span class="line">172.16.100.101 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"chronyd"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"started"</span>, </span><br><span class="line">    <span class="string">"status"</span>: &#123;</span><br><span class="line">		....</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">172.16.100.102 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"name"</span>: <span class="string">"chronyd"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"started"</span>, </span><br><span class="line">    <span class="string">"status"</span>: &#123;</span><br><span class="line">		....</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>service模块可用参数</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>服务名称</td>
</tr>
<tr>
<td>state</td>
<td>started, stopped, restarted, reloaded</td>
</tr>
<tr>
<td>enabled</td>
<td>yes，no</td>
</tr>
<tr>
<td>runlevel</td>
<td>运行级别</td>
</tr>
<tr>
<td>pattern</td>
<td>服务没有响应state命令则自定义字符串</td>
</tr>
<tr>
<td>sleep</td>
<td>等待服务重启的响应时间</td>
</tr>
</tbody>
</table>
<h2 id="cron定时任务"><a href="#cron定时任务" class="headerlink" title="cron定时任务"></a>cron定时任务</h2><ul>
<li>添加一个定时任务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible claster -m cron -a <span class="string">"name=chkmd5 minute=00 hour=00 job='/bin/bash /server/scripts/chkmd5_mail.sh &gt;/dev/null 2&gt;&amp;1'"</span></span><br><span class="line"></span><br><span class="line">172.16.100.101 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"envs"</span>: [], </span><br><span class="line">    <span class="string">"jobs"</span>: [</span><br><span class="line">        <span class="string">"chkmd5"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">172.16.100.102 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"envs"</span>: [], </span><br><span class="line">    <span class="string">"jobs"</span>: [</span><br><span class="line">        <span class="string">"chkmd5"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<ul>
<li>删除一个定时任务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible claster -m cron -a <span class="string">"name=chkmd5 state=absent"</span></span><br><span class="line"></span><br><span class="line">172.16.100.103 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"envs"</span>: [], </span><br><span class="line">    <span class="string">"jobs"</span>: []</span><br><span class="line">&#125;</span><br><span class="line">172.16.100.101 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"envs"</span>: [], </span><br><span class="line">    <span class="string">"jobs"</span>: []</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<ul>
<li>cron模块可用选项</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>定时任务的描述，如果没有设置，则无法使用state具体删除。</td>
</tr>
<tr>
<td>minute</td>
<td>分，0-59, <em>, </em>/2</td>
</tr>
<tr>
<td>hour</td>
<td>时，0-23, <em>, </em>/2</td>
</tr>
<tr>
<td>day</td>
<td>日，1-31, <em>, </em>/2</td>
</tr>
<tr>
<td>month</td>
<td>月，1-12, <em>, </em>/2</td>
</tr>
<tr>
<td>weekday</td>
<td>周，0-6 for Sunday-Saturday, *</td>
</tr>
<tr>
<td>job</td>
<td>需要执行的任务，</td>
</tr>
<tr>
<td>backup</td>
<td>修改crontab前是否备份，可选：yes，no</td>
</tr>
<tr>
<td>disabled</td>
<td>注释掉定时任务，可选：yes，no, 必须指定job，才可以注释这个任务</td>
</tr>
<tr>
<td>state</td>
<td>出现和删除，可选：present（出现）, absent（缺席）</td>
</tr>
<tr>
<td>env</td>
<td>设置定时任务的环境变量，可选：yes，no，为yes时候，然后直接声明</td>
</tr>
<tr>
<td>user</td>
<td>具体修改哪个用户的定时任务</td>
</tr>
</tbody>
</table>
<h2 id="file文件属性"><a href="#file文件属性" class="headerlink" title="file文件属性"></a>file文件属性</h2><ul>
<li>创建软连接文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible claster -m file -a <span class="string">"src=/etc/hosts dest=/tmp/hosts state=link force=yes"</span></span><br><span class="line"></span><br><span class="line">172.16.100.102 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/hosts"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: 0, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0777"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"size"</span>: 10, </span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"/etc/hosts"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"link"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">172.16.100.101 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"dest"</span>: <span class="string">"/tmp/hosts"</span>, </span><br><span class="line">    <span class="string">"gid"</span>: 0, </span><br><span class="line">    <span class="string">"group"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"mode"</span>: <span class="string">"0777"</span>, </span><br><span class="line">    <span class="string">"owner"</span>: <span class="string">"root"</span>, </span><br><span class="line">    <span class="string">"size"</span>: 10, </span><br><span class="line">    <span class="string">"src"</span>: <span class="string">"/etc/hosts"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"link"</span>, </span><br><span class="line">    <span class="string">"uid"</span>: 0</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<ul>
<li>删除软连接文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible claster -m file -a <span class="string">"path=/tmp/hosts state=absent"</span></span><br><span class="line"></span><br><span class="line">172.16.100.103 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"path"</span>: <span class="string">"/tmp/hosts"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></span><br><span class="line">&#125;</span><br><span class="line">172.16.100.104 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"path"</span>: <span class="string">"/tmp/hosts"</span>, </span><br><span class="line">    <span class="string">"state"</span>: <span class="string">"absent"</span></span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<ul>
<li>file模块可用选项</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>可选项</th>
</tr>
</thead>
<tbody>
<tr>
<td>path</td>
<td>必选项，定义文件/目录的路径</td>
</tr>
<tr>
<td>state</td>
<td>可选：(file, link, directory, hard, touch, absent)：file文件不存在，不会被创建；directory目录不存在则创建；link创建软链接；hard创建硬链接；touch创建新文件或更新文件目录时间戳；absent删除文件目录取消链接文件</td>
</tr>
<tr>
<td>recurse</td>
<td>递归设置指定的目录文件属性，可选：yes，no</td>
</tr>
<tr>
<td>owner</td>
<td>文件的所有者</td>
</tr>
<tr>
<td>group</td>
<td>文件的所在组</td>
</tr>
<tr>
<td>mode</td>
<td>文件的权限，可选：八进制模式0755；或u + rwx，或u=r</td>
</tr>
<tr>
<td>attributes</td>
<td>文件或目录的属性</td>
</tr>
<tr>
<td>src</td>
<td>链接源</td>
</tr>
<tr>
<td>dest</td>
<td>链接文件</td>
</tr>
<tr>
<td>force</td>
<td>链接源不存在，强制创建软链接；软链接已存在，更新软连接。可选：yes，no</td>
</tr>
</tbody>
</table>
<h2 id="yum软件包管理"><a href="#yum软件包管理" class="headerlink" title="yum软件包管理"></a>yum软件包管理</h2><ul>
<li>安装一个软件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible claster -m yum -a <span class="string">"name=httpd state=latest"</span></span><br><span class="line"></span><br><span class="line">172.16.100.101 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"pkg_mgr"</span>: <span class="string">"yum"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">""</span>, </span><br><span class="line">    <span class="string">"rc"</span>: 0, </span><br><span class="line">    <span class="string">"results"</span>: [</span><br><span class="line">        <span class="string">"......"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">172.16.100.102 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"pkg_mgr"</span>: <span class="string">"yum"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">""</span>, </span><br><span class="line">    <span class="string">"rc"</span>: 0, </span><br><span class="line">    <span class="string">"results"</span>: [</span><br><span class="line">        <span class="string">"......"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">....</span><br></pre></td></tr></table></figure>
<ul>
<li>yum 模块可用选项</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>conf_file</td>
<td>远程主机 yum 使用的配置文件</td>
</tr>
<tr>
<td>list</td>
<td>相当于yum list</td>
</tr>
<tr>
<td>name</td>
<td>软件名称</td>
</tr>
<tr>
<td>state</td>
<td>是否安装，可选(present, installed, latest, absent, removed)对应：现在、安装、最新、缺席、删除。</td>
</tr>
<tr>
<td>update_cache</td>
<td>强制yum检查缓存是否过期，并重新下载，可选：yes、no。只有当状态为“现在”或“最新”时才起作用。</td>
</tr>
</tbody>
</table>
<h2 id="setup主机变量"><a href="#setup主机变量" class="headerlink" title="setup主机变量"></a>setup主机变量</h2><ul>
<li>查看主机变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible 172.16.100.101 -m setup</span><br><span class="line"></span><br><span class="line">172.16.100.101 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"ansible_all_ipv4_addresses"</span>: [</span><br><span class="line">            <span class="string">"172.16.100.101"</span></span><br><span class="line">        ], </span><br><span class="line">        <span class="string">"ansible_all_ipv6_addresses"</span>: [</span><br><span class="line">            <span class="string">"fe80::20c:29ff:fe02:3254"</span></span><br><span class="line">        ], </span><br><span class="line">        <span class="string">"ansible_apparmor"</span>: &#123;</span><br><span class="line">            <span class="string">"status"</span>: <span class="string">"disabled"</span></span><br><span class="line">        &#125;, </span><br><span class="line">        <span class="string">"ansible_architecture"</span>: <span class="string">"x86_64"</span>, </span><br><span class="line">        <span class="string">"ansible_bios_date"</span>: <span class="string">"10/27/2017"</span>, </span><br><span class="line">        <span class="string">"ansible_bios_version"</span>: <span class="string">"VMW71.00V.6997262.B64.1710270607"</span>, </span><br><span class="line">        <span class="string">"ansible_cmdline"</span>: &#123;</span><br><span class="line">            <span class="string">"BOOT_IMAGE"</span>: <span class="string">"/vmlinuz-3.10.0-957.1.3.el7.x86_64"</span>, </span><br><span class="line">            <span class="string">"LANG"</span>: <span class="string">"en_US.UTF-8"</span>, </span><br><span class="line">            <span class="string">"quiet"</span>: <span class="literal">true</span>, </span><br><span class="line">            <span class="string">"rhgb"</span>: <span class="literal">true</span>, </span><br><span class="line">            <span class="string">"ro"</span>: <span class="literal">true</span>, </span><br><span class="line">            <span class="string">"root"</span>: <span class="string">"UUID=0efed175-7598-41f1-807f-48bfa8eaaa6a"</span></span><br><span class="line">        &#125;</span><br><span class="line">        .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>过滤某个变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible 172.16.100.101 -m setup -a filter=ansible_fqdn</span><br><span class="line">172.16.100.101 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"ansible_hostname"</span>: <span class="string">"node1"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="YAML语法"><a href="#YAML语法" class="headerlink" title="YAML语法"></a>YAML语法</h1><p>YAML 语言的设计目标，就是方便人类读写，它实质上是一种通用的数据串行化格式，Ansible 的 Playbooks 使用 YAML 语法进行编排。</p>
<ul>
<li>语法规则</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- 使用缩进表示层级关系，同级元素使用空格对其缩进，不允许使用 Tab 键</span><br><span class="line">- 大小写敏感，使用 # 号表示注释一行</span><br></pre></td></tr></table></figure>
<h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><ul>
<li>YAML 支持的数据结构有三种</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- 字典：键值对的集合</span><br><span class="line">- 数组：一组按次序排列的值</span><br><span class="line">- 纯量：单个的、不可再分的值</span><br></pre></td></tr></table></figure>
<h2 id="对象类型"><a href="#对象类型" class="headerlink" title="对象类型"></a>对象类型</h2><ul>
<li>YAML 对象的键值表示方式</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">obj:</span></span><br><span class="line">    <span class="attr">key1 :</span> <span class="string">value1</span></span><br><span class="line">    <span class="attr">key2 :</span> <span class="string">value2</span></span><br></pre></td></tr></table></figure>
<ul>
<li>转换为 json 对象</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123; obj: &#123; key1: 'value1', key2: 'value2' &#125; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="数组类型"><a href="#数组类型" class="headerlink" title="数组类型"></a>数组类型</h2><ul>
<li>YAML 数组表示方式1</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">value1</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">value2</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">value3</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">value4</span></span><br></pre></td></tr></table></figure>
<ul>
<li>转换为 json 对象</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[ 'value1', 'value2', 'value3', 'value4' ]</span><br></pre></td></tr></table></figure>
<ul>
<li>YAML 数组表示方式2</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value4</span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value5</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value6</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value7</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value8</span></span><br></pre></td></tr></table></figure>
<ul>
<li>转换为 json 对象</li>
</ul>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[ [ 'value1', 'value2', 'value3', 'value4' ], [ 'value5', 'value6', 'value7', 'value8' ] ]</span><br></pre></td></tr></table></figure>
<h2 id="复合类型"><a href="#复合类型" class="headerlink" title="复合类型"></a>复合类型</h2><ul>
<li>YAML对象和数组的复合解构</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">obj:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">value4</span></span><br></pre></td></tr></table></figure>
<ul>
<li>转换为JSON</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123; obj: [ 'value1', 'value2', 'value3', 'value4' ] &#125;</span><br></pre></td></tr></table></figure>
<h2 id="纯量类型"><a href="#纯量类型" class="headerlink" title="纯量类型"></a>纯量类型</h2><ul>
<li>YAML 数值转换为 json 数值</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">number :</span> <span class="number">12.30</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123; number: 12.3 &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>YAML 布尔值转换为 json 布尔值</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">bul :</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123; bul: false &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>YAML NULL 转换为 json NULL</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">parent :</span> <span class="string">~</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123; parent: null &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>YAML 字符串转换为 json 字符串，空格使用单引号</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">strings :</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">'yang jin heng'</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">man</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">30</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123; strings: [ 'yang jin heng', 'man', 30 ] &#125;</span><br></pre></td></tr></table></figure>
<h1 id="Playbook基本"><a href="#Playbook基本" class="headerlink" title="Playbook基本"></a>Playbook基本</h1><p>Playbooks 与 adhoc （命令行）相比，是一种完全不同的运用的方式，它能力很强大，Playbooks 使用 YAML 语法进行编排。</p>
<p>一个 Playbook 就是一或多个 play 组成，一个 play 就是在一些主机中挑选指定的主机和主机组，然后运行任务在这些主机上，定义这些主机的角色和他们会怎么样表演。</p>
<p>而 play 的内容，被称为 tasks，即任务。在基本层次的应用中，一个任务是一个对 ansible 模块的调用，这在前面章节学习过。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><ul>
<li>下面的 playbook 仅包含了一个 play</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.101</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.102</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">sudo:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">package:</span> <span class="string">httpd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">network</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">tasks</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">package</span> <span class="string">&#125;&#125;</span> <span class="string">&#123;&#123;</span> <span class="string">service</span> <span class="string">&#125;&#125;</span> <span class="string">&gt;</span> <span class="string">/tmp/tasks.txt</span></span><br></pre></td></tr></table></figure>
<ul>
<li>ansible-playbook 命令执行 playbook</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ansible-playbook play.yml</span><br><span class="line"></span><br><span class="line">PLAY [172.16.100.101,172.16.100.102] *************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ***************************************************************************************</span><br><span class="line">ok: [172.16.100.101]</span><br><span class="line">ok: [172.16.100.102]</span><br><span class="line"></span><br><span class="line">TASK [show tasks] ********************************************************************************************</span><br><span class="line">changed: [172.16.100.101]</span><br><span class="line">changed: [172.16.100.102]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ***************************************************************************************************</span><br><span class="line">172.16.100.101             : ok=2    changed=1    unreachable=0    failed=0   </span><br><span class="line">172.16.100.102             : ok=2    changed=1    unreachable=0    failed=0</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 playbook 影响的主机有哪些</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook playbook.yml --list-hosts</span><br></pre></td></tr></table></figure>
<h2 id="hosts主机"><a href="#hosts主机" class="headerlink" title="hosts主机"></a>hosts主机</h2><p>可以为 playbook 中的每一个 play 选择操作的目标机器是哪些，以哪个用户身份去完成要执行的步骤（called tasks）</p>
<ul>
<li>hosts 关键字指定主机或者组</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.101</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.102</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">sudo:</span> <span class="literal">yes</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">package:</span> <span class="string">httpd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">service:</span> <span class="string">network</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">show</span> <span class="string">tasks</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">package</span> <span class="string">&#125;&#125;</span> <span class="string">&#123;&#123;</span> <span class="string">service</span> <span class="string">&#125;&#125;</span> <span class="string">&gt;</span> <span class="string">/tmp/tasks.txt</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">hosts</span> <span class="string">：关键字，指定主机、组，可以使用逗号分隔多个，或者使用数组</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">remote_user：关键字，指定以远程主机哪个用户运行任务</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">sudo：是否需要使用</span> <span class="string">sudo</span> <span class="string">执行命令</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">vars</span>  <span class="string">：关键字，来设置变量，可以在</span> <span class="string">tasks</span> <span class="string">中使用</span> <span class="string">&#123;&#123;</span> <span class="string">varname</span> <span class="string">&#125;&#125;</span> <span class="string">来调用定义的变量</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">tasks</span> <span class="string">：表示一个任务，name</span> <span class="string">必须为任务设置一个名字，使用一个对象来表示调用的模块</span> <span class="string">k/v</span> <span class="string">形式，k</span> <span class="string">为模块名称，v</span> <span class="string">为模块参数</span></span><br></pre></td></tr></table></figure>
<h2 id="vars变量"><a href="#vars变量" class="headerlink" title="vars变量"></a>vars变量</h2><ul>
<li>定义变量，有三种方式：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- 通过命令行优先级最高：ansible-playbook -e key=value</span><br><span class="line">- 在 inventory 文件中定义，可以定义主机变量或者组变量</span><br><span class="line">- 在 playbook 中定义：在 play 中用 vars 来定义，vars 的值是一个数组，数组内由字典来表示变量</span><br><span class="line">- 在 role 中定义</span><br></pre></td></tr></table></figure>
<ul>
<li>调用变量</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">在</span> <span class="string">playbook</span> <span class="string">中使用</span> <span class="string">&#123;&#123;</span> <span class="string">varname</span> <span class="string">&#125;&#125;</span> <span class="string">调用变量</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">ansible</span> <span class="string">setup</span> <span class="string">facts</span> <span class="string">内置变量可以直接调用，查看可用变量使用</span> <span class="string">ansible</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.101</span> <span class="string">-m</span> <span class="string">setup</span></span><br></pre></td></tr></table></figure>
<ul>
<li>定义变量文件 vars.yml</li>
</ul>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">key1 :</span> <span class="string">value1</span></span><br><span class="line"><span class="attr">key2 :</span> <span class="string">value2</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用变量文件，调用变量</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">claster</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars.yml</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">write</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">&#123;&#123;</span> <span class="string">key1</span> <span class="string">&#125;&#125;</span> <span class="string">&gt;/tmp/tasks.txt</span></span><br></pre></td></tr></table></figure>
<ul>
<li>变量优先级</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ansible-playbook -e 定义的变量 &gt; playbook 文件中的变量 &gt; setup 清单内的变量</span><br></pre></td></tr></table></figure>
<h2 id="Tasks任务"><a href="#Tasks任务" class="headerlink" title="Tasks任务"></a>Tasks任务</h2><p>每个 play 包含一个 tasks，tasks 这个列表内的 task 是顺序执行的，如果上一个 task 执行失败，那么整个任务将返回，或者使用 ignore_errors 参数忽略一个 task 的错误</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">make</span> <span class="string">sure</span> <span class="string">apache</span> <span class="string">is</span> <span class="string">running</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=running</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果需要忽略上一个 task 的执行返回值</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">/bin/false</span></span><br><span class="line">    <span class="attr">ignore_errors:</span> <span class="literal">True</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">write</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">"ok"</span> <span class="string">&gt;/tmp/task.txt</span></span><br></pre></td></tr></table></figure>
<h2 id="Handlers触发器"><a href="#Handlers触发器" class="headerlink" title="Handlers触发器"></a>Handlers触发器</h2><p>Handlers 是特殊的 task 列表，它们和一般的 task 并没有什么区别。Handlers 是由 notify 来调用执行的，如果没有被 notify，handlers 不会执行。不管有多少个通知者进行了 notify，等到 play 中的所有 task 执行完成之后，handlers 也只会被执行一次。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">template</span> <span class="string">configuration</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=template.j2</span> <span class="string">dest=/etc/foo.conf</span></span><br><span class="line">    <span class="attr">notify:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">memcached</span></span><br><span class="line">    <span class="attr">service:</span>  <span class="string">name=memcached</span> <span class="string">state=restarted</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">apache</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=apache</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<h2 id="tags标签"><a href="#tags标签" class="headerlink" title="tags标签"></a>tags标签</h2><p>Ansible 允许给 playbook 里面的资源通过自定义的关键字打上标签，然后只运行与关键字一致的部分代码，plays 和 tasks 都支持 tags，多个 task 可以公用一个标签，共同被调用。</p>
<ul>
<li>给 task 加标签</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">/bin/false</span></span><br><span class="line">    <span class="attr">ignore_errors:</span> <span class="literal">True</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">check</span> <span class="string">service</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">write</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">shell:</span> <span class="string">echo</span> <span class="string">"ok"</span> <span class="string">&gt;/tmp/task.txt</span></span><br></pre></td></tr></table></figure>
<ul>
<li>单独执行标签的 task</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook play.yml --tags <span class="string">"check service"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>跳过执行某个标签的 task</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook play.yml --skip-tags <span class="string">"notification"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>也可以包含一个标签的 task</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">foo.yml</span> <span class="string">tags=web,foo</span></span><br></pre></td></tr></table></figure>
<h1 id="内置变量"><a href="#内置变量" class="headerlink" title="内置变量"></a>内置变量</h1><p>所有变量都可以在playbook或者jinja2模板中通过 <code></code> 中使用。</p>
<p>ansible 内置了一些变量以方便主机之间相互调用各自的变量，这些变量包括：</p>
<table>
<thead>
<tr>
<th>变量名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>hostvars</td>
<td>允许你访问另一个主机的变量，当然前提是 ansible 已经收集到这个主机的变量了：</td>
</tr>
<tr>
<td>group_names</td>
<td>是当前主机所在的 group 列表</td>
</tr>
<tr>
<td>groups</td>
<td>是所有 inventory 的 group 列表</td>
</tr>
<tr>
<td>inventory_hostname</td>
<td>是在 inventory 里定义的主机名</td>
</tr>
<tr>
<td>play_hosts</td>
<td>是当前的 playbook 范围内的主机列表</td>
</tr>
<tr>
<td>inventory_dir 和 inventory_file</td>
<td>是定义 inventory 的目录和文件</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h2 id="变量的优先级"><a href="#变量的优先级" class="headerlink" title="变量的优先级"></a>变量的优先级</h2><table>
<thead>
<tr>
<th>优先级</th>
<th>变量</th>
</tr>
</thead>
<tbody>
<tr>
<td>命令行 -e 指定</td>
<td>1</td>
</tr>
<tr>
<td>inventory 文件定义的变量，其实 inventory 文件也分全局，group 级别的和 hosts 级别的变量定义</td>
<td>2</td>
</tr>
<tr>
<td>fact 变量</td>
<td>3</td>
</tr>
<tr>
<td>角色的 default 变量</td>
<td>4</td>
</tr>
</tbody>
</table>
<h2 id="命令行传递变量"><a href="#命令行传递变量" class="headerlink" title="命令行传递变量"></a>命令行传递变量</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook release.yml --extra-vars <span class="string">"hosts=vipers user=starbuck"</span></span><br></pre></td></tr></table></figure>
<h2 id="从-JSON-文件读取变量"><a href="#从-JSON-文件读取变量" class="headerlink" title="从 JSON 文件读取变量"></a>从 JSON 文件读取变量</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook main.yml -e <span class="string">"@vars.json"</span></span><br></pre></td></tr></table></figure>
<h2 id="变量来自模板的结果"><a href="#变量来自模板的结果" class="headerlink" title="变量来自模板的结果"></a>变量来自模板的结果</h2><ul>
<li>/etc/ansible/hosts</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[cluster]</span><br><span class="line">172.16.100.11 registry=<span class="literal">true</span></span><br><span class="line">172.16.100.12</span><br><span class="line">172.16.100.13</span><br><span class="line"></span><br><span class="line">[other]</span><br><span class="line">172.16.100.10</span><br></pre></td></tr></table></figure>
<ul>
<li>debug.yaml，从 inventory 的所有主机中找到 registry 为 true 的主机，在使用中 jinja 模板续行不能有空格</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.11</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">servers:</span> <span class="string">"&#123;% set servers = [] %&#125;\</span></span><br><span class="line"><span class="string">                &#123;% for host in groups['all'] %&#125;\</span></span><br><span class="line"><span class="string">                  &#123;% set server = hostvars[host]['registry'] | default(false) %&#125;\</span></span><br><span class="line"><span class="string">                  &#123;% if server == 'true' %&#125;\</span></span><br><span class="line"><span class="string">                    &#123;% if servers.append(host) %&#125;&#123;% endif %&#125;\</span></span><br><span class="line"><span class="string">                  &#123;% endif %&#125;\</span></span><br><span class="line"><span class="string">                &#123;% endfor %&#125;\</span></span><br><span class="line"><span class="string">                <span class="template-variable">&#123;&#123; servers &#125;&#125;</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">"&#123;% for host in groups['all'] %&#125;\</span></span><br><span class="line"><span class="string">                 &#123;% if hostvars[host]['registry'] | default(false) %&#125;\</span></span><br><span class="line"><span class="string">                   <span class="template-variable">&#123;&#123; host &#125;&#125;</span>\</span></span><br><span class="line"><span class="string">                 &#123;% endif %&#125;\</span></span><br><span class="line"><span class="string">               &#123;% endfor %&#125;"</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug1</span></span><br><span class="line">      <span class="attr">debug:</span> <span class="string">var=servers</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">debug2</span></span><br><span class="line">      <span class="attr">debug:</span> <span class="string">var=server</span></span><br></pre></td></tr></table></figure>
<ul>
<li>结果</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">PLAY [172.16.100.11] **************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ************************************************************************************************************</span><br><span class="line">ok: [172.16.100.11]</span><br><span class="line"></span><br><span class="line">TASK [debug1] *********************************************************************************************************************</span><br><span class="line">ok: [172.16.100.11] =&gt; &#123;</span><br><span class="line">    <span class="string">"servers"</span>: [<span class="string">"172.16.100.11"</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [debug2] *********************************************************************************************************************</span><br><span class="line">ok: [172.16.100.11] =&gt; &#123;</span><br><span class="line">    <span class="string">"server"</span>: <span class="string">"172.16.100.11"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP ************************************************************************************************************************</span><br><span class="line">172.16.100.11              : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></table></figure>
<h1 id="template模板"><a href="#template模板" class="headerlink" title="template模板"></a>template模板</h1><p>template 是 ansible 的模板模块，由 python jinja2 提供，这个模块只能在 playbook 中使用。</p>
<p>一般我们在 playbook 当前目录下新建 templates 存放 template 文件，模板文件的扩展名应该为 .j2。</p>
<ul>
<li>jinja2 官方文档</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://jinja.pocoo.org/docs/2.10/</span><br></pre></td></tr></table></figure>
<ul>
<li>在 inventory 为每个主机定义不同的变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[claster]</span><br><span class="line">172.16.100.101 http_port=8080</span><br><span class="line">172.16.100.102 http_port=8081</span><br><span class="line">172.16.100.103</span><br><span class="line">172.16.100.104</span><br></pre></td></tr></table></figure>
<ul>
<li>在 templates 目录内准备模板文件 nginx.conf.j2，在文件内使用 ，来调用变量</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">user</span> nginx;</span><br><span class="line">worker_processes &#123;&#123; ansible_processor_vcpus - 1 &#125;&#125;;</span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/error.log;</span><br><span class="line"><span class="attribute">pid</span> /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="attribute">include</span> /usr/share/nginx/modules/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log  &#123;&#123; log_path &#125;&#125;  main;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>            <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nopush</span>          <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span>         <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>   <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">types_hash_max_size</span> <span class="number">2048</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span>             /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        listen       &#123;&#123; http_port &#125;&#125; default_server;</span><br><span class="line">        <span class="attribute">server_name</span>  _;</span><br><span class="line">        <span class="attribute">root</span>         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">include</span> /etc/nginx/default.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line">            <span class="attribute">location</span> = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line">            <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123; ansible_processor_vcpus - 1 &#125;&#125;   使用了主机的 setup 中的的变量</span><br><span class="line">&#123;&#123; http_port &#125;&#125;                     使用了 inventory 文件中的变量</span><br><span class="line">&#123;&#123; log_path &#125;&#125;                      使用了 playbook 文件中的变量</span><br></pre></td></tr></table></figure>
<ul>
<li>在 playbook 中使用模板</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.101</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.102</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">log_path:</span> <span class="string">/var/log/nginx/&#123;&#123;</span> <span class="string">ansible_hostname</span> <span class="string">&#125;&#125;.log</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">template</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">service</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<h2 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h2><p>template 中支持 for 循环来渲染一个模板文件</p>
<ul>
<li>在 templates 准备一个模板文件 for.conf.j2 ，在其中使用 for 遍历一个数组，jinja2 会把这个数组迭代并渲染</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for i in ports %&#125;</span><br><span class="line">server&#123;</span><br><span class="line">    listen &#123;&#123; i &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 playbook 的 task 中设置一个数组</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">claster</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">81</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">82</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">83</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">for</span> <span class="string">conf</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=for.conf.j2</span> <span class="string">dest=/tmp/for.conf</span></span><br></pre></td></tr></table></figure>
<ul>
<li>结果</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">81</span></span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">82</span></span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">83</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>for 循环中可以访问的特殊变量</li>
</ul>
<table>
<thead>
<tr>
<th>变量</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>loop.index</td>
<td>当前循环迭代的次数（从 1 开始）</td>
</tr>
<tr>
<td>loop.index0</td>
<td>当前循环迭代的次数（从 0 开始）</td>
</tr>
<tr>
<td>loop.revindex</td>
<td>到循环结束需要迭代的次数（从 1 开始）</td>
</tr>
<tr>
<td>loop.revindex0</td>
<td>到循环结束需要迭代的次数（从 0 开始）</td>
</tr>
<tr>
<td>loop.first</td>
<td>如果是第一次迭代，为 True 。</td>
</tr>
<tr>
<td>loop.last</td>
<td>如果是最后一次迭代，为 True 。</td>
</tr>
<tr>
<td>loop.length</td>
<td>序列中的项目数。</td>
</tr>
<tr>
<td>loop.cycle</td>
<td>在一串序列间期取值的辅助函数。见下面的解释。</td>
</tr>
</tbody>
</table>
<h2 id="if条件分支"><a href="#if条件分支" class="headerlink" title="if条件分支"></a>if条件分支</h2><ul>
<li>在 templates 准备一个模板文件 for.conf.j2 ，jinja2 for 会把这个数组迭代并按 if 条件进行渲染</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% for i in ports %&#125;</span><br><span class="line">server&#123;</span><br><span class="line">    listen &#123;&#123; i.port &#125;&#125;</span><br><span class="line">    &#123;% if i.name is defined %&#125;</span><br><span class="line">    servername &#123;&#123; i.name &#125;&#125;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    documentroot &#123;&#123; i.rootdir &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 Playbook 中设置数组数据源，注意 web2 没有配置 name。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">claster</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">web1:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">81</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">web1.yangjinheng.com</span></span><br><span class="line">        <span class="attr">rootdir:</span> <span class="string">/data/website1</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">web2:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">82</span></span><br><span class="line">        <span class="comment">#name: web2.yangjinheng.com</span></span><br><span class="line">        <span class="attr">rootdir:</span> <span class="string">/data/website2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">web2:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">web3.yangjinheng.com</span></span><br><span class="line">        <span class="attr">rootdir:</span> <span class="string">/data/website3</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">for</span> <span class="string">conf</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=for.conf.j2</span> <span class="string">dest=/tmp/for.conf</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行结果</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">81</span></span><br><span class="line">        servername web1.yangjinheng.com</span><br><span class="line">        documentroot /data/website1</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">82</span></span><br><span class="line">        documentroot /data/website2</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">83</span></span><br><span class="line">        servername web3.yangjinheng.com</span><br><span class="line">        documentroot /data/website3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="macro宏"><a href="#macro宏" class="headerlink" title="macro宏"></a>macro宏</h2><p>jinja2 中有类似函数的东西，它叫做宏，利用宏可以方便的重复利用一段内容，并且把这段内容当作一个独立的逻辑单元，与其他语言中的函数一样，jinja2 的宏也可以传入参数。</p>
<ul>
<li>定义宏需要</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% macro func(var1=hello,var2=world) %&#125;    # 使用 &#123;% macro %&#125; 开头</span><br><span class="line">&#123;&#123; var1 &#125;&#125;</span><br><span class="line">&#123;&#123; var2 &#125;&#125;</span><br><span class="line">&#123;% endmacro %&#125;                             # &#123;% endmacro %&#125; 结束</span><br><span class="line"></span><br><span class="line">&#123;&#123; func(nihao,shijie) &#125;&#125;                   # 使用 &#123;&#123; function_name(arg1,arg2) &#125;&#125; 方式调用</span><br></pre></td></tr></table></figure>
<ul>
<li>结果</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nihao</span><br><span class="line">shijie</span><br></pre></td></tr></table></figure>
<ul>
<li>宏内部的特殊变量</li>
</ul>
<table>
<thead>
<tr>
<th>变量</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>varargs</td>
<td>如果有多于宏接受的参数个数的位置参数被传入，它们会作为列表的值保存在varargs 变量上。</td>
</tr>
<tr>
<td>kwargs</td>
<td>同 varargs ，但只针对关键字参数。所有未使用的关键字参数会存储在 这个特殊变量中。</td>
</tr>
<tr>
<td>name</td>
<td>宏的名称。 <code></code> 会打印 <code>input</code> 。</td>
</tr>
<tr>
<td>arguments</td>
<td>一个宏接受的参数名的元组。</td>
</tr>
<tr>
<td>defaults</td>
<td>默认值的元组。</td>
</tr>
<tr>
<td>catch_kwargs</td>
<td>如果宏接受额外的关键字参数（也就是访问特殊的 kwargs 变量），为 true 。</td>
</tr>
<tr>
<td>catch_varargs</td>
<td>如果宏接受额外的位置参数（也就是访问特殊的 varargs 变量），为 true 。</td>
</tr>
<tr>
<td>caller</td>
<td>如果宏访问特殊的 caller 变量且由 call 标签调用，为 true 。</td>
</tr>
</tbody>
</table>
<h2 id="set变量赋值"><a href="#set变量赋值" class="headerlink" title="set变量赋值"></a>set变量赋值</h2><p>在 jinja2 代码块中，你也可以为变量赋值。在顶层的（块、宏、循环之外）赋值是可导出的，即 可以从别的模板中导入。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;% set key1 = value1 %&#125;</span><br><span class="line">&#123;% set navigation = [(&apos;index.html&apos;, &apos;Index&apos;), (&apos;about.html&apos;, &apos;About&apos;)] %&#125;</span><br><span class="line">&#123;% set key, value = call_something() %&#125;</span><br></pre></td></tr></table></figure>
<h2 id="filter过滤器"><a href="#filter过滤器" class="headerlink" title="filter过滤器"></a>filter过滤器</h2><p>变量可以通过过滤器，过滤器根据功能进行修改输出，某些过滤器支持参数，可以使用()向过滤器传递参数。</p>
<ul>
<li>使用 | 分隔变量和过滤器，表示对这个变量进行过滤</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123; name | lower == &apos;jinheng&apos; &#125;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以使用 () 向过滤器传递参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123; list | join(&apos;, &apos;) &#125;&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>字符串和数字内置过滤器</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>upper</td>
<td>将字符串转换为大写</td>
</tr>
<tr>
<td>lower</td>
<td>将字符串转换为小写</td>
</tr>
<tr>
<td>capitalize</td>
<td>将字符串首字母转换为大写</td>
</tr>
<tr>
<td>reverse</td>
<td>将字符串反转</td>
</tr>
<tr>
<td>first</td>
<td>返回字符串的第一个字符</td>
</tr>
<tr>
<td>last</td>
<td>返回字符串的最后一个字符</td>
</tr>
<tr>
<td>trim</td>
<td>将字符串开头和结尾的空格去除</td>
</tr>
<tr>
<td>center(width=number)</td>
<td>指定长度内居中</td>
</tr>
<tr>
<td>length</td>
<td>返回字符串长度</td>
</tr>
<tr>
<td>list</td>
<td>将字符串转换为列表，每个字符为一个列表的一个元素</td>
</tr>
<tr>
<td>shuffle</td>
<td>将字符串转换为列表，每个字符为一个列表的一个元素，并随机打乱顺序</td>
</tr>
<tr>
<td>int(default=6)</td>
<td>转换为整数，如果无法转换则返回指定的值</td>
</tr>
<tr>
<td>float(default=6.6)</td>
<td>转换为浮点数，如果无法转换则返回指定的值</td>
</tr>
<tr>
<td>abs</td>
<td>获取数字的绝对值</td>
</tr>
<tr>
<td>round(number)</td>
<td>四舍五入，取小数点后指定位数</td>
</tr>
<tr>
<td>random(start=number,step=3,seed=(seed))</td>
<td>f返回一个随机数，可以指定开始数字，和步长，seed可以指定种子</td>
</tr>
</tbody>
</table>
<ul>
<li>列表内置过滤器</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>length</td>
<td>返回列表长度</td>
</tr>
<tr>
<td>first</td>
<td>返回列表中的第一个值</td>
</tr>
<tr>
<td>last</td>
<td>返回列表中的最后一个值</td>
</tr>
<tr>
<td>min</td>
<td>返回列表中最小的值</td>
</tr>
<tr>
<td>max</td>
<td>返回列表中最大的值</td>
</tr>
<tr>
<td>sort(reverse=true)</td>
<td>将列表排序输出</td>
</tr>
<tr>
<td>sum</td>
<td>返回纯数字非嵌套列表中所有数字的和</td>
</tr>
<tr>
<td>flatten(levels=number)</td>
<td>如果列表中嵌套了列表，那么指定层的嵌套列表拉平，flatten \</td>
<td>max 返回嵌套列表中的最大值</td>
</tr>
<tr>
<td>join(‘,’)</td>
<td>将列表中的元素合并为一个字符串，使用参数隔开</td>
</tr>
<tr>
<td>random(start=number,step=3,seed=(seed))</td>
<td>随机返回列表中一个元素</td>
</tr>
<tr>
<td>shuffle</td>
<td>随机打乱列表中元素的顺序</td>
</tr>
<tr>
<td>upper</td>
<td>列表的每个元素转换为大写</td>
</tr>
<tr>
<td>lower</td>
<td>列表的每个元素转换为小写</td>
</tr>
<tr>
<td>uniq</td>
<td>对列表进行去重</td>
</tr>
<tr>
<td>unique</td>
<td>两个列表的并集，就是合并两个列表，重复的只留下一个</td>
</tr>
<tr>
<td>intersect(list)</td>
<td>两个列表的交集部分，重复的元素只留下一个</td>
</tr>
<tr>
<td>difference(list)</td>
<td>两个列表的交集在列表1中的 补集</td>
</tr>
<tr>
<td>symmetric_difference(list)</td>
<td>去除两个列表的交集部分，剩余的元素</td>
</tr>
</tbody>
</table>
<ul>
<li>变量未定义时候的过滤器</li>
</ul>
<table>
<thead>
<tr>
<th>名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>default(value)</td>
<td>如果变量没有定义则返回一个默认值</td>
</tr>
</tbody>
</table>
<h2 id="test测试对象"><a href="#test测试对象" class="headerlink" title="test测试对象"></a>test测试对象</h2><table>
<thead>
<tr>
<th>名称</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>undefined(value)</td>
<td>检查对象是否未定义</td>
</tr>
<tr>
<td>none(value)</td>
<td>检查对象是否为空</td>
</tr>
<tr>
<td>defined(value)</td>
<td>检查对象是否定义</td>
</tr>
<tr>
<td>divisibleby(value, num)</td>
<td>测试数值是否可以被 num 整除</td>
</tr>
<tr>
<td>callable(object)</td>
<td>检查对象是否可被调用</td>
</tr>
<tr>
<td>escaped(value)</td>
<td>检查对象是否被转码了</td>
</tr>
<tr>
<td>even(value)</td>
<td>检查对象是否为 even</td>
</tr>
<tr>
<td>iterable(value)</td>
<td>检查对象是否可迭代</td>
</tr>
<tr>
<td>upper(value)</td>
<td>检查字符串是否全部为大写</td>
</tr>
<tr>
<td>lower(value)</td>
<td>检查字符串是否全部为小写</td>
</tr>
<tr>
<td>string(value)</td>
<td>检查是否为字符串</td>
</tr>
<tr>
<td>number(value)</td>
<td>检查是否为数字</td>
</tr>
<tr>
<td>odd(value)</td>
<td>检查是否为奇数</td>
</tr>
<tr>
<td>sameas(value, other)</td>
<td>检查对象h和 other 是否在内存中使用同一个地址</td>
</tr>
<tr>
<td>sequence(value)</td>
<td>检查对象是否为序列</td>
</tr>
</tbody>
</table>
<h2 id="把任务的输出作为变量"><a href="#把任务的输出作为变量" class="headerlink" title="把任务的输出作为变量"></a>把任务的输出作为变量</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">/usr/bin/foo</span></span><br><span class="line">     <span class="attr">register:</span> <span class="string">foo_result</span></span><br><span class="line">     <span class="attr">ignore_errors:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
<h1 id="Playbook进阶"><a href="#Playbook进阶" class="headerlink" title="Playbook进阶"></a>Playbook进阶</h1><h2 id="when-条件"><a href="#when-条件" class="headerlink" title="when 条件"></a>when 条件</h2><ul>
<li>条件测试：如果需要根据条件测试通过才执行某个 task ，那么可以在这个 task 中使用 when 语法来实现。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.101</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.102</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">log_path:</span> <span class="string">/var/log/nginx/&#123;&#123;</span> <span class="string">ansible_hostname</span> <span class="string">&#125;&#125;.log</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">yum:</span> <span class="string">name=nginx</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">template</span> <span class="string">for</span> <span class="string">cents7</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=centos7_nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"7"</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">service</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">template</span> <span class="string">for</span> <span class="string">cents6</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=centos6_nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"6"</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">service</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果变量定义了且为真，则执行某个 task</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">if</span> <span class="string">yum_mirrors</span> <span class="string">is</span> <span class="literal">true</span> <span class="string">be</span> <span class="string">install</span></span><br><span class="line">  <span class="attr">import_tasks:</span> <span class="string">task.yaml</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">yum_mirrors</span> <span class="string">is</span> <span class="string">defined</span> <span class="string">and</span> <span class="string">yum_mirrors</span> <span class="string">==</span> <span class="string">"true"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>判断执行结果</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">cf601</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">no</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">doshell:</span> <span class="string">"yes"</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">shell:</span> <span class="string">"cat /testdir/abc"</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">doshell</span> <span class="string">==</span> <span class="string">"yes"</span></span><br><span class="line">    <span class="attr">register:</span> <span class="string">returnmsg</span></span><br><span class="line">    <span class="attr">ignore_errors:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">"success"</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">returnmsg</span> <span class="string">is</span> <span class="string">success</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">"failed"</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">returnmsg</span> <span class="string">is</span> <span class="string">failure</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">"changed"</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">returnmsg</span> <span class="string">is</span> <span class="string">change</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">"skip"</span></span><br><span class="line">    <span class="attr">when:</span> <span class="string">returnmsg</span> <span class="string">is</span> <span class="string">skip</span></span><br></pre></td></tr></table></figure>
<h2 id="with-items-循环"><a href="#with-items-循环" class="headerlink" title="with_items 循环"></a>with_items 循环</h2><p>迭代，当由需要重复执行的任务时，可以使用 with_items 指定一个列表。</p>
<ul>
<li>在 with_items 中定义一个数组，然后在 task 中使用  迭代这个 with_items。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.101</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.102</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">some</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">file:</span> <span class="string">name=/tmp/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=touch</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">file1.txt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">file2.txt</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">file3.txt</span></span><br></pre></td></tr></table></figure>
<ul>
<li>嵌套迭代</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.101</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.102</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">group3</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">item.group</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user1'</span><span class="string">,group:</span> <span class="string">'group1'</span> <span class="string">&#125;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user2'</span><span class="string">,group:</span> <span class="string">'group2'</span> <span class="string">&#125;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:</span> <span class="string">'user3'</span><span class="string">,group:</span> <span class="string">'group3'</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="with-fileglob-文件通配符循环"><a href="#with-fileglob-文件通配符循环" class="headerlink" title="with_fileglob 文件通配符循环"></a>with_fileglob 文件通配符循环</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># copy each file over that matches the given pattern</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">copy:</span> <span class="string">src=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">dest=/etc/fooapp/</span> <span class="string">owner=root</span> <span class="string">mode=600</span></span><br><span class="line">  <span class="attr">with_fileglob:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/playbooks/files/fooapp/*</span></span><br></pre></td></tr></table></figure>
<h2 id="roles角色"><a href="#roles角色" class="headerlink" title="roles角色"></a>roles角色</h2><p>Ansible 自 1.2 版本引入的新特性，用于层次、结构化的组织 playbook。roles 能够根据层次型结构自动装载：vars、tasks、handler 等文件，要使用 roles 只需要在 playbook 中使用 include 指令即可。</p>
<p>简单来讲：roles 就是通过分别将 vars、file、task、template、handeler 放置于单独目录中，并可以便捷使用 include 指令来包含它们的一种机制。</p>
<p>角色一般用于基于主机构建服务的场景中，但也可以是用于构建守护进程等场景中，复杂场景建议使用 roles 代码复用度高，例如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">- 常需要变更主机、组</span><br><span class="line">- 命名不规范、维护成本太大</span><br><span class="line">- 某些功能需要多个 playbook ，通过 includes 即可实现</span><br></pre></td></tr></table></figure>
<ul>
<li>roles 的文件组织，这些目录的名字是固定的，但不是每个都必须存在，ansible 会检测每个目录，将 main.yaml 文件加入到 play 中</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir defaults files handlers meta tasks templates vars</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── install_nginx.yml              <span class="comment"># playbook 文件和 roles 目录应该处于平级目录</span></span><br><span class="line">└── roles                          <span class="comment"># 存放所有角色的的目录</span></span><br><span class="line">    └── nginx                      <span class="comment"># 一个目录，存放角色的文件，目录名也是角色名称</span></span><br><span class="line">    │   ├── defaults               <span class="comment"># 角色的默认变量</span></span><br><span class="line">    │   │   └── main.yml</span><br><span class="line">    │   ├── files                  <span class="comment"># 包含了了角色在部署时候所需要的数据文件，可以被 copy 模块使用</span></span><br><span class="line">    │   │   ├── index.html</span><br><span class="line">    │   │   └── nginx.tar.gz</span><br><span class="line">    │   ├── handlers               <span class="comment"># 包含触发器任务，此角色甚至在此角色之外的任何地方都可以使用这些处理程序</span></span><br><span class="line">    │   │   └── main.yml</span><br><span class="line">    │   ├── meta                   <span class="comment"># 元数据用于描述角色，比如作者信息，角色主要作用等，还包括角色依赖其他角色名的列表，它将被添加到 roles 列表中</span></span><br><span class="line">    │   │   └── main.yml</span><br><span class="line">    │   ├── tasks                  <span class="comment"># 包含角色要执行的任务列表</span></span><br><span class="line">    │   │   └── main.yml</span><br><span class="line">    │   ├── templates              <span class="comment"># 包含了了角色在部署时候所需要的模板文件，可以被 template 模块调用，并根据变量渲染文件</span></span><br><span class="line">    │   │   └── nginx.conf.j2</span><br><span class="line">    │   └── vars                   <span class="comment"># 角色的其他变量</span></span><br><span class="line">    │       └── main.yml</span><br><span class="line">    └── php                        <span class="comment"># 一个目录，存放角色的文件，目录名也是角色名称</span></span><br><span class="line">        └── ...</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 include 引入其他文件到 main.yml 中</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">user.yml</span></span><br></pre></td></tr></table></figure>
<ul>
<li>跨角色调用别的 role 中的任务，注意被调用的 yml 中必须使用绝对路径</li>
</ul>
<p>在新版本中 ansible2.4 中，include 用 import_playbook 替换：<a href="http://docs.ansible.com/ansible/latest/playbooks_reuse_includes.html" target="_blank" rel="noopener">http://docs.ansible.com/ansible/latest/playbooks_reuse_includes.html</a></p>
<p>include_tasks</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">roles/httpd/tasks/copyfile.yml</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在特定条件下执行某个 role ，例子：当操作系统版本为 7 才执行</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.103</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">when:</span> <span class="string">ansible_distribution_major_versio</span> <span class="string">==</span> <span class="string">"7"</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>为 role 添加 tags</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.103</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">nginx,</span> <span class="attr">tags:</span> <span class="string">['web','nginx']</span> <span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">httpd,</span> <span class="attr">tags:</span> <span class="string">['web','httpd']</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>挑选标签执行 playbook</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook -t nginx install_nginx.yml</span><br></pre></td></tr></table></figure>
<h2 id="roles示例"><a href="#roles示例" class="headerlink" title="roles示例"></a>roles示例</h2><ul>
<li>install_nginx.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">172.16</span><span class="number">.100</span><span class="number">.103</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<ul>
<li>defaults/main.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">software:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<ul>
<li>files/index.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Ansible install Nginx<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Hello, Ansible<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>handlers/main.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=&#123;&#123;</span> <span class="string">software</span> <span class="string">&#125;&#125;</span> <span class="string">state=started</span> <span class="string">enable=yes</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">service</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=&#123;&#123;</span> <span class="string">software</span> <span class="string">&#125;&#125;</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure>
<ul>
<li>tasks/main.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">user</span> <span class="string">&#125;&#125;</span> <span class="string">uid=&#123;&#123;</span> <span class="string">uid</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">software</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">html</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=index.html</span> <span class="string">dest=/usr/share/nginx/html/</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">template:</span> <span class="string">src=nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">service</span></span><br></pre></td></tr></table></figure>
<ul>
<li>templates/nginx.conf.j2</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line">user &#123;&#123; user &#125;&#125;;</span><br><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">error_log</span> /var/log/nginx/error.log;</span><br><span class="line"><span class="attribute">pid</span> /run/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="attribute">include</span> /usr/share/nginx/modules/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">access_log</span>  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>            <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nopush</span>          <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nodelay</span>         <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>   <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">types_hash_max_size</span> <span class="number">2048</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span>             /etc/nginx/mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span> default_server;</span><br><span class="line">        <span class="attribute">listen</span>       [::]:<span class="number">80</span> default_server;</span><br><span class="line">        <span class="attribute">server_name</span>  _;</span><br><span class="line">        <span class="attribute">root</span>         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">include</span> /etc/nginx/default.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">404</span> /<span class="number">404</span>.html;</span><br><span class="line">            <span class="attribute">location</span> = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">error_page</span> <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> /50x.html;</span><br><span class="line">            <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>vars/main.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">user:</span> <span class="string">wenba</span></span><br><span class="line"><span class="attr">uid:</span> <span class="number">9527</span></span><br></pre></td></tr></table></figure>
<h2 id="给角色传递变量"><a href="#给角色传递变量" class="headerlink" title="给角色传递变量"></a>给角色传递变量</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webservers</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">common</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">foo_app_instance,</span> <span class="attr">dir:</span> <span class="string">'/opt/a'</span><span class="string">,</span>  <span class="attr">port:</span> <span class="number">5000</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="include-tasks-和-import-tasks"><a href="#include-tasks-和-import-tasks" class="headerlink" title="include_tasks 和 import_tasks"></a>include_tasks 和 import_tasks</h2><p>include 关键字已经被 deprecated ，建议使用：include_tasks 和 import_tasks。</p>
<p>include_tasks 是动态的: 在运行时展开。when 只应用一次。被 include 的文件名可以使用变量。</p>
<p>import_tasks 是静态的: 在加载时展开。when 在被 import 的文件里的每个 task, 都会重新检查一次。因为是加载时展开的，文件名的变量不能是动态设定的。</p>
<ul>
<li>例子，x.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">set_fact:</span> <span class="string">mode=1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">y.yml</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">mode</span> <span class="string">==</span> <span class="string">"1"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">set_fact:</span> <span class="string">mode=1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">import_tasks:</span> <span class="string">y.yml</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">mode</span> <span class="string">==</span> <span class="string">"1"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>例子，y.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">set_fact:</span> <span class="string">mode="2"</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">&gt;</span></span><br><span class="line">      <span class="string">Display</span> <span class="string">in</span> <span class="string">only</span> <span class="string">`include_tasks`.</span></span><br><span class="line">      <span class="string">`include_tasks`</span> <span class="string">does</span> <span class="string">NOT</span> <span class="string">re-evaluate</span> <span class="string">`mode`</span> <span class="string">for</span> <span class="string">every</span> <span class="string">step.</span></span><br><span class="line">      <span class="string">`import_tasks`</span> <span class="string">DOES</span> <span class="string">re-evaluate</span> <span class="string">condition.</span></span><br></pre></td></tr></table></figure>
<ul>
<li>运行结果</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">TASK [set_fact] *******************************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK [include_tasks] **************************************************</span><br><span class="line">included: /root/devops/ansible/y.yml <span class="keyword">for</span> 127.0.0.1</span><br><span class="line"></span><br><span class="line">TASK [set_fact] *******************************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK [debug] **********************************************************</span><br><span class="line">ok: [127.0.0.1] =&gt; &#123;</span><br><span class="line">    <span class="string">"msg"</span>: <span class="string">"Display in only `include_tasks`.</span></span><br><span class="line"><span class="string">            `include_tasks` does NOT re-evaluate mode for every step.</span></span><br><span class="line"><span class="string">            `import_tasks` DOES re-evaluate condition\n"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [set_fact] *******************************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK [set_fact] *******************************************************</span><br><span class="line">ok: [127.0.0.1]</span><br><span class="line"></span><br><span class="line">TASK [debug] **********************************************************</span><br><span class="line">skipping: [127.0.0.1]</span><br></pre></td></tr></table></figure>
<p>运行 ansible-play -b x.yml 后: debug 的 message 只在 include_tasks 里被执行了.</p>
<p>第 2 个 import_tasks 中的 debug 被 skip 掉了。</p>
<p>因为 mode 被改变之后，include_tasks 不会重新评估 mode，import_tasks 会根据变化后的 mode 值重新评估每个 task 的条件。</p>
<h2 id="import-playbook"><a href="#import-playbook" class="headerlink" title="import_playbook"></a>import_playbook</h2><p>如果您使用任何 import<em> Task（import_playbook，import_tasks等），它将是静态的。如果使用任何 include</em> 任务（include_tasks，include_role等），它将是动态的。</p>
<h2 id="调试复杂的角色"><a href="#调试复杂的角色" class="headerlink" title="调试复杂的角色"></a>调试复杂的角色</h2><ul>
<li>输出执行的任务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook install_nginx.yaml --check --list-tasks --list-hosts</span><br></pre></td></tr></table></figure>
<ul>
<li>分步骤执行</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook install_nginx.yaml --check --step</span><br></pre></td></tr></table></figure>
<ul>
<li>查看究竟修改了哪些</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook install_nginx.yaml --check --diff</span><br></pre></td></tr></table></figure>
<h1 id="Ansible-API"><a href="#Ansible-API" class="headerlink" title="Ansible API"></a>Ansible API</h1><p>从 API 的角度来看，使用 Ansible 有几种方法。</p>
<p>您可以使用 Ansible Python API 来控制节点，可以扩展 Ansible 来响应各种 Python 事件，可以编写插件，还可以从外部数据源插入 inventory 数据。</p>
<p>本文给出了 Ansible Execution 和 Playbook API 的基本概述和示例。</p>
<blockquote>
<p>  因为 Ansible 依赖于 forking 进程，所以这个 API 不是线程安全的。</p>
</blockquote>
<ul>
<li>Ansible API</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> shutil</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> namedtuple</span><br><span class="line"><span class="keyword">from</span> ansible.parsing.dataloader <span class="keyword">import</span> DataLoader</span><br><span class="line"><span class="keyword">from</span> ansible.inventory.manager <span class="keyword">import</span> InventoryManager</span><br><span class="line"><span class="keyword">from</span> ansible.vars.manager <span class="keyword">import</span> VariableManager</span><br><span class="line"><span class="keyword">from</span> ansible.playbook.play <span class="keyword">import</span> Play</span><br><span class="line"><span class="keyword">from</span> ansible.executor.task_queue_manager <span class="keyword">import</span> TaskQueueManager</span><br><span class="line"><span class="keyword">from</span> ansible.plugins.callback <span class="keyword">import</span> CallbackBase</span><br><span class="line"><span class="keyword">import</span> ansible.constants <span class="keyword">as</span> C</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResultCallback</span><span class="params">(CallbackBase)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    一个用于在结果出现时执行操作的回调插件示例；</span></span><br><span class="line"><span class="string">    如果要将所有结果收集到单个对象中以便在执行结束时进行处理；</span></span><br><span class="line"><span class="string">    请查看使用``json``回调插件或编写自己的自定义回调插件。</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">v2_runner_on_ok</span><span class="params">(self, result, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        以 JSON 形式打印结果</span></span><br><span class="line"><span class="string">        此方法可以将结果存储在实例属性中以便稍后检索</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        host = result._host</span><br><span class="line">        print(json.dumps(&#123;host.name: result._result&#125;, indent=<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于 API 是为 CLI 构建的，因此需要始终设置某些选项，命名元组伪造的 args 解析选项对象</span></span><br><span class="line">module_path = <span class="string">'/usr/local/Python-3.7.2/lib/python3.7/site-packages/ansible/modules'</span></span><br><span class="line">Options = namedtuple(<span class="string">'Options'</span>, [<span class="string">'connection'</span>, <span class="string">'module_path'</span>, <span class="string">'forks'</span>, <span class="string">'become'</span>, <span class="string">'become_method'</span>, <span class="string">'become_user'</span>, <span class="string">'check'</span>, <span class="string">'diff'</span>])</span><br><span class="line">options = Options(connection=<span class="string">'ssh'</span>, module_path=[module_path], forks=<span class="number">10</span>, become=<span class="literal">None</span>, become_method=<span class="literal">None</span>, become_user=<span class="literal">None</span>, check=<span class="literal">False</span>, diff=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化所需的对象</span></span><br><span class="line">loader = DataLoader() <span class="comment"># 负责查找和阅读 yaml、json、ini文件</span></span><br><span class="line">passwords = dict(vault_pass=<span class="string">'secret'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实例化 ResultCallback 以便在进入时处理结果，Ansible 希望这是它的主要展示渠道之一</span></span><br><span class="line">results_callback = ResultCallback()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 inventory 使用路径将主机配置文件作为源，或以逗号分隔的字符串中的主机</span></span><br><span class="line">inventory = InventoryManager(loader=loader, sources=<span class="string">'172.16.100.101,172.16.100.102,172.16.100.103,172.16.100.104'</span>)</span><br><span class="line"><span class="comment"># inventory = InventoryManager(loader=loader, sources='/etc/ansible/hosts')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 变量管理器负责合并所有不同的源，为您提供每个上下文中可用变量的统一视图</span></span><br><span class="line">variable_manager = VariableManager(loader=loader, inventory=inventory)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建表示我们的 play 的数据结构，包括任务，这基本上是我们的 YAML 加载器在内部执行的操作</span></span><br><span class="line">play_source =  dict(</span><br><span class="line">        name = <span class="string">"Ansible Play"</span>,</span><br><span class="line">        hosts = <span class="string">'172.16.100.101'</span>,</span><br><span class="line">        gather_facts = <span class="string">'no'</span>,</span><br><span class="line">        tasks = [</span><br><span class="line">            dict(action=dict(module=<span class="string">'shell'</span>, args=<span class="string">'hostname'</span>), register=<span class="string">'shell_out'</span>),</span><br><span class="line">            <span class="comment">#dict(action=dict(module='debug', args=dict(msg='&#123;&#123;shell_out.stdout&#125;&#125;')))</span></span><br><span class="line">         ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建 play 对象, playbook 对象使用 .load 而不是 init 或 new 方法，这也将自动从 play_source 中提供的信息创建任务对象</span></span><br><span class="line">play = Play().load(play_source, variable_manager=variable_manager, loader=loader)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行它 - 实例化任务队列管理器，它负责 forking 和设置所有对象以迭代主机列表和任务</span></span><br><span class="line">tqm = <span class="literal">None</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    tqm = TaskQueueManager(</span><br><span class="line">              inventory=inventory,</span><br><span class="line">              variable_manager=variable_manager,</span><br><span class="line">              loader=loader,</span><br><span class="line">              options=options,</span><br><span class="line">              passwords=passwords,</span><br><span class="line">              stdout_callback=results_callback,  <span class="comment"># 使用我们的自定义回调而不是``default``回调插件，它打印到stdout</span></span><br><span class="line">          )</span><br><span class="line">    result = tqm.run(play) <span class="comment"># 一个 play 的数据实际上是发送到回调的方法</span></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    <span class="comment"># 我们总是需要清理子进程和我们用来与它们通信的结构</span></span><br><span class="line">    <span class="keyword">if</span> tqm <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        tqm.cleanup()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除 ansible 临时目录</span></span><br><span class="line">    shutil.rmtree(C.DEFAULT_LOCAL_TMP, <span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>set_fact</p>
<p>set_fact模块可以自定义facts，这些自定义的facts可以通过template或者变量的方式在playbook中使用。如果你想要获取一个进程使用的内存的百分比，则必须通过set_fact来进行计算之后得出其值，并将其值在playbook中引用。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yangjinheng.github.io/2017/01/20/Linux/MYSQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jin Heng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="默默">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/01/20/Linux/MYSQL/" itemprop="url">My-SQL</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-01-20T00:00:00+08:00">
                2017-01-20
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/运维笔记/" itemprop="url" rel="index">
                    <span itemprop="name">运维笔记</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="MySQL简介"><a href="#MySQL简介" class="headerlink" title="MySQL简介"></a>MySQL简介</h1><p>RDBMS，关系数据库管理系统，是管理关系数据库的数据库管理系统。关系数据库是将数据间的关系以数据库表的形式加以表达，并将数据存储在表格中，以便于查询。</p>
<p>MySQL 是一种开放源代码的关系型数据库管理系统，因为是开放源代码的，在下载后可以根据自己的需要进行修改。由于其体积小、速度快、总体拥有成本低，尤其是开放源码这一特点，许多中小型网站为了降低网站总体拥有成本而选择了MySQL作为网站数据库。</p>
<h2 id="主要特性"><a href="#主要特性" class="headerlink" title="主要特性"></a>主要特性</h2><ul>
<li>内部构件和可移植性</li>
<li>使用C和C++编写 </li>
<li>用众多不同的编译器进行了测试 </li>
<li>能够工作在众多不同的平台上。</li>
<li>使用GNU Automake、Autoconf和Libtool进行移植。</li>
<li>提供了用于C、C++、Eiffel、Java、Perl、PHP、Python、Ruby和Tcl的API。</li>
<li>采用核心线程的完全多线程 如果有多个CPU，它能方便地使用这些CPU。</li>
<li>提供了事务性和非事务性存储引擎。</li>
<li>使用了极快的“B树”磁盘表（MyISAM）和索引压缩。</li>
<li>添加另一个存储引擎相对简单。如果打算为内部数据库添加一个SQL接口，该特性十分有用。</li>
<li>极快的基于线程的内存分配系统。</li>
<li>通过使用优化的“单扫描多连接”，能实现极快的连接。</li>
<li>存储器中的哈希表用作临时表。</li>
<li>SQL函数是使用高度优化的类库实现的，运行很快。通常，在完成查询初始化后，不存在存储器分配。</li>
<li>采用Purify（商业内存溢出检测器）以及GPL工具 Valgrind 测试了MySQL代码。</li>
</ul>
<h1 id="程序文件"><a href="#程序文件" class="headerlink" title="程序文件"></a>程序文件</h1><p>W3schol：<a href="http://www.w3school.com.cn/sql/" target="_blank" rel="noopener">http://www.w3school.com.cn/sql/</a></p>
<h2 id="程序文件-1"><a href="#程序文件-1" class="headerlink" title="程序文件"></a>程序文件</h2><table>
<thead>
<tr>
<th>文件</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>mysql</code></td>
<td>是一个命令行客户程序，用于交互式或以批处理模式执行SQL语句</td>
</tr>
<tr>
<td><code>mysqld</code></td>
<td>MySQL服务器端程序</td>
</tr>
<tr>
<td><code>mysqld_safe</code></td>
<td>MySQL线程安全的服务器端程序，脚本</td>
</tr>
<tr>
<td><code>mysqld_multi</code></td>
<td>MySQL多实例的服务器端程序，脚本</td>
</tr>
<tr>
<td><code>mysqladmin</code></td>
<td>是用于管理功能的客户程序</td>
</tr>
<tr>
<td><code>mysqlbinlog</code></td>
<td>MySQL二进制日志管理员工具</td>
</tr>
<tr>
<td><code>mysqldump</code> and <code>mysqlhotcopy</code></td>
<td>负责数据库备份</td>
</tr>
<tr>
<td><code>mysqlimport</code></td>
<td>导入数据文件</td>
</tr>
<tr>
<td><code>mysqlcheck</code></td>
<td>执行表维护操作</td>
</tr>
<tr>
<td><code>mysqlshow</code></td>
<td>显示信息数据库和表的相关信息</td>
</tr>
<tr>
<td><code>mysql_install_db</code></td>
<td>初始化数据目录和初始数据库</td>
</tr>
</tbody>
</table>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><ul>
<li>配置文件的加载顺序,从上而下的加载，在后面的文件会覆盖前面的配置。</li>
</ul>
<table>
<thead>
<tr>
<th>文件名</th>
<th>目的</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/etc/my.cnf</code></td>
<td>全局选项</td>
</tr>
<tr>
<td><code>/etc/mysql/my.cnf</code></td>
<td>全局选项</td>
</tr>
<tr>
<td><code>SYSCONFDIR/my.cnf</code></td>
<td>全局选项</td>
</tr>
<tr>
<td><code>$MYSQL_HOME/my.cnf</code></td>
<td>服务器特定选项（仅限服务器）</td>
</tr>
<tr>
<td><code>defaults-extra-file</code></td>
<td>指定的文件 <code>--defaults-extra-file</code>，如果有的话</td>
</tr>
<tr>
<td><code>~/.my.cnf</code></td>
<td>用户特定选项</td>
</tr>
<tr>
<td><code>~/.mylogin.cnf</code></td>
<td>用户特定的登录路径选项（仅限客户端）</td>
</tr>
</tbody>
</table>
<ul>
<li>查看 mysql 将会使用的配置文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql --<span class="built_in">help</span> | grep <span class="string">'my.cnf'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>配置的分段</li>
</ul>
<p>语法：<code>Parameter = Value</code> ，选项名<code>_、-</code> 是等效的，值可以是<code>ON、TRUE、1</code>|<code>OFF、FALSE、0</code> 它们是等效的</p>
<table>
<thead>
<tr>
<th>文件部分</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>[mysqld]</code></td>
<td>MySQL服务器配置</td>
</tr>
<tr>
<td><code>[mysqld_safe]</code></td>
<td>MySQL线程安全的服务器配置</td>
</tr>
<tr>
<td><code>[mysqld_multi]</code></td>
<td>MySQL多实例的服务器配置</td>
</tr>
<tr>
<td><code>[mysqldump]</code></td>
<td>数据库备份的默认设置</td>
</tr>
<tr>
<td><code>[mysql]</code></td>
<td>使用 <code>mysql</code> 命令登陆时的默认设置</td>
</tr>
<tr>
<td><code>[client]</code></td>
<td>客户端默认设置内容</td>
</tr>
</tbody>
</table>
<h2 id="字符集配置"><a href="#字符集配置" class="headerlink" title="字符集配置"></a>字符集配置</h2><ul>
<li>最佳配置</li>
</ul>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[client]</span> </span><br><span class="line"><span class="attr">default-character-set</span> = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span> </span><br><span class="line"><span class="attr">default-character-set</span> = utf8mb4</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">character-set-server</span> = utf8mb4</span><br><span class="line"><span class="attr">collation-server</span> = utf8mb4_unicode_ci</span><br><span class="line"><span class="attr">init_connect</span>=<span class="string">'SET NAMES utf8mb4'</span></span><br><span class="line"><span class="attr">skip-character-set-client-handshake</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p><code>character-set-server、collation-server</code> 将MySQL数据库相关的字符集都设置为 <code>utf8mb4</code>。</p>
<p><code>init_connect=&#39;SET NAMES utf8mb4&#39;</code> 表示客户端初始化连接都设置为 utf8mb4 字符集。</p>
<p><code>skip-character-set-client-handshake = true</code> 忽略客户端字符集设置，不论客户端是何种字符集，都按照 init_connect中的设置进行使用。</p>
<ul>
<li>查看数据库生效的字符集</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from information_schema.character_sets;</span><br><span class="line">show variables like &apos;%char%&apos;;</span><br></pre></td></tr></table></figure>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">语法：mysql [OPTIONS][database]</span><br><span class="line">    -A, --no-auto-rehash    # 禁止补全</span><br><span class="line">    -u, --user=             # 用户名,默认为root</span><br><span class="line">    -h, --host=             # 服务器主机,默认为localhost</span><br><span class="line">    -p, --passowrd= 	    # 用户密码,建议使用-p,默认为空密码</span><br><span class="line">    -P, --port= 	 	    # 服务器端口</span><br><span class="line">    -S, --socket=  	        # 指定连接socket文件路径</span><br><span class="line">    -D, --database=  	    # 指定默认数据库</span><br><span class="line">    -C, --compress 	        # 启用压缩</span><br><span class="line">    -e   &quot;SQL&quot;  	        # 执行SQL命令</span><br><span class="line">    -V, --version  	        # 显示版本</span><br><span class="line">    -v  --verbose  	        # 显示详细信息</span><br><span class="line">    --print-defaults   	    # 获取程序默认使用的配置</span><br></pre></td></tr></table></figure>
<ul>
<li>监听地址</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1.默认监听在 TCP/3306 端口</span><br><span class="line">2.在本机通信默认会使用 Unix-Sock 文件，默认在：/var/lib/mysql/mysql.sock</span><br></pre></td></tr></table></figure>
<ul>
<li>查看配置文件配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql --print-defaults        # 查看客户端配置</span><br><span class="line">mysqld --print-defaults       # 查看服务端配置</span><br><span class="line">mysqld --help --verbose       # 服务器端配置详细列表</span><br></pre></td></tr></table></figure>
<ul>
<li>查看运行中的配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW GLOBAL VARIABLES;        # 显示运行中服务器使用的各全局参数及其值</span><br><span class="line">SHOW SESSION VARIABLES;       # 显示当前会话使用的配置</span><br></pre></td></tr></table></figure>
<ul>
<li>修改运行中的全局配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET GLOBAL system_var_name=value;       # 修改运行中的全局配置</span><br><span class="line">SET [SESSION] system_var_name=value;    # 修改运行中的会话配置</span><br></pre></td></tr></table></figure>
<ul>
<li>执行SQL语句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql -e &quot;SHOW DATABASES&quot;                # 执行简单的SQL语句</span><br><span class="line">mysql -uUSERNAME pPASSWD &lt;FILE.sql       # 执行SQL脚本</span><br></pre></td></tr></table></figure>
<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="组成部分"><a href="#组成部分" class="headerlink" title="组成部分"></a>组成部分</h2><table>
<thead>
<tr>
<th>名词</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>表（table）</td>
<td>表是相关的数据项的集合，它由列和行组成。</td>
</tr>
<tr>
<td>行（row）</td>
<td>表中的每一行，又被称作一条记录，一个表可以没有记录</td>
</tr>
<tr>
<td>列（column）</td>
<td>表中的每一列，又被称作一个字段，一个表至少需要一个字段</td>
</tr>
<tr>
<td>索引（index）</td>
<td>可以加快目标数据检索的速度，可以是一个字段或几个字段的组合</td>
</tr>
<tr>
<td>视图（view）</td>
<td>视图是一个虚表，是SELECT查询数据库的结果</td>
</tr>
<tr>
<td>存储过程（procedure）</td>
<td>无返回值的函数</td>
</tr>
<tr>
<td>存储函数（function）</td>
<td>有返回值的函数</td>
</tr>
<tr>
<td>触发器（trigger）</td>
<td>监控一个事件的发生，后触发一些SQL语句</td>
</tr>
<tr>
<td>事件（event）</td>
<td>计划任务，执行重复性的工作</td>
</tr>
</tbody>
</table>
<h2 id="设计范式"><a href="#设计范式" class="headerlink" title="设计范式"></a>设计范式</h2><h3 id="第一范式"><a href="#第一范式" class="headerlink" title="第一范式"></a>第一范式</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第一范式是最基本的范式。如果数据库表中的所有字段值都是不可分解的原子值，就说明该数据库表满足了第一范式。</span><br><span class="line"></span><br><span class="line">第一范式的合理遵循需要根据系统的实际需求来定。比如某些数据库系统中需要用到“地址”这个属性，本来直接将“地址”属性设计成一个数据库表的字段就行。但是如果系统经常会访问“地址”属性中的“城市”部分，那么就非要将“地址”这个属性重新拆分为省份、城市、详细地址等多个部分进行存储，这样在对地址中某一部分操作的时候将非常方便。这样设计才算满足了数据库的第一范式，如下表所示。</span><br></pre></td></tr></table></figure>
<ul>
<li>用户信息表</li>
</ul>
<table>
<thead>
<tr>
<th>编号</th>
<th>姓名</th>
<th>性别</th>
<th>年龄</th>
<th>电话</th>
<th>省份</th>
<th>城市</th>
<th>地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>王大锤</td>
<td>男</td>
<td>30</td>
<td>13300001111</td>
<td>河北</td>
<td>石家庄</td>
<td>朝阳区新华路22号</td>
</tr>
<tr>
<td>2</td>
<td>李小花</td>
<td>女</td>
<td>23</td>
<td>13800002222</td>
<td>山东</td>
<td>淄博</td>
<td>白云区天明路3号</td>
</tr>
<tr>
<td>3</td>
<td>王二狗</td>
<td>男</td>
<td>19</td>
<td>13111114444</td>
<td>陕西</td>
<td>渭南</td>
<td>二七区大学路19号</td>
</tr>
</tbody>
</table>
<h3 id="第二范式"><a href="#第二范式" class="headerlink" title="第二范式"></a>第二范式</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第二范式在第一范式的基础之上更进一层，需要确保数据库表中的每一列都和主键相关，而不能有任何一列与主键没有关系，也不能只与主键的某一部分相关（主要针对联合主键而言），也就是说在一个数据库表中，一个表只描述一件事情，不可以把多种数据保存在同一张数据库表中。</span><br><span class="line"></span><br><span class="line">比如要设计一个订单信息表，因为订单中可能会有多种商品，所以要将订单编号和商品编号作为数据库表的联合主键，如下表所示。</span><br></pre></td></tr></table></figure>
<ul>
<li>订单信息表</li>
</ul>
<table>
<thead>
<tr>
<th>订单号</th>
<th>商品号</th>
<th>商品名</th>
<th>数量</th>
<th>单位</th>
<th>价格</th>
<th>客户</th>
<th>所属单位</th>
<th>联系方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>001</td>
<td>1</td>
<td>挖掘机</td>
<td>1</td>
<td>台</td>
<td>50000￥</td>
<td>王肥猪</td>
<td>中铁建工</td>
<td>13300001234</td>
</tr>
<tr>
<td>001</td>
<td>2</td>
<td>铲车</td>
<td>8</td>
<td>台</td>
<td>60000￥</td>
<td>王肥猪</td>
<td>中铁建工</td>
<td>13300001234</td>
</tr>
<tr>
<td>002</td>
<td>3</td>
<td>吊车</td>
<td>2</td>
<td>台</td>
<td>70000￥</td>
<td>刘瘦子</td>
<td>闲杂人等</td>
<td>13623093306</td>
</tr>
</tbody>
</table>
<p>这样就产生一个问题：这个表中是以订单编号和商品编号作为联合主键。这样在该表中商品名称、单位、商品价格等信息不与该表的主键相关，而仅仅是与商品编号相关。所以在这里违反了第二范式的设计原则。</p>
<p>而如果把这个订单信息表进行拆分，把商品信息分离到另一个表中，把订单项目表也分离到另一个表中，就非常完美了。如下所示。</p>
<ul>
<li>订单信息表</li>
</ul>
<table>
<thead>
<tr>
<th>订单号</th>
<th>客户</th>
<th>所属单位</th>
<th>联系方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>001</td>
<td>王肥猪</td>
<td>中铁建工</td>
<td>13300001234</td>
</tr>
<tr>
<td>002</td>
<td>刘瘦子</td>
<td>闲杂人等</td>
<td>13623093306</td>
</tr>
</tbody>
</table>
<ul>
<li>订单项目表</li>
</ul>
<table>
<thead>
<tr>
<th>订单号</th>
<th>商品号</th>
<th>数量</th>
</tr>
</thead>
<tbody>
<tr>
<td>001</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>001</td>
<td>2</td>
<td>8</td>
</tr>
<tr>
<td>002</td>
<td>3</td>
<td>2</td>
</tr>
</tbody>
</table>
<ul>
<li>商品信息表</li>
</ul>
<table>
<thead>
<tr>
<th>商品号</th>
<th>商品名</th>
<th>单位</th>
<th>价格</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>挖掘机</td>
<td>台</td>
<td>50000￥</td>
</tr>
<tr>
<td>2</td>
<td>铲车</td>
<td>台</td>
<td>60000￥</td>
</tr>
<tr>
<td>3</td>
<td>吊车</td>
<td>台</td>
<td>70000￥</td>
</tr>
</tbody>
</table>
<p>这样设计，在很大程度上减小了数据库的冗余。如果要获取订单的商品信息，使用商品编号到商品信息表中查询即可。 </p>
<h3 id="第三范式"><a href="#第三范式" class="headerlink" title="第三范式"></a>第三范式</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">第三范式需要确保数据表中的每一列数据都和主键直接相关，而不能间接相关。</span><br><span class="line"></span><br><span class="line">比如在设计一个订单数据表的时候，可以将客户编号作为一个外键和订单表建立相应的关系。而不可以在订单表中添加关于客户其它信息（比如姓名、所属公司等）的字段。如下面这两个表所示的设计就是一个满足第三范式的数据库表。</span><br></pre></td></tr></table></figure>
<ul>
<li>订单信息表</li>
</ul>
<table>
<thead>
<tr>
<th>订单编号</th>
<th>订单项目</th>
<th>负责人</th>
<th>业务员</th>
<th>订单数量</th>
<th>客户编号</th>
</tr>
</thead>
<tbody>
<tr>
<td>001</td>
<td>挖掘机</td>
<td>张三</td>
<td>铁柱</td>
<td>1台</td>
<td>1</td>
</tr>
<tr>
<td>002</td>
<td>铲车</td>
<td>李四</td>
<td>二狗</td>
<td>2台</td>
<td>2</td>
</tr>
<tr>
<td>003</td>
<td>吊车</td>
<td>王五</td>
<td>三炮</td>
<td>8台</td>
<td>1</td>
</tr>
</tbody>
</table>
<ul>
<li>客户信息表</li>
</ul>
<table>
<thead>
<tr>
<th>客户编号</th>
<th>客户名称</th>
<th>所属公司</th>
<th>联系方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>王肥猪</td>
<td>中铁建工</td>
<td>13300001234</td>
</tr>
<tr>
<td>2</td>
<td>李大胖</td>
<td>个体经营</td>
<td>13835350041</td>
</tr>
</tbody>
</table>
<p>这样在查询订单信息的时候，就可以使用客户编号来引用客户信息表中的记录，也不必在订单信息表中多次输入客户信息的内容，减小了数据冗余。 </p>
<h2 id="事物ACID"><a href="#事物ACID" class="headerlink" title="事物ACID"></a>事物ACID</h2><p>ACID模型是一组强调高可靠性的数据库系统设计原则。InnoDB存储引擎坚持ACID原则，确保即使在软件崩溃甚至是硬件故障的情况下，数据也不会损坏。当你需要依赖兼容ACID原则的业务时，你不必重复造轮子去实现一致性检查和崩溃恢复机制。在一些情况下，如果你有额外的安全保证机制，可靠的硬件条件，或者应用能够容忍少量的数据丢失和不一致，你可以调整MYSQL设置，牺牲掉ACID的一些可靠性换取更高的性能和数据吞吐量。 </p>
<ul>
<li>Atomicity(原子性）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">原子性意味着每个事务都必须被认为是一个不可分割的单元，假设一个事务由两个或者多个任务组成，其中的语句必须同时成功才能认为事务是成功的。如果事务失败，系统将会返回到事务以前的状态。</span><br><span class="line"></span><br><span class="line">原子的执行是一种非此即彼的命题，它的结果只有全部发生和什么也没有发生这两种状态。在一个原子操作中，如果事务的任何一个语句失败，前面语句的执行结果全都将被回滚，以保证数据的整体性没有受到影响，这一点非常重要，在现实世界中金融系统执行数据输入或者更新，必须保证不出现丢失和数据错误，以保证数据安全。</span><br><span class="line"></span><br><span class="line">原子性主要涉及到InnoDB事务。相关的MYSQL特征包括：Autocommit、COMMIT语句、ROLLBACK语句</span><br></pre></td></tr></table></figure>
<ul>
<li>Consistency(一致性)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">在MySQL中，一致性主要由MySQL的日志机制处理，它记录了数据库的所有变化，为事务回复提供了跟踪记录，如果系统在十五处理中间发生错误，MySQL恢复过程将使用这些日志来发现事务是否已经完全成功执行，是否需要返回。因而一致性属性保证了数据库从不返回一个未处理完的事务。</span><br><span class="line"></span><br><span class="line">保障一致性的手段是：</span><br><span class="line"></span><br><span class="line">1. InnoDB双写缓冲</span><br><span class="line">2. InnoDB崩溃恢复</span><br></pre></td></tr></table></figure>
<ul>
<li>Isolation(隔离性)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">隔离性是指每个事务在它自己的空间发生，和其他发生在系统中的事务隔离，而且事务的结果只有在它完全被执行时才能看到。即使在这样的一个系统中同时发生了多个事务，隔离性原则保证某个特定的事务在完成之前，其结果是看不见的。例如：金融行业的一次股票交易，隔离性是指两个交易者之间的事务和交易中的其他事务是不能互相影响的，而且它的结果只有在完成十才能显示给公众。</span><br><span class="line"></span><br><span class="line">当系统支持同时多个用户连接时候，这就尤为重要，如果系统不遵循这个基本原则，就可能导致大量数据的破坏，比如每个事务的各自空间的完整性很快被其他冲突事务所侵犯。</span><br><span class="line"></span><br><span class="line">大多数事务系统使用页级锁定或者行级锁定来孤立不同事务之间的变化，这将会降低性能为代价的，innodb使用了行级锁定，来保证事务的隔离性。</span><br><span class="line"></span><br><span class="line">隔离性主要涉及到InnoDB具体事务的隔离级别。相关的MYSQL特征包括：</span><br><span class="line"></span><br><span class="line">Autocommit SET ISOLATION LEVEL语句 InnoDB锁的低层细节。在性能调优时，你可以通过INFORMATION_SCHEMA表看到这些细节</span><br></pre></td></tr></table></figure>
<ul>
<li>Durability(持久性)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">持久性是指即使系统崩溃，一个提交的事务仍然在坚持。当一个事务完成，数据库的日志已经被更新时，持久性就开始发生作用。大多数的RDBMS产品通过保存所有行为的日志来保证数据的持久性，这些行为是指在数据库中以任何方法更改数据。数据库日志记录了所有对标的更新、查询、报表等。</span><br><span class="line"></span><br><span class="line">如果系统崩溃或者存储介质被破坏，通过使用日志，系统能够恢复在重启前的最后一次成功的更新，反应了在崩溃时处于执行过程的事务的变化。在金融行业股票交易这种场景，持久性意味着一旦股份从交易者A成功的转移给交易者B，即使系统不断的崩溃，也能反应那时的状态。</span><br><span class="line"></span><br><span class="line">MySQL通过保存一条记录事务过程中系统变化的二进制事务日志文件来实现持久性。如果遇到硬件破坏或者突然的系统关机，在系统重启时，通过使用最后的备份和日志就可以很容易的恢复丢失的数据。</span><br><span class="line"></span><br><span class="line">默认情况下，Innodb表示100%持久的(也就是说，所有在崩溃前系统所进程的事务在恢复过程中都可以可靠的恢复)。MyISAM表提供部分持久性，所有在最后一个FLUSH TABLES命令前的变化都能保证被存盘。</span><br><span class="line"></span><br><span class="line">持久性主要涉及MySQL软件特征与你实际硬件配置的相互作用。这个特性更多的取决于你的CPU，网络，和存储设备的能力。相关的MYSQL特征包括：</span><br><span class="line"></span><br><span class="line">innodb_doublewrite</span><br><span class="line">innodb_flush_log_at_trx_commit</span><br><span class="line">sync_binlog</span><br><span class="line">innodb_file_per_table</span><br><span class="line">磁盘驱动</span><br><span class="line">操作系统是否支持fsync()系统调用</span><br><span class="line">备份策略</span><br><span class="line">分布式</span><br></pre></td></tr></table></figure>
<h2 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h2><p>MySQL有四种隔离级别，它们别决定了其他事务能看到的正在进行的事务的程度，同时以分层顺序安排，最严格最安全，然后逐渐向下到最低安全级别（最容易出问题）的，MySQL默认是“可重复读”(REPEATABLE READ)。</p>
<p>隔离级别从高到低分别是：</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody>
<tr>
<td>SERIALIZABLE（序列化）</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>REPEATABLE READ（可重复读）</td>
<td></td>
<td></td>
<td>⚪</td>
</tr>
<tr>
<td>READ COMMITTED（读已提交）</td>
<td></td>
<td>⚪</td>
<td>⚪</td>
</tr>
<tr>
<td>READ UNCOMMITTED（读未提交）</td>
<td>⚪</td>
<td>⚪</td>
<td>⚪</td>
</tr>
</tbody>
</table>
<h3 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h3><ul>
<li>SERIALIZABLE（序列化）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">它通过强制事务排序，使之不可能相互冲突，从而解决幻读问题。简言之,它是在每个读的数据行上加上共享锁。</span><br><span class="line"></span><br><span class="line">这当然是最理想的隔离级别，不过，它是要付出代价的，如果每个事务都以这种隔离级别运行，就会影响MySQL的性能。</span><br></pre></td></tr></table></figure>
<ul>
<li>示例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#首先修改隔离界别</span><br><span class="line">set tx_isolation=&apos;serializable&apos;;</span><br><span class="line">select @@tx_isolation;</span><br><span class="line">+----------------+</span><br><span class="line">| @@tx_isolation |</span><br><span class="line">+----------------+</span><br><span class="line">| SERIALIZABLE   |</span><br><span class="line">+----------------+</span><br><span class="line"></span><br><span class="line">#事务A：开启一个新事务</span><br><span class="line">start transaction;</span><br><span class="line"></span><br><span class="line">#事务B：在A没有commit之前，这个交叉事务是不能更改数据的</span><br><span class="line">start transaction;</span><br><span class="line">insert tx values(&apos;4&apos;,&apos;4&apos;);</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br><span class="line">update tx set num=10 where id=1;</span><br><span class="line">ERROR 1205 (HY000): Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>
<h3 id="可重复读"><a href="#可重复读" class="headerlink" title="可重复读"></a>可重复读</h3><ul>
<li>REPEATABLE READ（可重复读）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">一个事务不能看到其他事务对行的修改，但可以看到新增的行。</span><br><span class="line"></span><br><span class="line">读到其他事务新增的行，被称作 “幻读” ，如果事务对这个新行执行计算或者总和函数，就会导致意料之外、不一致的结果，当然安全上的妥协换来的是性能的提升。</span><br></pre></td></tr></table></figure>
<ul>
<li>示例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#首先，更改隔离级别</span><br><span class="line">set tx_isolation=&apos;repeatable-read&apos;;</span><br><span class="line">select @@tx_isolation;</span><br><span class="line">+-----------------+</span><br><span class="line">| @@tx_isolation  |</span><br><span class="line">+-----------------+</span><br><span class="line">| REPEATABLE-READ |</span><br><span class="line">+-----------------+</span><br><span class="line"></span><br><span class="line">#事务A：启动一个事务</span><br><span class="line">start transaction;</span><br><span class="line">select * from tx;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |    1 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br><span class="line"></span><br><span class="line">#事务B：开启一个新事务(那么这两个事务交叉了)</span><br><span class="line">       在事务B中更新数据，并提交</span><br><span class="line">start transaction;</span><br><span class="line">update tx set num=10 where id=1;</span><br><span class="line">select * from tx;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |   10 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br><span class="line">commit;</span><br><span class="line"></span><br><span class="line">#事务A：这时候即使事务B已经提交了,但A能不能看到数据变化？</span><br><span class="line">select * from tx;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |    1 | ---&gt;还是看不到的！(这个级别2不一样，也说明级别3解决了不可重复读问题)</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br><span class="line"></span><br><span class="line">#事务A：只有当事务A也提交了，它才能够看到数据变化</span><br><span class="line">commit;</span><br><span class="line">select * from tx;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |   10 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br></pre></td></tr></table></figure>
<h3 id="读已提交"><a href="#读已提交" class="headerlink" title="读已提交"></a>读已提交</h3><ul>
<li>READ COMMITTED（读已提交）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">一个事务只能看见已经提交事务所做的改变，还能看到已经提交事务新增的行。</span><br><span class="line"></span><br><span class="line">这意味着在事务处理期间，同一个事务的多个 SELECT 语句可能返回不同的结果，这种情况称为 “不能重复读”</span><br></pre></td></tr></table></figure>
<ul>
<li>示例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#首先修改隔离级别</span><br><span class="line">set tx_isolation=&apos;read-committed&apos;;</span><br><span class="line">select @@tx_isolation;</span><br><span class="line">+----------------+</span><br><span class="line">| @@tx_isolation |</span><br><span class="line">+----------------+</span><br><span class="line">| READ-COMMITTED |</span><br><span class="line">+----------------+</span><br><span class="line"></span><br><span class="line">#事务A：启动一个事务</span><br><span class="line">start transaction;</span><br><span class="line">select * from tx;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |    1 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br><span class="line"></span><br><span class="line">#事务B：也启动一个事务(那么两个事务交叉了)</span><br><span class="line">       在这事务中更新数据，且未提交</span><br><span class="line">start transaction;</span><br><span class="line">update tx set num=10 where id=1;</span><br><span class="line">select * from tx;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |   10 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br><span class="line"></span><br><span class="line">#事务A：这个时候我们在事务A中能看到数据的变化吗?</span><br><span class="line">select * from tx; ---------------&gt;</span><br><span class="line">+------+------+                |</span><br><span class="line">| id   | num  |                |</span><br><span class="line">+------+------+                |</span><br><span class="line">|    1 |    1 |---&gt;并不能看到！  |</span><br><span class="line">|    2 |    2 |                |</span><br><span class="line">|    3 |    3 |                |</span><br><span class="line">+------+------+                |——&gt;相同的select语句，结果却不一样</span><br><span class="line">                               |</span><br><span class="line">#事务B：如果提交了事务B呢?         |</span><br><span class="line">commit;                        |</span><br><span class="line">                               |</span><br><span class="line">#事务A:                         |</span><br><span class="line">select * from tx; ---------------&gt;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |   10 |---&gt;因为事务B已经提交了，所以在A中我们看到了数据变化</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br></pre></td></tr></table></figure>
<h3 id="读未提交"><a href="#读未提交" class="headerlink" title="读未提交"></a>读未提交</h3><ul>
<li>READ UNCOMMITTED（读未提交）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">此级别为最小的隔离级别，所有事务都可以看到其他未提交事务的执行结果，这会引发 “脏读”</span><br></pre></td></tr></table></figure>
<ul>
<li>示例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#首先，修改隔离级别</span><br><span class="line">set tx_isolation=&apos;READ-UNCOMMITTED&apos;;</span><br><span class="line">select @@tx_isolation;</span><br><span class="line">+------------------+</span><br><span class="line">| @@tx_isolation   |</span><br><span class="line">+------------------+</span><br><span class="line">| READ-UNCOMMITTED |</span><br><span class="line">+------------------+</span><br><span class="line"></span><br><span class="line">#事务A：启动一个事务</span><br><span class="line">start transaction;</span><br><span class="line">select * from tx;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |    1 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br><span class="line"></span><br><span class="line">#事务B：也启动一个事务(那么两个事务交叉了)</span><br><span class="line">       在事务B中执行更新语句，且不提交</span><br><span class="line">start transaction;</span><br><span class="line">update tx set num=10 where id=1;</span><br><span class="line">select * from tx;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |   10 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br><span class="line"></span><br><span class="line">#事务A：那么这时候事务A能看到这个更新了的数据吗?</span><br><span class="line">select * from tx;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |   10 |   ---&gt;可以看到！说明我们读到了事务B还没有提交的数据</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br><span class="line"></span><br><span class="line">#事务B：事务B回滚,仍然未提交</span><br><span class="line">rollback;</span><br><span class="line">select * from tx;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |    1 |</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br><span class="line"></span><br><span class="line">#事务A：在事务A里面看到的也是B没有提交的数据</span><br><span class="line">select * from tx;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | num  |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 |    1 |      ---&gt;脏读意味着我在这个事务中(A中)，事务B虽然没有提交，但它任何一条数据变化，我都可以看到！</span><br><span class="line">|    2 |    2 |</span><br><span class="line">|    3 |    3 |</span><br><span class="line">+------+------+</span><br></pre></td></tr></table></figure>
<h3 id="修改隔离级别"><a href="#修改隔离级别" class="headerlink" title="修改隔离级别"></a>修改隔离级别</h3><p>MySQL默认为 <code>REPEATABLE READ</code> （可重复读）的隔离级别，可以使用 SET 命令来修改它。</p>
<ul>
<li>修改当前会话的事务隔离级别</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改全局会话的事务隔离级别</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET GLOBAL TRANSACTION ISOLATION LEVEL READ COMMITTED;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看当前的事务隔离级别</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT @@tx_isolation;</span><br></pre></td></tr></table></figure>
<h3 id="启动一个事务"><a href="#启动一个事务" class="headerlink" title="启动一个事务"></a>启动一个事务</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET tx_isolation=&apos;repeatable-read&apos;;    #设定会话事务的隔离级别</span><br><span class="line">START TRANSACTION;                     #开始一个事务</span><br><span class="line">SELECT * FROM tx;                      #执行事务内容</span><br><span class="line">UPDATE tx SET num=10 WHERE id=1;       #执行事务内容</span><br><span class="line">ROLLBACK;                              #回滚事务</span><br><span class="line">COMMIT;                                #提交事务</span><br></pre></td></tr></table></figure>
<h2 id="锁定机制"><a href="#锁定机制" class="headerlink" title="锁定机制"></a>锁定机制</h2><p>MySQL支持很多不同的表类型，而且对于不同的类型，锁定机制也是不同的，因此理解不同级别的锁定是使用MySQL的非事务表实现伪事务环境的基本条件。</p>
<ul>
<li>表锁定</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">一个特殊类型的访问，整个表被客户锁定，根据锁定的类型，其他客户不能向表中插入，甚至连从中读取数据也受到了限制。</span><br></pre></td></tr></table></figure>
<ul>
<li>页锁定</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MySQL将锁定表中的某些行（称作页），被锁定的行只对锁定最初的线程是可行的，如果另外一个线程想要向这些行写数据，它就必须等待锁被释放。不过其他页的行仍然可以使用。</span><br></pre></td></tr></table></figure>
<ul>
<li>行锁定</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">行级的锁定比表级别锁定或者页级别锁定对锁定过程提供了更精细的控制。在这种情况下，至于线程使用的行是被锁定的，表其他的行对其他线程都是可用的，在多用户的环境中，页层的锁定降低了线程间的冲突，可以使用户同时从一个相同的表读取甚至写数据，不过，必须平衡这种灵活性，实际上它还有这三层锁定的最高性能开销。</span><br><span class="line"></span><br><span class="line">MyISAM表类型只支持表级的锁定，当设计到大量的读操作而不是写操作时。它提供了比行和页级锁定更好的性能。BDB表类型支持页级锁定，Innodb表类型在事务中自动执行行级别的锁定。</span><br></pre></td></tr></table></figure>
<h2 id="语句分类"><a href="#语句分类" class="headerlink" title="语句分类"></a>语句分类</h2><p>可以把 SQL 分为三个主要类别：数据定义语言 (DDL) 、数据操作语言 (DML) 、数据控制语言（DCL）</p>
<ul>
<li>数据定义语言DDL</li>
</ul>
<p>SQL 的数据定义语言 (DDL) 部分使我们有能力创建或删除表格。我们也可以定义索引（键），规定表之间的链接，以及施加表间的约束。 定义数据库的组件：库、表、索引、用户、视图、存储过程、存储函数，这个组件称为数据定义语言（DDL）</p>
<p>SQL 中重要的 DDL 语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE         #创建新数据库</span><br><span class="line">ALTER DATABASE          #修改数据库</span><br><span class="line">CREATE TABLE            #创建新表</span><br><span class="line">ALTER TABLE             #变更（改变）数据库表</span><br><span class="line">DROP TABLE              #删除表</span><br><span class="line">CREATE INDEX            #创建索引（搜索键）</span><br><span class="line">DROP INDEX              #删除索引</span><br></pre></td></tr></table></figure>
<ul>
<li>数据操纵语言DML</li>
</ul>
<p>用于操纵数据的语句，这些语句控制添加删除记录、查询和连接表、检验数据完整性。这个组件称为数据定义语言（DML）</p>
<p>SQL 中重要的 DML 语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT                  #从数据库表中获取数据</span><br><span class="line">UPDATE                  #更新数据库表中的数据</span><br><span class="line">DELETE                  #从数据库表中删除数据</span><br><span class="line">INSERT INTO             #向数据库表中插入数据</span><br></pre></td></tr></table></figure>
<ul>
<li>数据控制语言DCL</li>
</ul>
<p>用于控制不同数据段的许可和访问级别的语句，这些语句定义了数据库、表和字段的访问级别和安全权限、我们可以基于用户、主机来指定它们的权限，这个组件称之为数据控制语言（DCL）</p>
<p>SQL 中重要的 DCL 语句：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GRANT                   #授权</span><br><span class="line">REVOKE                  #移除授权</span><br></pre></td></tr></table></figure>
<h2 id="语法规范"><a href="#语法规范" class="headerlink" title="语法规范"></a>语法规范</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. 在数据库系统中，SQL语句不区分大小写(建议用大写)  </span><br><span class="line">2. 但字符串常量区分大小写</span><br><span class="line">3. SQL语句可单行或多行书写，以;结尾 </span><br><span class="line">4. 关键词不能跨多行或简写</span><br><span class="line">5. 用空格和缩进来提高语句的可读性 </span><br><span class="line">6. 子句通常位于独立行，便于编辑，提高可读性 </span><br><span class="line">7. 注释：SQL标准：‘/注释内容/ 表示多行注释’，‘--’ 表示单行注释，MySQL支持：#注释</span><br></pre></td></tr></table></figure>
<h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><p>数据分类主要是为了数据存储占用的空间，和数据检索时候的速度，这两方面的原因，字符串的存储要比数字的存储需要占用更多的磁盘空间，而且如果日期时间、数值存储为字符串，那么对它们的计算将很困难，为了解决这样的问题，通过给数据分类来识别数据方便用这个类型的特性类操作数据。</p>
<h2 id="数值型"><a href="#数值型" class="headerlink" title="数值型"></a>数值型</h2><ul>
<li>整数</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>大小</th>
<th>范围（有符号）</th>
<th>范围（无符号）</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TINYINT</code></td>
<td>1字节</td>
<td><code>-128 ~ 127</code></td>
<td><code>0 ~ 255</code></td>
<td>微整形</td>
</tr>
<tr>
<td><code>SMALLINT</code></td>
<td>2字节</td>
<td><code>-32768 ~ 32767</code></td>
<td><code>0 ~ 65535</code></td>
<td>小整形</td>
</tr>
<tr>
<td><code>MEDIUMINT</code></td>
<td>3字节</td>
<td><code>-8388608 ~ 8388607</code></td>
<td><code>0 ~ 16777215</code></td>
<td>中整形</td>
</tr>
<tr>
<td><code>INT</code> 或 <code>INTEGER</code></td>
<td>4字节</td>
<td><code>-2147483648 ~ 2147483647</code></td>
<td><code>0 ~ 4294967295</code></td>
<td>大整形</td>
</tr>
<tr>
<td><code>BIGINT</code></td>
<td>8字节</td>
<td><code>-9223372036854775808 ~ 9223372036854775807</code></td>
<td><code>0 ~ 18446744073709551645</code></td>
<td>特大整形</td>
</tr>
<tr>
<td><code>BIT</code></td>
<td><code>[1~16]</code> 字节</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>整数修饰符</li>
</ul>
<table>
<thead>
<tr>
<th>修饰符</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>UNSIGNED</code></td>
<td>标识整数只保存正值，它可以增大整数的范围</td>
</tr>
<tr>
<td><code>ZEROFILL</code></td>
<td>标识使用0填充输出的值，使用这个修饰符，可以防止存储负值</td>
</tr>
</tbody>
</table>
<ul>
<li>使用修饰符的方法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE data(fi INT,fiu INT UNSIGNED,fiz INT ZEROFILL,fiuz INT UNSIGNED ZEROFILL);</span><br></pre></td></tr></table></figure>
<ul>
<li>浮点数</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>大小</th>
<th>范围（有符号）</th>
<th>范围（无符号）</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FLOAT</code></td>
<td>4字节</td>
<td><code>(-3.402823466E+38 ~ 1.175494351E-38)</code>,<code>0</code>,<code>(1.75494351E-38 ~ 3.402823466E+38)</code></td>
<td><code>0</code>,<code>(1.175494354E-38 ~ 3.402823466E+38)</code></td>
<td>单精度浮点数</td>
</tr>
<tr>
<td><code>DOUBLE</code></td>
<td>8字节</td>
<td><code>(1.7976931348623157E+308 ~ 2.2250738585072014E-308</code>,<code>0</code>,<code>(2.2250738585072014E-308 ~ 1.7976931348623157E+308)</code></td>
<td><code>0</code>,<code>(2.2250738585072014E-308 ~ 1.797693 1348623157E+308)</code></td>
<td>双精度浮点数</td>
</tr>
<tr>
<td><code>DECIMAL</code></td>
<td>如果M &gt; D为M+2否则为D+2</td>
<td><code>依赖M和D的值</code></td>
<td><code>依赖M和D的值</code></td>
<td>小数值</td>
</tr>
</tbody>
</table>
<ul>
<li>宽度指示器和小数点指示器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE data(price FLOAT(5,2));    #创建一个小数点后 2 位，共5位的显示浮点数</span><br></pre></td></tr></table></figure>
<ul>
<li>修饰符</li>
</ul>
<p><code>UNSIGNED</code> 和 <code>ZEROFILL</code> 也可以被浮点数数据类型接受。</p>
<h2 id="字符串型"><a href="#字符串型" class="headerlink" title="字符串型"></a>字符串型</h2><table>
<thead>
<tr>
<th>类型</th>
<th>大小</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CHAR</code></td>
<td>0~255字节</td>
<td>定长字符串，空间无论是否使用会分配，不区分大小写</td>
</tr>
<tr>
<td><code>VARCHAR</code></td>
<td>0~65535字节</td>
<td>变长字符串，需要有结束符，不区分大小写</td>
</tr>
</tbody>
</table>
<ul>
<li>修饰符</li>
</ul>
<p><code>BINARY</code> ：定长字符串，空间无论是否使用会分配，区分大小写<br><code>VARBINARY</code> ：变长字符串，需要有结束符，区分大小写</p>
<ul>
<li>TEXT 不区分大小写</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>大小</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TINYTEXT</code></td>
<td>0~255字节</td>
<td>短文本字符串</td>
</tr>
<tr>
<td><code>TEXT</code></td>
<td>0~65535字节</td>
<td>长文本数据</td>
</tr>
<tr>
<td><code>MEDIUMTEXT</code></td>
<td>0~16777215字节</td>
<td>中等长度文本数据</td>
</tr>
<tr>
<td><code>LONGTEXT</code></td>
<td>0~4294967295字节</td>
<td>极大文本数据</td>
</tr>
</tbody>
</table>
<p>CHAR类型的变体是VARCHAR，它用于变长字符串，它也必须带有一个范围在0到255之间的大小指示器，然后CHAR和VARCHAR类型之间的差别在于，CHAR把这个大小视作准确的大小（用空格填补比较短的值，所以达到了这个大小），而VARCHAR类型把它视作最大值，并且只使用了存储字符串实际上需要的字节数（额外增加一个字节记录长度），因而较短的值也不会用空格填补，较长的值将会被截断。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE data(alphabet CHAR(10));</span><br></pre></td></tr></table></figure>
<ul>
<li>BLOB 二进制大对象</li>
</ul>
<table>
<thead>
<tr>
<th>类型</th>
<th>大小</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TINYBLOB</code></td>
<td>0~255字节</td>
<td>不超过255个字符的二进制字符串</td>
</tr>
<tr>
<td><code>BLOB</code></td>
<td>0~65535字节</td>
<td>二进制形式的长文本数据</td>
</tr>
<tr>
<td><code>MEDIUMBLOB</code></td>
<td>0~16777215字节</td>
<td>二进制形式的中等长度文本数据</td>
</tr>
<tr>
<td><code>LONGBLOB</code></td>
<td>0~4294967295字节</td>
<td>二进制形式的极大文本数据</td>
</tr>
</tbody>
</table>
<ul>
<li>TEXT 和 BLOB 类型</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">对于比较长的字符串（即长度超过255个字符的字符串），MySQL提供了TEXT和BLOB（二进制大对象）两种类型，根据需要存储数据的大小，它们有不同的子类型，这些大数量的类型用于储存大的文本块或者图像，声音文件那样的二进制数据。</span><br><span class="line">BLOB和TEXT类型在分类和比较的方式上不同：BLOB类型区分大小写，TEXT类型不区分大小写，大小修饰符不适用于各种BLOB和TEXT的子类型，比指定类型支持的最大范围大的值就被自动截断。</span><br></pre></td></tr></table></figure>
<h2 id="日期时间型"><a href="#日期时间型" class="headerlink" title="日期时间型"></a>日期时间型</h2><table>
<thead>
<tr>
<th>类型</th>
<th>大小（字节）</th>
<th>范围</th>
<th>格式</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>DATE</td>
<td>3</td>
<td><code>1000-01-01~9999-12-31</code></td>
<td>YY-MM-DD</td>
<td>日期</td>
</tr>
<tr>
<td>TIME</td>
<td>3</td>
<td><code>-838:59:59~838:59:59</code></td>
<td>HH:MM:SS</td>
<td>时间或持续时间</td>
</tr>
<tr>
<td>YEAR</td>
<td>1</td>
<td><code>1901~2155</code></td>
<td>YYYY</td>
<td>年份</td>
</tr>
<tr>
<td>DATETIME</td>
<td>8</td>
<td><code>1000-01-01 00:00:00 ~ 9999-12-31 23:59:59</code></td>
<td>YYYY-MM-DD HH:MM:SS</td>
<td>日期时间</td>
</tr>
<tr>
<td>TIMESTAMP</td>
<td>8</td>
<td><code>1970-01-01 00:00:01 ~ 2038-01-19 03:14:07</code></td>
<td>YYYYMMDD HHMMSS</td>
<td>时间戳</td>
</tr>
</tbody>
</table>
<h2 id="ENUM类型"><a href="#ENUM类型" class="headerlink" title="ENUM类型"></a>ENUM类型</h2><p>ENUM是一个字符串对象，65535个字符串，值通常是一个允许值的列表，该列表创建时被明确的列举，只能从给定的字符串中选择一个字符串来填入，通常用于互斥的值，例如性别。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE data(gender ENUM(&apos;M&apos;,&apos;f&apos;));</span><br></pre></td></tr></table></figure>
<h2 id="SET类型"><a href="#SET类型" class="headerlink" title="SET类型"></a>SET类型</h2><p>SET类型与ENUM类型相似但又完全不同，SET类型允许从预先定义的字符串值集合中选区任意数目的值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE data(gender SET(&apos;type1&apos;,&apos;type2&apos;,&apos;type3&apos;,&apos;type4&apos;));</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO data1 VALUES(&apos;type1,type3,type4&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from data1;</span><br><span class="line">+-------------------+</span><br><span class="line">| gender            |</span><br><span class="line">+-------------------+</span><br><span class="line">| type1,type3,type4 |</span><br><span class="line">+-------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure>
<h2 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h2><ul>
<li>无符号（UNSIGNED）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">无符号的数字</span><br></pre></td></tr></table></figure>
<ul>
<li>填充零（ZEROFILL）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">标识使用0填充输出的值，使用这个修饰符，可以防止存储负值</span><br></pre></td></tr></table></figure>
<ul>
<li>二进制模式（BINARY ）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">字符串型可用的修饰符，当用于比较运算时，这个修饰符使 CHAR、VARCHAR 以二进制方式参于运算，而不是以传统的区分大小写的方式。</span><br></pre></td></tr></table></figure>
<h1 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h1><p>MySQL的运算符超过25个，每个都有特殊的用途，按功能分为以下几种</p>
<h2 id="算术运算"><a href="#算术运算" class="headerlink" title="算术运算"></a>算术运算</h2><table>
<thead>
<tr>
<th>运算符</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>+</td>
<td>加法</td>
</tr>
<tr>
<td>-</td>
<td>减法</td>
</tr>
<tr>
<td>*</td>
<td>乘法</td>
</tr>
<tr>
<td>/</td>
<td>除法，返回商</td>
</tr>
<tr>
<td>%</td>
<td>除法，返回余数</td>
</tr>
</tbody>
</table>
<h2 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h2><table>
<thead>
<tr>
<th>运算符</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td>等于</td>
</tr>
<tr>
<td>BINARY &lt;表达式&gt;</td>
<td>不区分大小写的字符串比较</td>
</tr>
<tr>
<td>&lt;&gt; OR !=</td>
<td>不等于</td>
</tr>
<tr>
<td>&lt;=&gt;</td>
<td>NULL安全的等于</td>
</tr>
<tr>
<td>&lt;</td>
<td>小于</td>
</tr>
<tr>
<td>&lt;=</td>
<td>小于等于</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于</td>
</tr>
<tr>
<td>>=</td>
<td>大于等于</td>
</tr>
<tr>
<td>BETWEEN</td>
<td>存在于指定范围</td>
</tr>
<tr>
<td>IN</td>
<td>存在于指定集合</td>
</tr>
<tr>
<td>IS NULL</td>
<td>为NULL</td>
</tr>
<tr>
<td>IS NOT NULL</td>
<td>不为NULL</td>
</tr>
<tr>
<td>LIKE</td>
<td>通配符匹配</td>
</tr>
<tr>
<td>REGEXP or RLIKE</td>
<td>正则表达式匹配</td>
</tr>
</tbody>
</table>
<h2 id="逻辑运算"><a href="#逻辑运算" class="headerlink" title="逻辑运算"></a>逻辑运算</h2><table>
<thead>
<tr>
<th>运算符</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>NOT or !</td>
<td>逻辑非</td>
</tr>
<tr>
<td>AND or &amp;&amp;</td>
<td>逻辑和</td>
</tr>
<tr>
<td>OR or \</td>
<td>\</td>
<td></td>
<td>逻辑或</td>
</tr>
<tr>
<td>XOR</td>
<td>逻辑异或</td>
</tr>
</tbody>
</table>
<h2 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h2><table>
<thead>
<tr>
<th>运算符</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>&amp;</td>
<td>位与</td>
</tr>
<tr>
<td>\</td>
<td></td>
<td>位或</td>
</tr>
<tr>
<td>^</td>
<td>位异或</td>
</tr>
<tr>
<td>~</td>
<td>位取反</td>
</tr>
<tr>
<td>>&gt;</td>
<td>位右移</td>
</tr>
<tr>
<td>&lt;&lt;</td>
<td>位左移</td>
</tr>
</tbody>
</table>
<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><h2 id="数学函数"><a href="#数学函数" class="headerlink" title="数学函数"></a>数学函数</h2><p>MySQL包含一系列的算术操作，所以关系型数据库管理系统支持很多数学函数。</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ABS(x)</code></td>
<td>返回 <code>x</code> 的绝对值</td>
</tr>
<tr>
<td><code>ACO(x)</code></td>
<td>返回 <code>x</code> （弧度）的反余弦值</td>
</tr>
<tr>
<td><code>ASIN(x)</code></td>
<td>返回 <code>x</code> （弧度）的反正弦值</td>
</tr>
<tr>
<td><code>ATAN(x)</code></td>
<td>返回 <code>x</code> （弧度）的正反切值</td>
</tr>
<tr>
<td><code>CELING(x)</code></td>
<td>返回大于 <code>x</code> 的最小整数值</td>
</tr>
<tr>
<td><code>COS(x)</code></td>
<td>返回 <code>x</code>（弧度）的余弦值</td>
</tr>
<tr>
<td><code>COT(x)</code></td>
<td>返回 <code>x</code> （弧度）的余切</td>
</tr>
<tr>
<td><code>DEGREES(x)</code></td>
<td>返回弧度值 <code>x</code> 转化为角度的结果</td>
</tr>
<tr>
<td><code>EXP(x)</code></td>
<td>返回值 <code>e</code> （自然对数的底）的 <code>x</code> 次方</td>
</tr>
<tr>
<td><code>FLOOR(x)</code></td>
<td>返回小于<code>x</code> 的最大整数值</td>
</tr>
<tr>
<td><code>GREATEST(x1,x2,x3,x4,...xn)</code></td>
<td>返回集合中最大的值</td>
</tr>
<tr>
<td><code>LEAST(x1,x2,x3,x4,...xn)</code></td>
<td>返回集合中最小的值</td>
</tr>
<tr>
<td><code>LN(x)</code></td>
<td>返回 <code>x</code> 的自然对数</td>
</tr>
<tr>
<td><code>LOG(x,y)</code></td>
<td>返回 <code>x</code> 的以 <code>x</code> 为底的对数</td>
</tr>
<tr>
<td><code>MOD(x,y)</code></td>
<td>返回 <code>x/y</code> 的模（余数）</td>
</tr>
<tr>
<td><code>PI()</code></td>
<td>返回 <code>pi</code> 的值（圆周率）</td>
</tr>
<tr>
<td><code>POW(x,y)</code> OR <code>POWER(x,y)</code></td>
<td>返回 <code>x</code> 的 <code>y</code> 次幂</td>
</tr>
<tr>
<td><code>RAND()</code></td>
<td>返回 <code>0-1</code> 内的随机值</td>
</tr>
<tr>
<td><code>RADIANS(x)</code></td>
<td>返回角度 <code>x</code> 转化为弧度的结果</td>
</tr>
<tr>
<td><code>ROUND(x,y)</code></td>
<td>返回参数 <code>x</code> 的四舍五入的有<code>y</code> 位小数的值</td>
</tr>
<tr>
<td><code>SIGN(x)</code></td>
<td>返回代表数字 <code>x</code> 的符号的值</td>
</tr>
<tr>
<td><code>SQRT(x)</code></td>
<td>返回 <code>x</code> 的开方</td>
</tr>
<tr>
<td><code>SIN(x)</code></td>
<td>返回 <code>x</code> （弧度）的正弦值</td>
</tr>
<tr>
<td><code>TAN(x)</code></td>
<td>返回 <code>x</code> （弧度）的正切值</td>
</tr>
<tr>
<td><code>TRUNCATE(x,y)</code></td>
<td>返回数字 <code>x</code> 截短<code>y</code> 位小数的结果</td>
</tr>
</tbody>
</table>
<h2 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h2><p>MySQL有一组函数是特意为求和或者对列表中的数据进行集中概括而设计的。这些函数经常用在包含GROUP BY从句的SELECT查询中，当然他们也可以用于无GROUP的查询。</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AVG(col)</code></td>
<td>返回指定列的平均值</td>
</tr>
<tr>
<td><code>COUNT(col)</code></td>
<td>返回指定列中非NULL值的个数</td>
</tr>
<tr>
<td><code>MIN(col)</code></td>
<td>返回指定列中的最小值</td>
</tr>
<tr>
<td><code>MAX(col)</code></td>
<td>返回指定列中的最大值</td>
</tr>
<tr>
<td><code>SUM(col)</code></td>
<td>返回指定列的所有值之和</td>
</tr>
<tr>
<td><code>STD(col)</code></td>
<td>返回指定列的所有值的标准偏差</td>
</tr>
<tr>
<td><code>VARIANCE(col)</code></td>
<td>返回指定列的所有制的标准方差</td>
</tr>
<tr>
<td><code>GROUP_CONCAT(col)</code></td>
<td>返回由属于一组的列值连接组合而成的结果</td>
</tr>
</tbody>
</table>
<h2 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h2><p>因为MySQL数据库不仅包含数字数据，还包含字符串，因此MySQL有一套为字符串操作而设计的函数。</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ASCII(char)</code></td>
<td>返回字符的ASCII码值</td>
</tr>
<tr>
<td><code>BIT_LENGTH(str)</code></td>
<td>返回字符串的比特长度</td>
</tr>
<tr>
<td><code>CHAR(x1,x2,...,xn)</code></td>
<td>返回 <code>x1,x2,...xn</code> 所代表的ASCII码值给出的字符组成的字符串</td>
</tr>
<tr>
<td><code>CONCAT(s1,2,...,sn)</code></td>
<td>将 <code>s1,s2,...,sn</code> 连接成字符串</td>
</tr>
<tr>
<td><code>CONCAT_WS(sep,s1,s2,...sn)</code></td>
<td>将 <code>s1,s2,...,sn</code> 连接成字符串，并用 <code>sep</code> 字符间隔</td>
</tr>
<tr>
<td><code>INSERT(str,x,y,instr)</code></td>
<td>将字符串 <code>str</code> 从 <code>x</code> 位置开始，<code>y</code> 个字符长的子串替换为字符串<code>instr</code></td>
</tr>
</tbody>
</table>
<h2 id="日期时间函数"><a href="#日期时间函数" class="headerlink" title="日期时间函数"></a>日期时间函数</h2><p>因为MySQL有很多日期时间数据类型，下面列出了比较重要的日期时间函数。</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CURDATE()</code> OR <code>CURRENT_DATE()</code></td>
<td>返回当前的日期</td>
</tr>
<tr>
<td><code>CURTIME</code> OR <code>CURRENT_TIME()</code></td>
<td>返回当前的时间</td>
</tr>
<tr>
<td><code>NOW()</code></td>
<td>返回当前的日期和时间</td>
</tr>
<tr>
<td><code>DATE_FORMAT(date，fmt)</code></td>
<td>依照指定的 <code>fmt</code> 格式格式化日期 <code>date</code> 值</td>
</tr>
<tr>
<td><code>DATE_ADD(date,INTERVAL int keyword)</code></td>
<td>返回日期 <code>date</code> 加上时间间隔 <code>int</code> 的结果</td>
</tr>
<tr>
<td><code>DATE_SUM(date,INTERVAL int keyword)</code></td>
<td>返回日期 <code>date</code> 减去时间间隔 <code>int</code> 的结果</td>
</tr>
<tr>
<td><code>FROM_DAYS(x)</code></td>
<td>返回一个日期，它是由年份 <code>0</code> 加上 <code>x</code> 天产生的</td>
</tr>
<tr>
<td><code>PERIOD_ADD(date,mon)</code></td>
<td>返回日期 <code>date</code> 增加 <code>mon</code> 月份的结果</td>
</tr>
<tr>
<td><code>PERIOD_DIFF(date1,date2)</code></td>
<td>返回日期 <code>date1</code> 和 <code>date2</code> 相差的月份</td>
</tr>
<tr>
<td><code>MONTHNAME(date)</code></td>
<td>返回 <code>date</code> 的月份名</td>
</tr>
<tr>
<td><code>DAYNAME(date)</code></td>
<td>返回 <code>date</code> 的星期名</td>
</tr>
<tr>
<td><code>EXTRACT(keyword FROM date)</code></td>
<td>返回日期 <code>date</code> 的指定部分，即 <code>keyword</code> 指定的</td>
</tr>
<tr>
<td><code>TO_DAYS(date)</code></td>
<td>返回从 0 年到日期 <code>date</code> 的天数</td>
</tr>
<tr>
<td><code>TIME_FORMAT(time,fmt)</code></td>
<td>依照指定的 <code>fmt</code> 格式格式化时间 <code>time</code> 值</td>
</tr>
<tr>
<td><code>TIME_TO_SEC(time)</code></td>
<td>将时间 <code>time</code> 转化为秒数</td>
</tr>
<tr>
<td><code>SEC_TO_TIME(x)</code></td>
<td>把秒值 <code>x</code> 转换为易读的时间值</td>
</tr>
<tr>
<td><code>UNIX_TIMESTAMP(date)</code></td>
<td>返回日期 <code>date</code> 所代表的 UNIX 时间戳</td>
</tr>
<tr>
<td><code>FROM_UNINTIME(ts,fmt)</code></td>
<td>根据指定的 <code>fmt</code> 格式，格式化 UNIX 时间戳 <code>ts</code></td>
</tr>
<tr>
<td><code>QUARTER(date)</code></td>
<td>返回 <code>date</code> 在一年中的季度 （1-4）</td>
</tr>
<tr>
<td><code>WEEK(date)</code></td>
<td>返回日期 <code>date</code> 为一年中的第几周（0~53）</td>
</tr>
<tr>
<td><code>DAYOFYEAR(date)</code></td>
<td>返回 <code>date</code> 是一年的第几天（1~366）</td>
</tr>
<tr>
<td><code>DAYOFWEEK(date)</code></td>
<td>返回 <code>date</code> 所代表的一星期中的第几天（1~7）</td>
</tr>
<tr>
<td><code>YEAH(date)</code></td>
<td>返回日期 <code>date</code> 的年份（1000~9999）</td>
</tr>
<tr>
<td><code>MONTH(date)</code></td>
<td>返回 <code>date</code> 的月份值 （1~12）</td>
</tr>
<tr>
<td><code>DATOFMONTH(date)</code></td>
<td>返回 <code>date</code> 是一个月的第几天 （1-31）</td>
</tr>
<tr>
<td><code>HOUR(time)</code></td>
<td>返回 <code>time</code> 的小时值 （0~23）</td>
</tr>
<tr>
<td><code>MINUTE(time)</code></td>
<td>返回 <code>time</code> 的分钟值 （0~59）</td>
</tr>
<tr>
<td><code>SECOND(time)</code></td>
<td>返回 <code>time</code> 的秒值（0-59）</td>
</tr>
</tbody>
</table>
<h2 id="加密函数"><a href="#加密函数" class="headerlink" title="加密函数"></a>加密函数</h2><p><code>PASSWORD()</code> 函数用来创建一个经过加密的字符串，它适合于插入到MySQL的安全系统，这个加密过程是不可逆的，和UNIX密码加密过程使用不同的算法。它主要用于MySQL的认证系统，而且MySQL手册建议使用 <code>ENCODE()/DECODE()</code> 或者 <code>AES_ENCRYPT()/AES_DECRYPT()</code> 而不是用户应用程序实现。</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AES_ENCRYPT(str,key)</code></td>
<td>返回用密钥 <code>key</code> 对字符串 <code>str</code> 利用高级加密标准算法加密后的结果</td>
</tr>
<tr>
<td><code>AES_DECRYPT(str,key)</code></td>
<td>返回用密钥 <code>key</code> 对字符串 <code>str</code> 利用高级加密标准算法加密后的结果</td>
</tr>
<tr>
<td><code>DECODE(str,key)</code></td>
<td>使用 <code>key</code> 作为密钥解密加密字符串<code>str</code></td>
</tr>
<tr>
<td><code>ENCRYPT(str,salt)</code></td>
<td>使用 <code>UNIX crypt()</code> 函数，用关键字 <code>salt</code> 加密字符串 <code>str</code></td>
</tr>
<tr>
<td><code>ENDODE(str,key)</code></td>
<td>使用 <code>key</code> 作为密钥加密字符串 <code>str</code></td>
</tr>
<tr>
<td><code>MD5()</code></td>
<td>计算字符串 <code>str</code> 的 MD5 校验和</td>
</tr>
<tr>
<td><code>PASSWORD(str)</code></td>
<td>返回字符串 <code>str</code> 的加密版本</td>
</tr>
<tr>
<td><code>SHA()</code></td>
<td>计算字符串 <code>str</code> 的安全散列算法（SHA） 校验和</td>
</tr>
</tbody>
</table>
<h2 id="格式化函数"><a href="#格式化函数" class="headerlink" title="格式化函数"></a>格式化函数</h2><table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>%a</code></td>
<td>缩写的星期名（Sum，Mon…）</td>
</tr>
<tr>
<td><code>%b</code></td>
<td>缩写的月份名（Jan，Feb…）</td>
</tr>
<tr>
<td><code>%d</code></td>
<td>月份中的大数</td>
</tr>
<tr>
<td><code>%H</code></td>
<td>小时（01，02…）</td>
</tr>
<tr>
<td><code>%I</code></td>
<td>分钟（00，01…）</td>
</tr>
<tr>
<td><code>%j</code></td>
<td>一年中的天数（001，002…）</td>
</tr>
<tr>
<td><code>%m</code></td>
<td>月份，2位（00，01…）</td>
</tr>
<tr>
<td><code>%M</code></td>
<td>长型月份（January，February…）</td>
</tr>
<tr>
<td><code>%p</code></td>
<td>AM或PM</td>
</tr>
<tr>
<td><code>%r</code></td>
<td>时间，12小时的格式</td>
</tr>
<tr>
<td><code>%S</code></td>
<td>秒（00，01…）</td>
</tr>
<tr>
<td><code>%T</code></td>
<td>时间，24小时的格式</td>
</tr>
<tr>
<td><code>%w</code></td>
<td>一周中的天数（0，1…）</td>
</tr>
<tr>
<td><code>%W</code></td>
<td>长型星期的名字（Sunday，Monday…）</td>
</tr>
<tr>
<td><code>%Y</code></td>
<td>年份，4位</td>
</tr>
</tbody>
</table>
<h2 id="控制流函数"><a href="#控制流函数" class="headerlink" title="控制流函数"></a>控制流函数</h2><p>也许你不知道，MySQL有4个函数用来进行条件操作的。这些函数可以实现MySQL的条件逻辑，允许开发者将一些应用程序逻辑转换到数据库后台。</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CASE WHEN [testN] THEN [resultN] ... ELSE [DEFAULT] END</code></td>
<td>如果 <code>test</code> 是真，则返回 <code>resultN</code>，否则返回 <code>default</code></td>
</tr>
<tr>
<td><code>CASE WHEN [test] THEN [valN] THEN [resultN] ... ELSE [DEFAULT] END</code></td>
<td>如果<code>test</code> 和 <code>valN</code> 相等，则返回 <code>result</code> ，否则返回 <code>default</code></td>
</tr>
<tr>
<td><code>IF(test,t,f)</code></td>
<td>如果 <code>test</code> 是真，返回 <code>t</code>，否则返回<code>f</code></td>
</tr>
<tr>
<td><code>IFNULL(arg1,arg2)</code></td>
<td>如果 <code>arg1</code> 不是空，返回 <code>arg1</code>，否则返回<code>arg2</code></td>
</tr>
<tr>
<td><code>NULLIF(arg1,arg2)</code></td>
<td>如果 <code>arg1</code> = <code>arg2</code> 返回NULL，否则返回 <code>arg1</code></td>
</tr>
</tbody>
</table>
<h2 id="类型转化函数"><a href="#类型转化函数" class="headerlink" title="类型转化函数"></a>类型转化函数</h2><p>为了进行数据类型转换，MySQL提供了<code>CAST()</code> 函数，它可以把一个值转化为指定的数据类型，MySQL支持以下几种类型：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">BINARY</span><br><span class="line">CHAR</span><br><span class="line">DATE</span><br><span class="line">TIME</span><br><span class="line">DATETIME</span><br><span class="line">SIGNED</span><br><span class="line">UNSIGNED</span><br></pre></td></tr></table></figure>
<ul>
<li>例如，强制日期时间函数返回一个数字，而不是字符串输出。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT CAST(NOW() AS SIGNED INTEGER),CURDATE() + 0;</span><br></pre></td></tr></table></figure>
<h2 id="系统信息函数"><a href="#系统信息函数" class="headerlink" title="系统信息函数"></a>系统信息函数</h2><table>
<thead>
<tr>
<th>函数</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DATABASE()</code></td>
<td>返回当前数据库名</td>
</tr>
<tr>
<td><code>BENCHMARK(count,expr)</code></td>
<td>将表达式 <code>expr</code> 重复运行 <code>count</code> 次</td>
</tr>
<tr>
<td><code>CONNECTION_ID()</code></td>
<td>将返回当前客户的连接ID</td>
</tr>
<tr>
<td><code>FOUND_ROWS()</code></td>
<td>将最后一个SELECT查询（没有以LIMIT进行结果限定）返回的记录行数返回</td>
</tr>
<tr>
<td><code>GET_LOCK(str,dur)</code></td>
<td>获得一个由字符串 <code>str</code> 明明的并且有 <code>dur</code> 延时的锁定</td>
</tr>
<tr>
<td><code>IS_FREE_LOCK(str)</code></td>
<td>检查以 <code>str</code> 命名的锁定是否释放</td>
</tr>
<tr>
<td><code>LAST_LNSERT_ID()</code></td>
<td>返回由系统自动产生的最后一个<code>AUTOLNCREMENT ID</code> 的值</td>
</tr>
<tr>
<td><code>MASTER_POS_WAIT(log,pos,dur)</code></td>
<td>锁定主服务器 <code>dur</code> 秒直到从服务器与主服务器的日志 <code>log</code> 指定位置 <code>pos</code> 同步</td>
</tr>
<tr>
<td><code>RELEASE_LOCK(str)</code></td>
<td>释放由字符串 <code>str</code> 命名的锁定</td>
</tr>
<tr>
<td><code>USER()</code> OR <code>SYSTEM_USER()</code></td>
<td>返回当前登陆用户名</td>
</tr>
<tr>
<td><code>VERSION()</code></td>
<td>返回MySQL服务器的版本</td>
</tr>
</tbody>
</table>
<h1 id="库表操作"><a href="#库表操作" class="headerlink" title="库表操作"></a>库表操作</h1><h2 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h2><p>MySQL安装完毕后，默认会存在下面几个数据库。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |    #MySQL服务器元数据信息，如数据库或表的名称，列的数据类型，访问权限等。</span><br><span class="line">| mysql              |    #数据库是系统数据库。它包含存储MySQL服务器运行时所需的信息的表。</span><br><span class="line">| performance_schema |    #主要用于收集数据库服务器性能参数。</span><br><span class="line">| test               |    #测试用库，可以删除</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows in set (0.02 sec)</span><br></pre></td></tr></table></figure>
<h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE DATABASE [IF NOT EXISTS] db_name [create_specification] ...</span><br><span class="line"></span><br><span class="line">create_specification:</span><br><span class="line">    [DEFAULT] CHARACTER SET [=] charset_name       #设置字符集</span><br><span class="line">  | [DEFAULT] COLLATE [=] collation_name           #设置排序规则</span><br></pre></td></tr></table></figure>
<ul>
<li>查看支持的所有字符集</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW CHARACTER SET;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看支持的所有排序规则</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW COLLATION;</span><br></pre></td></tr></table></figure>
<ul>
<li>选择数据库</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">USE db_name;</span><br></pre></td></tr></table></figure>
<h2 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP &#123;DATABASE | SCHEMA&#125; [IF EXISTS] db_name</span><br></pre></td></tr></table></figure>
<h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><p>MySQL允许我们使用<code>CREATE TEMPORARY TABLE</code>命令创建临时表，这种表之所以这么称呼，是因为它只在MySQL会话期内存在，当客户关闭了与MySQL服务器的连接时，这种表就会被自动删除，由于是依赖会话的，所以不同会话的表名是不会冲突的。</p>
<ul>
<li>创建表语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE [TEMPORARY] TABLE [IF NOT EXISTS] 表名称</span><br><span class="line">    (</span><br><span class="line">    col_name column_definition,</span><br><span class="line">    字段名称1 字段定义及约束,</span><br><span class="line">    字段名称2 字段定义及约束,</span><br><span class="line">    字段名称3 字段定义及约束,</span><br><span class="line">    ....</span><br><span class="line">    )</span><br><span class="line">    [table_options]</span><br></pre></td></tr></table></figure>
<ul>
<li>创建新表，定义表信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `students` (</span><br><span class="line">  `StuID` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `Name` varchar(50) NOT NULL,</span><br><span class="line">  `Age` tinyint(3) unsigned NOT NULL,</span><br><span class="line">  `Gender` enum(&apos;F&apos;,&apos;M&apos;) NOT NULL,</span><br><span class="line">  `ClassID` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `TeacherID` int(10) unsigned DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`StuID`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=26 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建新表和定义，并且复制数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `teststu` (</span><br><span class="line">    `Name` varchar(60) NOT NULL,</span><br><span class="line">    `Age` tinyint(2) unsigned NOT NULL,</span><br><span class="line">) ENGINE=MEMORY AS SELECT * FROM `students`;</span><br></pre></td></tr></table></figure>
<ul>
<li>复制表结构</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TEMPORARY TABLE IF NOT EXISTS `stu` LIKE `students`;    #复制表结构</span><br></pre></td></tr></table></figure>
<h3 id="字段定义"><a href="#字段定义" class="headerlink" title="字段定义"></a>字段定义</h3><ul>
<li>主键（PRIMARY KEY）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">由一个或多个字段组成，主键可以保证记录的唯一性，每张表只可以存在一个主键，主键字段不能为空（NULL），主键会自动创建索引。</span><br><span class="line">[CONSTRAINT [symbol]] PRIMARY KEY [index_type] (index_col_name,...)</span><br></pre></td></tr></table></figure>
<ul>
<li>外键（FOREIGN KEY）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">表的外键是另一表的主键, 这意味着外键字段的值的范围只能是另一个表的主键, 外键字段默认可以重复, 可以是空值，主要用来和其他表建立联系用的，一个表可以有多个外键。</span><br><span class="line"></span><br><span class="line">[CONSTRAINT [symbol]] FOREIGN KEY `` RESTRICT | CASCADE | SET NULL | NO ACTION | SET DEFAULT</span><br></pre></td></tr></table></figure>
<ul>
<li>唯一约束（UNIQUE）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">唯一约束可以保证记录的唯一性，每张表可以存在多个唯一约束，唯一约束的字段可以为（NULL）但只能有一个,唯一键会自动创建索引。</span><br><span class="line">[CONSTRAINT [symbol]] UNIQUE [INDEX|KEY]</span><br></pre></td></tr></table></figure>
<ul>
<li>索引（INDEX ）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">为一个字段增加索引，以加快查询速度</span><br><span class="line">&#123;INDEX|KEY&#125; [index_name] [index_type] (index_col_name,...)</span><br></pre></td></tr></table></figure>
<h3 id="字段约束"><a href="#字段约束" class="headerlink" title="字段约束"></a>字段约束</h3><ul>
<li>非空约束（NOT NULL）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">该字段不能为空</span><br></pre></td></tr></table></figure>
<ul>
<li>空（NULL）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">该字段可以为空</span><br></pre></td></tr></table></figure>
<ul>
<li>默认值（DEFAULE）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">提供了一个默认值</span><br></pre></td></tr></table></figure>
<ul>
<li>自增（AUTO_INCREMENT）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">该字段为自动增加的字段，可以手动指定</span><br></pre></td></tr></table></figure>
<h3 id="表选项"><a href="#表选项" class="headerlink" title="表选项"></a>表选项</h3><ul>
<li>检验（CHECK）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">符合条件的数据才能被存储，是一个表达式条件结果为真则数据有效</span><br></pre></td></tr></table></figure>
<ul>
<li>字符集（CHARACTER SET）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">指定默认使用的字符集</span><br></pre></td></tr></table></figure>
<ul>
<li>排序规则（COLLATE）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">可以指定字段的默认排序规则</span><br></pre></td></tr></table></figure>
<ul>
<li>表注解（COMMENT）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">表的说明信息</span><br></pre></td></tr></table></figure>
<ul>
<li>表的引擎（ENGINE）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">指定表的引擎，一般不建议表使用单独的引擎</span><br></pre></td></tr></table></figure>
<h2 id="表的关系"><a href="#表的关系" class="headerlink" title="表的关系"></a>表的关系</h2><p>表与表之间一般存在三种关系，即：一对一、一对多、多对多关系，这些关系都是通过 外键约束来实现的，外键只能实现将这两个表在逻辑上关联起来，不能做到查询的时候自动关联，所以查询的时候需要自己写多表查询的语句。</p>
<h3 id="一对一"><a href="#一对一" class="headerlink" title="一对一"></a>一对一</h3><p>例如：通常人员的资料分为常用资料和不常用的资料，分成两个表，在不常用信息表的最后添加一个外键指向常用信息表的主键上，比并且将外键列设置为唯一键，这就形成了一对一关系。</p>
<ul>
<li>常用信息表</li>
</ul>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>age</th>
<th>gender</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>杨金恒</td>
<td>29</td>
<td>M</td>
</tr>
<tr>
<td>2</td>
<td>李莹</td>
<td>29</td>
<td>F</td>
</tr>
</tbody>
</table>
<ul>
<li>不常用信息表</li>
</ul>
<table>
<thead>
<tr>
<th>id</th>
<th>addr</th>
<th>phone</th>
<th>email</th>
<th>pid</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>山西运城绛县安雨村</td>
<td>13621093303</td>
<td><a href="mailto:420123641@qq.com" target="_blank" rel="noopener">420123641@qq.com</a></td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>山西运城绛县侯马村</td>
<td>13703591246</td>
<td><a href="mailto:65465165@qq.com" target="_blank" rel="noopener">65465165@qq.com</a></td>
<td>2</td>
</tr>
</tbody>
</table>
<ul>
<li>建表语句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--- 常用信息表</span><br><span class="line">CREATE TABLE person(</span><br><span class="line">	id VARCHAR(12) PRIMARY KEY,</span><br><span class="line">    name VARCHAR(12),</span><br><span class="line">    age INT,</span><br><span class="line">    gender CHAR(1)</span><br><span class="line">);</span><br><span class="line">INSERT INTO person VALUES(&apos;1&apos;,&apos;杨金恒&apos;,29,&apos;M&apos;);</span><br><span class="line">INSERT INTO person VALUES(&apos;2&apos;,&apos;李莹&apos;,29,&apos;F&apos;);</span><br><span class="line"></span><br><span class="line">--- 不常用信息表,设置外键到常用信息表的主键上，并且将外键设置唯一约束</span><br><span class="line">CREATE TABLE info(</span><br><span class="line">    id VARCHAR(12) PRIMARY KEY,</span><br><span class="line">    addr VARCHAR(20),</span><br><span class="line">    phone VARCHAR(11),</span><br><span class="line">    email VARCHAR(20),</span><br><span class="line">    pid VARCHAR(12),</span><br><span class="line">    CONSTRAINT fk_person FOREIGN KEY(pid) REFERENCES person(id),</span><br><span class="line">    CONSTRAINT fk_uniq UNIQUE (pid)</span><br><span class="line">);</span><br><span class="line">INSERT INTO info VALUES(&apos;1&apos;,&apos;山西运城绛县安雨村&apos;,&apos;13621093303&apos;,&apos;420123641@qq.com&apos;,&apos;1&apos;);</span><br><span class="line">INSERT INTO info VALUES(&apos;2&apos;,&apos;山西运城绛县侯马村&apos;,&apos;13703591246&apos;,&apos;65465165@qq.com&apos;,&apos;2&apos;);</span><br></pre></td></tr></table></figure>
<ul>
<li>查询语句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--- 查出所有人的地址和电话信息</span><br><span class="line">SELECT person.name,info.addr,info.phone FROM person,info WHERE person.id = info.pid;</span><br></pre></td></tr></table></figure>
<h3 id="一对多"><a href="#一对多" class="headerlink" title="一对多"></a>一对多</h3><p>例如：一个人可以有多辆汽车、要求查询某个人所拥有的车辆。</p>
<p>分析：这种情况其实也可以采用一张表，但因为一个人可以拥有多辆汽车，如果采用一张表会造成冗余信息过多，好的设计方式是，人和车辆分表单独建表，那么如何将两个表关联呢？有个巧妙的办法，可以再车辆表中加个外键字段（人的编号）即可。</p>
<p>思路总结：建立两个表，“一”方不动，“多”方添加一个外键字段。</p>
<ul>
<li>人员表</li>
</ul>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>age</th>
<th>gender</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>王胖子</td>
<td>33</td>
<td>M</td>
</tr>
<tr>
<td>2</td>
<td>李铁柱</td>
<td>30</td>
<td>M</td>
</tr>
<tr>
<td>3</td>
<td>张翠华</td>
<td>25</td>
<td>F</td>
</tr>
</tbody>
</table>
<ul>
<li>车辆信息表</li>
</ul>
<table>
<thead>
<tr>
<th>id</th>
<th>mark</th>
<th>price</th>
<th>hid</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>三蹦子</td>
<td>25000</td>
<td>2</td>
</tr>
<tr>
<td>2</td>
<td>五菱宏光</td>
<td>40000</td>
<td>1</td>
</tr>
<tr>
<td>3</td>
<td>拖拉机</td>
<td>50000</td>
<td>3</td>
</tr>
<tr>
<td>4</td>
<td>奔驰</td>
<td>400000</td>
<td>3</td>
</tr>
<tr>
<td>5</td>
<td>宝马</td>
<td>300000</td>
<td>2</td>
</tr>
<tr>
<td>6</td>
<td>玛莎拉蒂</td>
<td>2000000</td>
<td>1</td>
</tr>
</tbody>
</table>
<ul>
<li>建表语句</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">--- 人员信息表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> human(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">VARCHAR</span>(<span class="number">12</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">12</span>),</span><br><span class="line">    age <span class="built_in">INT</span>,</span><br><span class="line">    gender <span class="built_in">CHAR</span>(<span class="number">1</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> human <span class="keyword">VALUES</span>(<span class="string">'1'</span>,<span class="string">'王胖子'</span>,<span class="number">27</span>,<span class="string">'M'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> human <span class="keyword">VALUES</span>(<span class="string">'2'</span>,<span class="string">'李铁柱'</span>,<span class="number">24</span>,<span class="string">'M'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> human <span class="keyword">VALUES</span>(<span class="string">'3'</span>,<span class="string">'张翠华'</span>,<span class="number">28</span>,<span class="string">'F'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">--- 车辆信息表</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> car(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">VARCHAR</span>(<span class="number">12</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    mark <span class="built_in">VARCHAR</span>(<span class="number">24</span>),</span><br><span class="line">    price <span class="built_in">FLOAT</span>(<span class="number">8</span>,<span class="number">2</span>),</span><br><span class="line">    hid <span class="built_in">VARCHAR</span>(<span class="number">12</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_human <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span>(hid) <span class="keyword">REFERENCES</span> human(<span class="keyword">id</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> car <span class="keyword">VALUES</span>(<span class="string">'1'</span>,<span class="string">'三蹦子'</span>,<span class="number">25000</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> car <span class="keyword">VALUES</span>(<span class="string">'2'</span>,<span class="string">'五菱宏光'</span>,<span class="number">40000</span>,<span class="string">'1'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> car <span class="keyword">VALUES</span>(<span class="string">'3'</span>,<span class="string">'拖拉机'</span>,<span class="number">50000</span>,<span class="string">'3'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> car <span class="keyword">VALUES</span>(<span class="string">'4'</span>,<span class="string">'奔驰'</span>,<span class="number">400000</span>,<span class="string">'3'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> car <span class="keyword">VALUES</span>(<span class="string">'5'</span>,<span class="string">'宝马'</span>,<span class="number">300000</span>,<span class="string">'2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> car <span class="keyword">VALUES</span>(<span class="string">'6'</span>,<span class="string">'玛莎拉蒂'</span>,<span class="number">800000</span>,<span class="string">'1'</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>多表连接查询</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM human,car WHERE human.id = car.hid;</span><br><span class="line">SELECT human.name AS 车主,car.mark AS 车辆 FROM human INNER JOIN car WHERE human.id = car.hid;</span><br><span class="line">SELECT human.name AS 车主,car.mark AS 车辆 FROM human INNER JOIN car WHERE human.id = car.hid ORDER BY human.name;    // 排序</span><br></pre></td></tr></table></figure>
<h3 id="多对多"><a href="#多对多" class="headerlink" title="多对多"></a>多对多</h3><p>例如：学生选择，一个学生可以选修多门课程，每门课程可供多个学生选择。</p>
<p>分析：这种方式可以按照类似一对多方式建表，但是冗余信息太多，好的方式式实体表和关系表分离并单独建表，实体表为学生表和课程表，关系表为选修表，其中关系表采用联合主键的方式（由学生主键和课程表主键组成）见表。</p>
<ul>
<li>学生表</li>
</ul>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>age</th>
<th>sex</th>
<th>class</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>王军</td>
<td>20</td>
<td>男</td>
<td>CL101</td>
</tr>
<tr>
<td>2</td>
<td>张宇</td>
<td>21</td>
<td>男</td>
<td>CL101</td>
</tr>
<tr>
<td>3</td>
<td>刘飞</td>
<td>18</td>
<td>男</td>
<td>CL102</td>
</tr>
<tr>
<td>4</td>
<td>赵燕</td>
<td>19</td>
<td>女</td>
<td>CL103</td>
</tr>
<tr>
<td>5</td>
<td>曾婷</td>
<td>22</td>
<td>女</td>
<td>CL104</td>
</tr>
<tr>
<td>6</td>
<td>周慧</td>
<td>23</td>
<td>女</td>
<td>CL104</td>
</tr>
<tr>
<td>7</td>
<td>小红</td>
<td>25</td>
<td>女</td>
<td>CL104</td>
</tr>
<tr>
<td>8</td>
<td>杨晓</td>
<td>27</td>
<td>女</td>
<td>CL104</td>
</tr>
<tr>
<td>9</td>
<td>李杰</td>
<td>19</td>
<td>男</td>
<td>CL105</td>
</tr>
<tr>
<td>10</td>
<td>张良</td>
<td>23</td>
<td>男</td>
<td>CL105</td>
</tr>
</tbody>
</table>
<ul>
<li>课程表</li>
</ul>
<table>
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>credit</th>
<th>teacher</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>Java</td>
<td>3.5</td>
<td>李老师</td>
</tr>
<tr>
<td>2</td>
<td>高等数学</td>
<td>5.0</td>
<td>赵老师</td>
</tr>
<tr>
<td>3</td>
<td>JavaScript</td>
<td>3.5</td>
<td>王老师</td>
</tr>
<tr>
<td>4</td>
<td>离散数学</td>
<td>3.5</td>
<td>卜老师</td>
</tr>
<tr>
<td>5</td>
<td>数据库</td>
<td>3.5</td>
<td>廖老师</td>
</tr>
<tr>
<td>6</td>
<td>操作系统</td>
<td>2.5</td>
<td>张老师</td>
</tr>
</tbody>
</table>
<ul>
<li>选课表</li>
</ul>
<table>
<thead>
<tr>
<th>sid</th>
<th>cid</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>2</td>
<td>1</td>
</tr>
<tr>
<td>5</td>
<td>1</td>
</tr>
<tr>
<td>9</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
</tr>
<tr>
<td>7</td>
<td>2</td>
</tr>
<tr>
<td>1</td>
<td>3</td>
</tr>
<tr>
<td>4</td>
<td>3</td>
</tr>
<tr>
<td>8</td>
<td>3</td>
</tr>
<tr>
<td>2</td>
<td>4</td>
</tr>
<tr>
<td>6</td>
<td>4</td>
</tr>
<tr>
<td>3</td>
<td>5</td>
</tr>
<tr>
<td>9</td>
<td>5</td>
</tr>
</tbody>
</table>
<ul>
<li>建表语句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--- 建立学生表</span><br><span class="line">CREATE TABLE student(</span><br><span class="line">    id VARCHAR(10) PRIMARY KEY,</span><br><span class="line">    name VARCHAR(12),</span><br><span class="line">    age INT,</span><br><span class="line">    sex CHAR(1),</span><br><span class="line">    class VARCHAR(6)</span><br><span class="line">);</span><br><span class="line">INSERT INTO student VALUES(&apos;1&apos;,&apos;王军&apos;,20,1,&apos;c101&apos;);</span><br><span class="line">INSERT INTO student VALUES(&apos;2&apos;,&apos;张宇&apos;,21,1,&apos;c101&apos;);</span><br><span class="line">INSERT INTO student VALUES(&apos;3&apos;,&apos;刘飞&apos;,22,1,&apos;c102&apos;);</span><br><span class="line">INSERT INTO student VALUES(&apos;4&apos;,&apos;赵燕&apos;,18,0,&apos;c103&apos;);</span><br><span class="line">INSERT INTO student VALUES(&apos;5&apos;,&apos;曾婷&apos;,19,0,&apos;c103&apos;);</span><br><span class="line">INSERT INTO student VALUES(&apos;6&apos;,&apos;周慧&apos;,21,0,&apos;c104&apos;);</span><br><span class="line">INSERT INTO student VALUES(&apos;7&apos;,&apos;小红&apos;,23,0,&apos;c104&apos;);</span><br><span class="line">INSERT INTO student VALUES(&apos;8&apos;,&apos;杨晓&apos;,18,0,&apos;c104&apos;);</span><br><span class="line">INSERT INTO student VALUES(&apos;9&apos;,&apos;李杰&apos;,20,1,&apos;c105&apos;);</span><br><span class="line">INSERT INTO student VALUES(&apos;10&apos;,&apos;张良&apos;,22,1,&apos;c105&apos;);</span><br><span class="line"></span><br><span class="line">--- 建立课程表</span><br><span class="line">CREATE TABLE course(</span><br><span class="line">    id VARCHAR(10) PRIMARY KEY,</span><br><span class="line">    name VARCHAR(12),</span><br><span class="line">    credit NUMERIC(2,1),</span><br><span class="line">    teacher VARCHAR(12)</span><br><span class="line">);</span><br><span class="line">INSERT INTO course VALUES(&apos;1&apos;,&apos;Java&apos;,3.5,&apos;李老师&apos;);</span><br><span class="line">INSERT INTO course VALUES(&apos;2&apos;,&apos;高等数学&apos;,5.0,&apos;赵老师&apos;);</span><br><span class="line">INSERT INTO course VALUES(&apos;3&apos;,&apos;JavaScript&apos;,3.5,&apos;王老师&apos;);</span><br><span class="line">INSERT INTO course VALUES(&apos;4&apos;,&apos;离散数学&apos;,3.5,&apos;卜老师&apos;);</span><br><span class="line">INSERT INTO course VALUES(&apos;5&apos;,&apos;数据库&apos;,3.5,&apos;廖老师&apos;);</span><br><span class="line">INSERT INTO course VALUES(&apos;6&apos;,&apos;操作系统&apos;,3.5,&apos;张老师&apos;);</span><br><span class="line"></span><br><span class="line">--- 建立选修表</span><br><span class="line">CREATE TABLE sc(</span><br><span class="line">    sid VARCHAR(10),</span><br><span class="line">    cid VARCHAR(10)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">ALTER TABLE sc ADD CONSTRAINT pk_sc PRIMARY KEY(sid,cid);</span><br><span class="line">ALTER TABLE sc ADD CONSTRAINT fk_student FOREIGN KEY(sid) REFERENCES student(id);</span><br><span class="line">ALTER TABLE sc ADD CONSTRAINT fk_course FOREIGN KEY(cid) REFERENCES course(id);</span><br><span class="line"></span><br><span class="line">INSERT INTO sc VALUES(&apos;1&apos;,&apos;1&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;1&apos;,&apos;2&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;1&apos;,&apos;3&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;2&apos;,&apos;1&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;2&apos;,&apos;4&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;3&apos;,&apos;2&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;3&apos;,&apos;5&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;4&apos;,&apos;3&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;5&apos;,&apos;1&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;6&apos;,&apos;4&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;7&apos;,&apos;2&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;8&apos;,&apos;3&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;9&apos;,&apos;1&apos;);</span><br><span class="line">INSERT INTO sc VALUES(&apos;9&apos;,&apos;5&apos;);</span><br></pre></td></tr></table></figure>
<ul>
<li>查询语句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--- 取得没有选课的学生信息</span><br><span class="line">SELECT * FROM student WHERE student.id NOT IN (SELECT sid FROM sc);</span><br><span class="line"></span><br><span class="line">--- 取得没有学生选的课</span><br><span class="line">SELECT * FROM course WHERE course.id NOT IN (SELECT cid FROM sc);</span><br><span class="line"></span><br><span class="line">--- 取得学生的选课信息并按名字排序</span><br><span class="line">SELECT student.name AS 学生,course.name AS 课程,course.teacher AS 老师 FROM student,sc,course WHERE sc.sid=student.id AND sc.cid=course.id ORDER BY student.id;</span><br></pre></td></tr></table></figure>
<h2 id="删除表"><a href="#删除表" class="headerlink" title="删除表"></a>删除表</h2><ul>
<li>语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP [TEMPORARY] TABLE [IF EXISTS]</span><br><span class="line">    tbl_name [, tbl_name] ...</span><br></pre></td></tr></table></figure>
<ul>
<li>删除表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP TABLE test.students；</span><br></pre></td></tr></table></figure>
<h2 id="修改表"><a href="#修改表" class="headerlink" title="修改表"></a>修改表</h2><ul>
<li>修改表语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER [ONLINE|OFFLINE] [IGNORE] TABLE tbl_name</span><br><span class="line">    [alter_specification [, alter_specification] ...]</span><br><span class="line">    [partition_options]</span><br></pre></td></tr></table></figure>
<ul>
<li>示例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER TABLE `student` RENAME `s1`;                                #重命名表</span><br><span class="line">ALTER TABLE `student` ADD phone varchar(11) AFTER name;           #在指定字段后添加字段</span><br><span class="line">ALTER TABLE `student` MODIFY `name` CHAR(100);                    #修改字段类型</span><br><span class="line">ALTER TABLE `student` CHANGE COLUMN `phone` `mobile` char(11);    #修改名称及字段类型</span><br><span class="line">ALTER TABLE `student` DROP COLUMN mobile;                         #删除字段</span><br><span class="line">ALTER TABLE `student` ALTER `email` DROP DEFAULT;                 #删除默认值</span><br><span class="line">ALTER TABLE `student` ADD PRIMARY KEY(id,card);                   #添加复合主键</span><br><span class="line">ALTER TABLE `student` ADD INDEX index_name(name);                 #在指定字段添加索引</span><br><span class="line">ALTER TABLE `student` DROP INDEX index_name;                      #删除指定表的索引</span><br></pre></td></tr></table></figure>
<h2 id="信息查看"><a href="#信息查看" class="headerlink" title="信息查看"></a>信息查看</h2><ul>
<li>查看数据库</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW DATABASES;                   #查看所有的数据库</span><br><span class="line">SHOW CREATE DATABASE mysql;       #查看数据库的创建语句</span><br></pre></td></tr></table></figure>
<ul>
<li>查看表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW TABLES FROM mysql;           #查看数据库的所有表</span><br><span class="line">SHOW CREATE TABLE mysql.user;     #查看表创建语句</span><br><span class="line">SHOW COLUMNS FROM mysql.user;     #查看表结构定义</span><br><span class="line">DESCRIBE mysql.user;              #查看表结构定义</span><br><span class="line">DESC mysql.user;                  #查看表结构定义</span><br><span class="line">DESC mysql.user host;             #查看字段定义</span><br><span class="line">SHOW FULL PROCESSLIST;            #查看正在执行的SQL语句</span><br></pre></td></tr></table></figure>
<ul>
<li>查看索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW INDEX FROM mysql.user;       #查看表的索引</span><br></pre></td></tr></table></figure>
<h2 id="临时表"><a href="#临时表" class="headerlink" title="临时表"></a>临时表</h2><p>临时表是会话级别的，即使多个 <code>session</code> 创建的表名一样，都相互不影响，会话结束，表格自动删除。    </p>
<ul>
<li>创建一个临时表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TEMPORARY TABLE IF NOT EXISTS `stu`</span><br></pre></td></tr></table></figure>
<ul>
<li>创建临时表同时指定临时表引擎为 MEMORY ，并且从指定的表复制所有记录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TEMPORARY TABLE `mem_students` ENGINE=MEMORY AS SELECT * FROM `students`;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看建表语句，可以看到表定义信息，包括引擎信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW CREATE TABLE `stu`;</span><br></pre></td></tr></table></figure>
<ul>
<li>MEMORY引擎</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MEMORY是MySQL中一类特殊的存储引擎。它使用存储在内存中的内容来创建表，而且数据全部放在内存中。这些特性与前面的两个很不同。</span><br><span class="line"></span><br><span class="line">每个基于MEMORY存储引擎的表实际对应一个磁盘文件。该文件的文件名与表名相同，类型为frm类型。该文件中只存储表的结构。而其数据文件，都是存储在内存中，这样有利于数据的快速处理，提高整个表的效率。值得注意的是，服务器需要有足够的内存来维持MEMORY存储引擎的表的使用。如果不需要了，可以释放内存，甚至删除不需要的表。</span><br><span class="line"></span><br><span class="line">MEMORY默认使用哈希索引。速度比使用B型树索引快。当然如果你想用B型树索引，可以在创建索引时指定。</span><br><span class="line"></span><br><span class="line">注意，MEMORY用到的很少，因为它是把数据存到内存中，如果内存出现异常就会影响数据。如果重启或者关机，所有数据都会消失。因此，基于MEMORY的表的生命周期很短，一般是一次性的。</span><br></pre></td></tr></table></figure>
<h1 id="数据操作"><a href="#数据操作" class="headerlink" title="数据操作"></a>数据操作</h1><h2 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h2><ul>
<li>向表中插入数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO `tests` (`name`,`age`,`sex`,`addr`) VALUES (&apos;yangjinheng&apos;,29,&apos;man&apos;,&apos;beijing&apos;);</span><br></pre></td></tr></table></figure>
<ul>
<li>在有自增键的时候，使用NULL使其自增</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MySQL [hellodb]&gt; SELECT * FROM students;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO students (Name,Age,Gender,ClassID,TeacherID) VALUES (&apos;yangjinheng&apos;,&apos;29&apos;,&apos;M&apos;,10,1);</span><br></pre></td></tr></table></figure>
<ul>
<li>同时插入多条数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO `tests` (`name`,`age`,`sex`,`addr`) VALUES (&apos;liying&apos;,27,&apos;woman&apos;,&apos;shandong&apos;),(&apos;zhengpengli&apos;,29,&apos;woman&apos;,&apos;shanxi&apos;);</span><br></pre></td></tr></table></figure>
<ul>
<li>如果主键唯一键冲突，则执行UPDATE后的语句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO `tests` (`name`,`age`,`sex`,`addr`) VALUES (&apos;yangjinheng&apos;,29,&apos;man&apos;,&apos;beijing&apos;) ON DUPLICATE KEY UPDATE `age` = 29, `addr` = &apos;shanxi&apos;;</span><br></pre></td></tr></table></figure>
<ul>
<li>按字段位置进行数据插入</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO `tests` VALUES (&apos;yangzhongxiao&apos;,27,&apos;man&apos;,&apos;taiyuan&apos;);</span><br></pre></td></tr></table></figure>
<ul>
<li>按位置匹配时候，遇到自增键可以留空NULL</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MySQL [hellodb]&gt; SELECT * FROM students;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO `students` VALUES (NULL,&apos;yangjinheng&apos;,&apos;29&apos;,&apos;M&apos;,10,1);</span><br></pre></td></tr></table></figure>
<ul>
<li>使用SET子句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO `tests` SET `name` = &apos;yangxiaoxiao&apos;, `age` = 30, `sex` = &apos;man&apos;, `addr` = &apos;shanxi&apos;;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果主键唯一键冲突，则执行UPDATE后的语句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT INTO `tests` SET `name` = &apos;yangxiaoxiao&apos;, `age` = 30, `sex` = &apos;man&apos;, `addr` = &apos;shanxi&apos; ON DUPLICATE KEY UPDATE `age` = 29, `addr` = &apos;shanxi&apos;;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用子查询结果插入</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">insert into `tests` (name,age) select `name`,`age` from `student`;</span><br></pre></td></tr></table></figure>
<h2 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UPDATE [LOW_PRIORITY] [IGNORE] table_name                      #指定修改哪张表</span><br><span class="line">    SET col_name = value                                       #设置字段的值</span><br><span class="line">    [WHERE where_condition]                                    #选择符合条件的，否则整个字段被修改</span><br><span class="line">    [ORDER BY ...]                                             #指定排序规则，配合LIMIT使用</span><br><span class="line">    [LIMIT row_count]                                          #限制修改多少条</span><br></pre></td></tr></table></figure>
<ul>
<li>示例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UPDATE table_name SET field1=new-value1, field2=new-value2 [WHERE Clause]</span><br></pre></td></tr></table></figure>
<ul>
<li>按WHERE条件修改表的指定字段</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UPDATE students SET TeacherID=1 WHERE StuID=26;</span><br></pre></td></tr></table></figure>
<h2 id="删除记录"><a href="#删除记录" class="headerlink" title="删除记录"></a>删除记录</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DELETE [LOW_PRIORITY] [QUICK] [IGNORE] FROM tbl_name           #指定从哪张表删除</span><br><span class="line">    [WHERE where_condition]                                    #选择符合条件的，不指定则清空表</span><br><span class="line">    [ORDER BY ...]                                             #指定排序规则，配合LIMIT使用</span><br><span class="line">    [LIMIT row_count]                                          #限制删除多少条</span><br></pre></td></tr></table></figure>
<ul>
<li>删除表的指定记录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DELETE FROM runoob_tbl WHERE runoob_id=3;</span><br></pre></td></tr></table></figure>
<ul>
<li>DROP DELETE TRUNCATE区别</li>
</ul>
<table>
<thead>
<tr>
<th>语句</th>
<th>作用</th>
<th>区别</th>
<th>场合</th>
</tr>
</thead>
<tbody>
<tr>
<td>DELETE</td>
<td>从表中删除行</td>
<td>可以记录事务，可以使触发器动作，</td>
<td>删除表的部分记录</td>
</tr>
<tr>
<td>DROP</td>
<td>删除全部数据和定义</td>
<td>隐式提交事务，不能回滚，不动作触发器</td>
<td>不再需要这个表时候</td>
</tr>
<tr>
<td>TRUNCATE</td>
<td>删除表的全部数据</td>
<td>速度快，但只能对表执行，不记录事务所以不能被回滚，不动作触发器</td>
<td>需要这个表，但要删除所有记录</td>
</tr>
</tbody>
</table>
<h2 id="查询记录"><a href="#查询记录" class="headerlink" title="查询记录"></a>查询记录</h2><table>
<thead>
<tr>
<th>语句形式</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>SELECT FROM …</td>
<td>查询一个表所有内容</td>
</tr>
<tr>
<td>SELECT FROM … WHERE …</td>
<td>查询一个表，挑出符合条件的行</td>
</tr>
<tr>
<td>SELECT FROM … ORDER BY …</td>
<td>查询一个表并排序</td>
</tr>
<tr>
<td>SELECT FROM … HAVING …</td>
<td>查询一个表，对结果进行过滤</td>
</tr>
<tr>
<td>SELECT FROM … GROUP BY … HAVING …</td>
<td>查询一个表，做分组，然后对分组过滤</td>
</tr>
<tr>
<td>SELECT FROM … WHERE … GROUP BY … LIMIT …</td>
<td>查询一个表，挑出符合条件的，做分组，对分组过滤</td>
</tr>
</tbody>
</table>
<ul>
<li>SELECT语句的流程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FROM：指定查询的表</span><br><span class="line">WHERE：选择满足条件的行</span><br><span class="line">GROUP BY：基于字段做分组</span><br><span class="line">HAVING：选择满足条件的分组</span><br><span class="line">ORDER BY：根据字段对记录进行排序</span><br><span class="line">SELECT：选择字段</span><br><span class="line">LIMIT：仅显示限制数目的行</span><br></pre></td></tr></table></figure>
<ul>
<li>对查询结果去重</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT DISTINCT Age FROM students;</span><br></pre></td></tr></table></figure>
<ul>
<li>不使用查询缓存，缓存功能只有在 <code>query_cache_type</code> 值为 <code>ON</code> 时，默认会缓存符合条件的查询</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT SQL_NO_CACHE Age FROM students;</span><br></pre></td></tr></table></figure>
<ul>
<li>字段拼接方式查询</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT ID, CONCAT(name,&apos;-&apos;,addr) FROM students;</span><br></pre></td></tr></table></figure>
<h3 id="AS别名"><a href="#AS别名" class="headerlink" title="AS别名"></a>AS别名</h3><ul>
<li>字段使用别名显示</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT Name AS 姓名 FROM students;</span><br></pre></td></tr></table></figure>
<ul>
<li>表使用别名</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT t.name FROM teachers AS t;</span><br></pre></td></tr></table></figure>
<h3 id="WHERE"><a href="#WHERE" class="headerlink" title="WHERE"></a>WHERE</h3><ul>
<li>使用WHERE按条件过滤行，WHERE是一种布尔表达式，可以使用算术操作符，比较操作符</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students WHERE Age &gt; 50;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>BETWEEN min_num AND max_num</code> 来表示一个区间数据，例如：年龄在30，到50之间。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students WHERE Age BETWEEN 30 AND 50;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>IN</code> 来做成员运算，是否在一个列表中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students WHERE Age IN (18,100,22);</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>IS NULL</code> or <code>IS NOT NULL</code> 来判断为空的数据</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students WHERE ClassID IS NULL;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>LIKE</code> 来进行模糊匹配，使用 <code>RLIKE</code> 进行正则表达式的匹配（会造成索引失效，不推荐）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students WHERE Name LIKE &apos;xu%&apos;;</span><br><span class="line">SELECT * FROM students WHERE Name RLIKE &apos;^xu.*&apos;;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用逻辑操作符 <code>NOT AND OR XOR</code> 来组合测试</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students WHERE Name LIKE &apos;xu%&apos; AND Age &gt; 18;</span><br></pre></td></tr></table></figure>
<h3 id="GROUP-BY"><a href="#GROUP-BY" class="headerlink" title="GROUP BY"></a>GROUP BY</h3><p>根据指定的条件把查询结果进行分组以用于聚合运算如：<code>avg(),max(),mix(),count(),sum()</code></p>
<ul>
<li>使用 <code>GROUP</code> 对指定的字段进行分组，然后对分组进行聚合运算</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT avg(Age),Gender FROM students GROUP BY Gender;</span><br></pre></td></tr></table></figure>
<ul>
<li>对分组进行统计。按<code>ClassID</code>分组，求每个分组分别有几条记录。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT count(StuID),ClassID FROM students GROUP BY ClassID;</span><br></pre></td></tr></table></figure>
<ul>
<li>对分组进行过滤，按<code>ClassID</code>分组，求每个分组分别有几条记录，对分组进行条件过滤</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT count(StuID) AS total ,ClassID FROM students GROUP BY ClassID HAVING total &gt;3;</span><br></pre></td></tr></table></figure>
<h3 id="OEDER-BY"><a href="#OEDER-BY" class="headerlink" title="OEDER BY"></a>OEDER BY</h3><p>根据指定的字段对查询结果进行排序，升序：ASC 降序：DESC。</p>
<ul>
<li>根据字段进行排序，默认为升序</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students ORDER BY Age;</span><br></pre></td></tr></table></figure>
<ul>
<li>对分组进行过滤，按<code>ClassID</code>分组，求每个分组分别有几条记录，对分组进行条件过滤，按照ClassID降序</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT count(StuID) AS total ,ClassID FROM students GROUP BY ClassID HAVING total &gt;3 ORDER BY ClassID DESC;</span><br></pre></td></tr></table></figure>
<h3 id="LIMIT"><a href="#LIMIT" class="headerlink" title="LIMIT"></a>LIMIT</h3><p>对查询输出的结果进行输出行数限制</p>
<ul>
<li>限制显示10条结果</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students LIMIT 10;</span><br></pre></td></tr></table></figure>
<ul>
<li>从指定位置开始限制</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students LIMIT 3,10;</span><br></pre></td></tr></table></figure>
<ul>
<li>从指定位置开始限制，另一种语法</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students LIMIT 3 OFFSET 10；</span><br></pre></td></tr></table></figure>
<h3 id="FOR-UPDATE"><a href="#FOR-UPDATE" class="headerlink" title="FOR UPDATE"></a>FOR UPDATE</h3><p>对查询目标施加写锁，独占锁，别的线程无法再进行写入和读取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students FOR UPDATE;</span><br></pre></td></tr></table></figure>
<h3 id="LOCK-IN-SHARE-MODE"><a href="#LOCK-IN-SHARE-MODE" class="headerlink" title="LOCK IN SHARE MODE"></a>LOCK IN SHARE MODE</h3><p>对查询目标施加读锁，共享锁，别的线程无法再进行写入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students LOCK IN SHARE MODE;</span><br></pre></td></tr></table></figure>
<h2 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h2><h3 id="交叉连接"><a href="#交叉连接" class="headerlink" title="交叉连接"></a>交叉连接</h3><ul>
<li>第一张表的每一个记录与第二张表的每一个记录进行连接，这种连接一般无任何意义。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students,teachers;</span><br></pre></td></tr></table></figure>
<h3 id="内连接"><a href="#内连接" class="headerlink" title="内连接"></a>内连接</h3><ul>
<li>等值连接，对两张表取交集</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students,teachers WHERE students.TeacherID=teachers.TID;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用别名方式，等值连接，对两张表取交集</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT s.name AS StuName,t.name AS TeaName FROM students AS s,teachers AS t WHERE s.TeacherID=t.TID;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>INNER JOIN</code> 关键字</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT s.name AS StuName,t.name AS TeaName FROM students AS s INNER JOIN teachers AS t WHERE s.TeacherID=t.TID;</span><br></pre></td></tr></table></figure>
<h3 id="外连接"><a href="#外连接" class="headerlink" title="外连接"></a>外连接</h3><p>OUTER JOIN 外连接</p>
<p><code>LEFT JOIN</code>：左外连接，完全输出左测表，同时显示右侧表与左侧表有交集的部分</p>
<p><code>RIGHT JOIN</code>：右外连接，完全输出右测表，同时显示左侧表与右侧表有交集的部分</p>
<ul>
<li>完全输出students表，以TeacherID等于TID的方式连接右侧表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT s.name,t.name FROM students AS s LEFT JOIN teachers AS t ON s.TeacherID = t.TID;</span><br></pre></td></tr></table></figure>
<ul>
<li>完全输出students表，以TeacherID等于TID的方式连接右侧表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT s.name,t.name FROM students AS s RIGHT JOIN teachers AS t ON s.TeacherID = t.TID;</span><br></pre></td></tr></table></figure>
<h3 id="自连接"><a href="#自连接" class="headerlink" title="自连接"></a>自连接</h3><p>使用表的一个字段和另外一个字段进行连接，把一张表当作两张表来使用即为自连接</p>
<ul>
<li>输出一个表的中两个字段相等的记录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT s.name,t.name FROM students AS s,students AS t WHERE s.TeacherID=t.StuID;</span><br></pre></td></tr></table></figure>
<h3 id="联合"><a href="#联合" class="headerlink" title="联合"></a>联合</h3><p>将两个表无条件的串起来</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT Name,Age FROM students UNION SELECT Name,Age FROM teachers;</span><br></pre></td></tr></table></figure>
<h2 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h2><h3 id="WHERE子查询"><a href="#WHERE子查询" class="headerlink" title="WHERE子查询"></a>WHERE子查询</h3><ul>
<li>在表达式中使用子查询的结果充当比较的对象</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students WHERE Age &gt; (SELECT avg(Age) FROM students);</span><br></pre></td></tr></table></figure>
<ul>
<li>在表达式中使用子查询的结果组为 <code>IN</code> 成员运算的对象</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT * FROM students WHERE Age IN (SELECT Age FROM teachers);</span><br></pre></td></tr></table></figure>
<h3 id="FROM子查询"><a href="#FROM子查询" class="headerlink" title="FROM子查询"></a>FROM子查询</h3><p>子查询的结果为FROM的目标</p>
<ul>
<li>列出哪些班级的平均年龄大于30</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 1.对student表的ClassID字段进行分组，求每个分组的Age的平均值</span><br><span class="line">SELECT avg(Age),ClassID FROM students WHERE ClassID IS NOT NULL GROUP BY ClassID;</span><br><span class="line"># 2.对子查询进条件过滤</span><br><span class="line">SELECT student.age,student.ClassID FROM (SELECT avg(Age) AS age,ClassID FROM students WHERE ClassID IS NOT NULL GROUP BY ClassID) AS student WHERE student.age &gt; 30;</span><br></pre></td></tr></table></figure>
<h2 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h2><ul>
<li>缓存设置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW GLOBAL VARIABLES LIKE &apos;query%&apos;;</span><br><span class="line">+------------------------------+---------+</span><br><span class="line">| Variable_name                | Value   |</span><br><span class="line">+------------------------------+---------+</span><br><span class="line">| query_alloc_block_size       | 8192    |        #</span><br><span class="line">| query_cache_limit            | 1048576 |        #</span><br><span class="line">| query_cache_min_res_unit     | 4096    |        #</span><br><span class="line">| query_cache_size             | 1048576 |        #查询缓存大小（单位字节）</span><br><span class="line">| query_cache_type             | OFF     |        #查询缓存是否打开，ON打开，为DEMAND时按需缓存</span><br><span class="line">| query_cache_wlock_invalidate | OFF     |        #</span><br><span class="line">| query_prealloc_size          | 8192    |        #</span><br><span class="line">+------------------------------+---------+</span><br></pre></td></tr></table></figure>
<ul>
<li>命中率低时候应该关闭缓存，命中率 = Qcache_hits  /  (Qcache_hits + Com_select)。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; SHOW GLOBAL STATUS LIKE &apos;Qcache%&apos;;</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">| Variable_name           | Value   |</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">| Qcache_free_blocks      | 1       |        #空闲的内存块</span><br><span class="line">| Qcache_free_memory      | 1031360 |        #空闲的内存空间</span><br><span class="line">| Qcache_hits             | 0       |        #由缓存命中得到结果的次数</span><br><span class="line">| Qcache_inserts          | 0       |        #可缓存查询语句的结果被放入缓存的次数</span><br><span class="line">| Qcache_lowmem_prunes    | 0       |        #由于缓存空间太少而不得不LRU清理缓存</span><br><span class="line">| Qcache_not_cached       | 32      |        #可缓存却没有能被缓存的结果次数</span><br><span class="line">| Qcache_queries_in_cache | 0       |        #在当前缓存空间中被缓存的查询个数</span><br><span class="line">| Qcache_total_blocks     | 1       |        #查询缓存的总内存块</span><br><span class="line">+-------------------------+---------+</span><br><span class="line">8 rows in set (0.01 sec)</span><br><span class="line">mysql&gt; SHOW GLOBAL STATUS LIKE &apos;Com_se%&apos;;</span><br><span class="line">+----------------+-------+</span><br><span class="line">| Variable_name  | Value |</span><br><span class="line">+----------------+-------+</span><br><span class="line">| Com_select     | 37    |        #由mysql执行得到结果的次数</span><br><span class="line">| Com_set_option | 39    |</span><br><span class="line">+----------------+-------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如果命中率低，但是命中的数据都非常大，那也应该考虑不关闭缓存。</p>
</blockquote>
<ul>
<li>查看一个SQL语句是否命中了缓存</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM students\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           id: 1</span><br><span class="line">  select_type: SIMPLE</span><br><span class="line">        table: students</span><br><span class="line">         type: ALL              #ALL全表扫描</span><br><span class="line">possible_keys: NULL</span><br><span class="line">          key: NULL</span><br><span class="line">      key_len: NULL</span><br><span class="line">          ref: NULL</span><br><span class="line">         rows: 27</span><br><span class="line">        Extra: NULL</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<ul>
<li>那些查询可能不会被缓存？</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">查询中包含：用户自定义函数、存储函数、用户自定义变量、临时表、mysql库中的系统表、或者包含列级别权限的表、有着不确定值的函数。</span><br></pre></td></tr></table></figure>
<h1 id="用户权限"><a href="#用户权限" class="headerlink" title="用户权限"></a>用户权限</h1><h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a>用户管理</h2><p>用户账号的组成：<code>&#39;USERNAME&#39;@&#39;HOST&#39;</code> ，其中 <code>HOST</code> 可以是IP地址或者网络地址，支持通配符 <code>%</code> 表示任意长度的任意字符，<code>_</code> 表示任意单个字符。</p>
<p>使用 <code>CREATE USER</code> 创建的用户一般有 <code>USAGE</code> 级权限，可以远程连入的权限，没有其他权限。</p>
<ul>
<li>创建用户</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE USER &apos;USERNAME&apos;@&apos;HOST&apos; [IDENTIFIED BY &apos;passwd&apos;]</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看用户的权限</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SHOW GRANTS FOR &apos;USERNAME&apos;@&apos;HOST&apos;;</span><br></pre></td></tr></table></figure>
<ul>
<li>重命名用户</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RENAME USER old_user TO new_user [, old_user TO new_user]</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<ul>
<li>删除用户</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">DROP USER &apos;USERNAME&apos;@&apos;HOST&apos;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改用户的密码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SET PASSWORD &apos;USERNAME&apos;@&apos;HOST&apos; = PASSWORD(&apos;auth_string&apos;)</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">UPDATE mysql.user SET password=PASSWORD(&apos;auth_string&apos;) WHERE user=&apos;USERNAME&apos;;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>
<h2 id="权限种类"><a href="#权限种类" class="headerlink" title="权限种类"></a>权限种类</h2><p>权限级别：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">库级别</span><br><span class="line">表级别</span><br><span class="line">字段级别</span><br><span class="line">管理类：能否创建用户，能够转增权限</span><br><span class="line">程序类权限：是否有权限运行一个存储过程和存储函数</span><br></pre></td></tr></table></figure>
<p>管理类：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE TEMPORARY TABLES 创建临时表</span><br><span class="line">CREATE USER 创建用户</span><br><span class="line">FILE 把数据到处到文件的权限</span><br><span class="line">SUPER 管理级别的操作，授权相关</span><br><span class="line">SHOW DATABASES 查看数据库的权限</span><br><span class="line">RELOAD 重新装载授权表</span><br><span class="line">SHUTDOWN 是否允许在进程级别直接关闭数据库的权限</span><br><span class="line">REPLICATION SLAVE 是否能够实现复制功能</span><br><span class="line">REPLICATION CLIENT 是否有权限请求复制</span><br><span class="line">LOCK TABLES 受否有权限锁表</span><br><span class="line">PROCESS 是否能够列出内部线程的列表</span><br></pre></td></tr></table></figure>
<p>程序类权限：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">FUNCTION</span><br><span class="line">PROCEDURE</span><br><span class="line">TRIGGER</span><br><span class="line">对上面的程序进行：CREATE,ALTER,DROP,EXCUTE的权限</span><br></pre></td></tr></table></figure>
<p>库和表级别：TABLE or DATABASE</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ALTER 能否修改表和库</span><br><span class="line">CREATE 创建库、表</span><br><span class="line">CREATE VIEW 创建视图</span><br><span class="line">DROP 删除库、表、视图</span><br><span class="line">INDEX 创建或者删除索引的权限</span><br><span class="line">SHOW VIEW 查看视图</span><br><span class="line">GRANT OPTION 能够把自己获得的权限赠给其他用户一个副本</span><br></pre></td></tr></table></figure>
<p>数据操作：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT</span><br><span class="line">INSERT</span><br><span class="line">DELETE</span><br><span class="line">UPDATE</span><br></pre></td></tr></table></figure>
<p>字段级别：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">SELECT(col1，col2...)</span><br><span class="line">UPDATE(col1，col2...)</span><br><span class="line">INSERT(col1，col2...)</span><br></pre></td></tr></table></figure>
<p>元数据数据库</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">授权表：db,host,user</span><br><span class="line">tables_priv,columns_priv,procs_priv,proxies_priv</span><br></pre></td></tr></table></figure>
<h2 id="授权管理"><a href="#授权管理" class="headerlink" title="授权管理"></a>授权管理</h2><ul>
<li>用户授权</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GRANT priv_type [(column_list)] ON [&#123;table|fuction|procedure&#125;] db.&#123;table|routine&#125; TO &apos;USERNAME&apos;@&apos;HOST&apos; IDENTIFIED BY &apos;auth_string&apos; [REQUIRE SSL] [WITH GRANT OPTION|resource_option]</span><br></pre></td></tr></table></figure>
<ul>
<li>取消授权</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REVOKE priv_type [(column_list)] ON [&#123;table|fuction|procedure&#125;] priv_level FROM &apos;USERNAME&apos;@&apos;HOST&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>priv_type</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INSERT,SELECT,UPDATE,DELETE,CREATE,DROP,RELOAD,SHUTDOWN,PROCESS,FILE,REFERENCES,INDEX,ALTER,SHOW DATABASES,SUPER,CREATE TEMPORARY TABLES,LOCK TABLES,EXECUTE,REPLICATION SLAVE,REPLICATION CLIENT,CREATE VIEW,SHOW VIEW,CREATE ROUTINE,ALTER ROUTINE,CREATE USER,EVENT,TRIGGER,CREATE TABLESPACE</span><br></pre></td></tr></table></figure>
<ul>
<li>resource_option</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MAX_QUERIES_PER_HOUR count          #这个用户每小时最大的查询总数</span><br><span class="line">MAX_UPDATES_PER_HOUR count          #这个用户每小时最大更新数</span><br><span class="line">MAX_CONNECTIONS_PER_HOUR count      #每小时最大的连接数</span><br><span class="line">MAX_USER_CONNECTIONS count          #最大用户并发连接数</span><br></pre></td></tr></table></figure>
<ul>
<li>用户授权示例</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GRANT ALL ON *.* TO &apos;root&apos;@&apos;%&apos; identified by &apos;123456&apos;;</span><br><span class="line">GRANT ALL ON db1.* TO &apos;jeffrey&apos;@&apos;localhost&apos;;</span><br><span class="line">GRANT SELECT ON db2.invoice TO &apos;jeffrey&apos;@&apos;localhost&apos;;</span><br><span class="line">GRANT USAGE ON *.* TO &apos;jeffrey&apos;@&apos;localhost&apos; WITH MAX_QUERIES_PER_HOUR 90;</span><br></pre></td></tr></table></figure>
<ul>
<li>收回权限</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">REVOKE INSERT ON *.* FROM &apos;jeffrey&apos;@&apos;localhost&apos;;</span><br></pre></td></tr></table></figure>
<h1 id="备份恢复"><a href="#备份恢复" class="headerlink" title="备份恢复"></a>备份恢复</h1><h2 id="mysqldump"><a href="#mysqldump" class="headerlink" title="mysqldump"></a>mysqldump</h2><p>mysqldump 是MySQL的一个命令行工具，用于逻辑备份。 </p>
<ul>
<li>重要参数</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-A	--all-databases</span><br><span class="line">备份所有数据库</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-B --databases</span><br><span class="line">备份多个数据库，会在输出 建库、选库的语句到SQL文件中</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-d --no-data</span><br><span class="line">不备份表数据</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-t --no-create-info</span><br><span class="line">不备份建表语句</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-T, --tab=name</span><br><span class="line">为给定每个表创建制表符分隔的文本文件</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-F, --flush-logs</span><br><span class="line">刷新产生新 binlog 文件，以便增量恢复，多库备份时候，每个库会刷新一次，如果只想刷新一次，可加 --lock-all-tables 或者 --master-data 参数</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--master-data=[1|2]</span><br><span class="line">在备份结果中增加 binglog 日志文件名，及对应的位置点，值为1时不注释状态，为2时为注释状态，该参数会打开--lock-all-tables功能，除非有 --single-transaction 在使用该参数时候会关闭 --lock-all-tables功能</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-x, --lock-all-tables</span><br><span class="line">锁定所有数据库的所有表为只读</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--single-transaction</span><br><span class="line">在备份 innodb 引擎时，通常会启用这个选项，来获取一个一致性的数据快照备份，它的工作原理是设定本次绘画的隔离级别为 REPEATABLE READ 并将整个备份放在一个事务里，以确保执行本次备份时，不会再看到其他连接绘画已经提交了的数据，即备份开始的时候数据是什么样，备份出来就是什么样子，但是这个参数是允许备份期间写入数据的。</span><br></pre></td></tr></table></figure>
<ul>
<li>InnoDB 建议备份策略</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump –uroot –A –F –E –R --single-transaction --master-data=1 -</span><br><span class="line">flush-privileges --triggers --hex-blob | gzip &gt;databases_$(date +%H%M%S).gz</span><br></pre></td></tr></table></figure>
<ul>
<li>MyISAM 建议备份策略</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysqldump –uroot –A –F –E –R –x --master-data=1 --flush-privileges -</span><br><span class="line">triggers --hex-blob | gzip &gt;databases_$(date +%H%M%S).gz</span><br></pre></td></tr></table></figure>
<ul>
<li>解压 <code>gz</code> 文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gzip -d databases_110102.gz</span><br></pre></td></tr></table></figure>
<ul>
<li>从压缩文件恢复数据库</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">gzip &lt; databases_110102.gz | mysql -u&lt;name&gt; -p&lt;password&gt; &lt;dbname&gt;</span><br></pre></td></tr></table></figure>
<h2 id="xtrebackup"><a href="#xtrebackup" class="headerlink" title="xtrebackup"></a>xtrebackup</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/42/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/42/">42</a><span class="page-number current">43</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Jin Heng">
            
              <p class="site-author-name" itemprop="name">Jin Heng</p>
              <p class="site-description motion-element" itemprop="description">越努力越幸运</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">86</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yangjinheng" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:jinhengyang@foxmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          
        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jin Heng</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  













  





  

  

  

  
  

  

  

  

</body>
</html>
