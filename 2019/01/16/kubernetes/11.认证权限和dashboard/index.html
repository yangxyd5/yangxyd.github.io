<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="用户认证系统apiserver 是所有请求访问的网关接口，请求过程中，认证用于实现身份识别，授权用于实现权限检查，实际上，我们使用命令行：kubectl apply -f ment.yaml，实际上是转换为 HTTP 协议向 apiserver 发起请求的，而认证是信息由 ~/.kube/config 这个文件提供的，这个文件记录了管理员权限的用户信息。  k8s 的 API 是 RESTfull">
<meta property="og:type" content="article">
<meta property="og:title" content="权限认证和dashboard">
<meta property="og:url" content="https://yangjinheng.github.io/2019/01/16/kubernetes/11.认证权限和dashboard/index.html">
<meta property="og:site_name" content="默默">
<meta property="og:description" content="用户认证系统apiserver 是所有请求访问的网关接口，请求过程中，认证用于实现身份识别，授权用于实现权限检查，实际上，我们使用命令行：kubectl apply -f ment.yaml，实际上是转换为 HTTP 协议向 apiserver 发起请求的，而认证是信息由 ~/.kube/config 这个文件提供的，这个文件记录了管理员权限的用户信息。  k8s 的 API 是 RESTfull">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-02-28T08:07:36.138Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="权限认证和dashboard">
<meta name="twitter:description" content="用户认证系统apiserver 是所有请求访问的网关接口，请求过程中，认证用于实现身份识别，授权用于实现权限检查，实际上，我们使用命令行：kubectl apply -f ment.yaml，实际上是转换为 HTTP 协议向 apiserver 发起请求的，而认证是信息由 ~/.kube/config 这个文件提供的，这个文件记录了管理员权限的用户信息。  k8s 的 API 是 RESTfull">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yangjinheng.github.io/2019/01/16/kubernetes/11.认证权限和dashboard/">





  <title>权限认证和dashboard | 默默</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?be46574a10a6c2b7f67e9c32a008cbd5";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">默默</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-前端知识">
          <a href="/categories/web/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-asterisk"></i> <br>
            
            前端知识
          </a>
        </li>
      
        
        <li class="menu-item menu-item-kubernetes">
          <a href="/categories/Kubernetes/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-cog"></i> <br>
            
            Kubernetes
          </a>
        </li>
      
        
        <li class="menu-item menu-item-运维笔记">
          <a href="/categories/运维笔记/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>
            
            运维笔记
          </a>
        </li>
      
        
        <li class="menu-item menu-item-python">
          <a href="/categories/Python/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-laptop"></i> <br>
            
            Python
          </a>
        </li>
      
        
        <li class="menu-item menu-item-golang">
          <a href="/categories/golang/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>
            
            Golang
          </a>
        </li>
      
        
        <li class="menu-item menu-item-个人日志">
          <a href="/categories/个人日志/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-github-alt"></i> <br>
            
            个人日志
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-question-circle"></i> <br>
            
            给我留言
          </a>
        </li>
      

      
    </ul>
  

  
</nav>


 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://yangjinheng.github.io/2019/01/16/kubernetes/11.认证权限和dashboard/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jin Heng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="默默">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">权限认证和dashboard</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-16T00:00:00+08:00">
                2019-01-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Kubernetes/" itemprop="url" rel="index">
                    <span itemprop="name">Kubernetes</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="用户认证系统"><a href="#用户认证系统" class="headerlink" title="用户认证系统"></a>用户认证系统</h1><p>apiserver 是所有请求访问的网关接口，请求过程中，认证用于实现身份识别，授权用于实现权限检查，实际上，我们使用命令行：kubectl apply -f ment.yaml，实际上是转换为 HTTP 协议向 apiserver 发起请求的，而认证是信息由 ~/.kube/config 这个文件提供的，这个文件记录了管理员权限的用户信息。</p>
<ul>
<li>k8s 的 API 是 RESTfull 风格的，所以资源是由路径标明的，在 k8s 中，资源只能属于两个地方：属于集群 或 属于名称空间。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">集群级别：namespace、pv</span><br><span class="line">名称空间：POD、deployment、daemonSet、 service、PCV</span><br></pre></td></tr></table></figure>
<p>例如：请求 delfault 名称空间下的 myapp-deploy 控制器，就是下面的写法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http://172.16.100.100/apis/apps/v1/namespaces/default/deployments/myapp-deploy</span><br></pre></td></tr></table></figure>
<p>上面表示：<a href="http://172.16.100.100:6443" target="_blank" rel="noopener">http://172.16.100.100:6443</a> 集群的 apis 下的 apps 组的 v1 版本的 namespaces 下寻找 default 下的 myapp-deploy 控制器</p>
<h2 id="用户的类型"><a href="#用户的类型" class="headerlink" title="用户的类型"></a>用户的类型</h2><p>我们使用 kubectl 连接 k8s 集群进行控制，实际上是使用用户家目录下 .kube/config 这个文件中的用户连接到 apiserver 实现认证的，而有些 POD （如：CoreDNS）也需要获取集群的信息，它们也需要连接到 k8s 集群中，所以 k8s 中用户的类型有两种：</p>
<ol>
<li>人类使用的用户：useraccount，处于用户家目录 .kube/config 文件中，可使用 kubectl config –help 获取帮助创建</li>
<li>POD 使用的用户：serviceaccunt，是一种 k8s 对象，它可以使用 kubectl create serviceaccount –help 获取帮助创建</li>
</ol>
<h2 id="POD如何连接集群"><a href="#POD如何连接集群" class="headerlink" title="POD如何连接集群"></a>POD如何连接集群</h2><p>POD 需要使用 serviceaccount 连接并认证到集群，POD 之所以能够连接到集群是因为有一个内置的 service 将 POD 的请求代理至 apiserver 的地址了。</p>
<ul>
<li>名字为 kubernetes 的 servie 为 POD 连接到 apiserver 提供了通信</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe service kubernetes                            <span class="comment"># 集群内部的 POD 与 apiserver 通信使用的 service ，但是注意 apiserver 需要认证的</span></span><br><span class="line"></span><br><span class="line">Name:              kubernetes</span><br><span class="line">Namespace:         default</span><br><span class="line">Labels:            component=apiserver</span><br><span class="line">                   provider=kubernetes</span><br><span class="line">Annotations:       &lt;none&gt;</span><br><span class="line">Selector:          &lt;none&gt;</span><br><span class="line">Type:              ClusterIP</span><br><span class="line">IP:                10.96.0.1                                     <span class="comment"># 集群内部访问 apiserver 的网关</span></span><br><span class="line">Port:              https  443/TCP</span><br><span class="line">TargetPort:        6443/TCP</span><br><span class="line">Endpoints:         172.16.100.101:6443                           <span class="comment"># apiserver 工作的地址</span></span><br><span class="line">Session Affinity:  None</span><br><span class="line">Events:            &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h2 id="serviceaccount-对象"><a href="#serviceaccount-对象" class="headerlink" title="serviceaccount 对象"></a>serviceaccount 对象</h2><p>k8s 的认证有两种一种是：human user、一种是 serviceaccount，下面就是创建 serviceaccount 它是 POD 访问 apiserver 所用的一种对象，而 human user，即使 kubectl 命令行通过读取 config 中的用户而认证到 apiserver 的。</p>
<ul>
<li>创建一个 serviceaccount 对象，它会自动创建并关联一个 secret，这个 serviceaccount 可以到 apiserver 上进行认证，但是认证不代表有权限，所以需要授权</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create serviceaccount admin</span><br><span class="line">$ kubectl get secret</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 POD 使用指定的 serviceaccount 对象</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod-serviceaccount-demo</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">ikubernetes/myapp:v1</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">http</span></span><br><span class="line">          <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">serviceAccountName:</span> <span class="string">admin</span></span><br></pre></td></tr></table></figure>
<h3 id="在-POD-中使用-serviceaccount"><a href="#在-POD-中使用-serviceaccount" class="headerlink" title="在 POD 中使用 serviceaccount"></a>在 POD 中使用 serviceaccount</h3><ul>
<li>POD 连接 apiserver 时候，需要在清单中指定 serviceAccountName 这个字段，详见：kubectl explain pods.spec</li>
</ul>
<p>每个 POD 默认自带一个 volumes，这是一个 secret，这个存储卷保存着 default-token-bq2gn 用来访问 apiserver ，而这个 secret 权限仅仅能通过 api 访问当前 POD 自身的信息，如果想要一个 POD 拥有管理集群的权限，那么可以手动创建一个 secret 并通过 volumes 挂载到 POD 上。</p>
<p>serviceaccout 也属于标准的 k8s 对象，这个对象提供了账号信息，但是账号由没有权限需要 rbac 机制来决定。</p>
<h2 id="kubectl-配置文件"><a href="#kubectl-配置文件" class="headerlink" title="kubectl 配置文件"></a>kubectl 配置文件</h2><ul>
<li>kubectl 配置文件解析，详见：kubectl config view</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">clusters:</span>                                             <span class="comment"># 集群列表</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span>                                            <span class="comment"># 列表中的一个集群对象</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">DATA+OMITTED</span>          <span class="comment"># 服务器认证方式</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://172.16.100.101:6443</span>               <span class="comment"># 集群的 apiserver 地址</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes</span>                                    <span class="comment"># 集群名称</span></span><br><span class="line"><span class="attr">users:</span>                                                <span class="comment"># 用户列表</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">kubernetes-admin</span>                              <span class="comment"># 列表中的一个用户对象</span></span><br><span class="line">  <span class="attr">user:</span>                                               <span class="comment"># </span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">REDACTED</span>                 <span class="comment"># 客户端证书</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">REDACTED</span>                         <span class="comment"># 客户端私钥</span></span><br><span class="line"><span class="attr">contexts:</span>                                             <span class="comment"># 上下文列表</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span>                                            <span class="comment"># 列表中的一个上下文对象</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">kubernetes</span>                               <span class="comment"># 集群名称</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">kubernetes-admin</span>                            <span class="comment"># 用户名称</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-admin@kubernetes</span>                   <span class="comment"># 上下文名称</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">kubernetes-admin@kubernetes</span>          <span class="comment"># 当前上下文</span></span><br><span class="line"><span class="attr">preferences:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>配置文件保存了：多个集群、多用户的配置，kubectl 可以使用不同的用户访问不同的集群。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">集群列表：集群对象列表</span><br><span class="line">用户列表：用户对象列表</span><br><span class="line">上下文：是描述集群与用户的关系列表。</span><br><span class="line">当前上下文：表示当前使用哪个用户访问哪个集群</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">自定义配置信息：详见：kubectl config  --<span class="built_in">help</span></span><br><span class="line">ca 和证书保存路径：/etc/kubernetes 保存了所有的 ca 和签发的证书信息。</span><br></pre></td></tr></table></figure>
<h2 id="添加证书用户到-config"><a href="#添加证书用户到-config" class="headerlink" title="添加证书用户到 config"></a>添加证书用户到 config</h2><p>k8s apiserver 认证方式有两种：ssl证书 和 token 认证，本次使用 ssl 证书创建用户</p>
<h3 id="创建SSL证书用户"><a href="#创建SSL证书用户" class="headerlink" title="创建SSL证书用户"></a>创建SSL证书用户</h3><ul>
<li>创建连接 apiserver 的用户证书</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建私钥</span></span><br><span class="line">(<span class="built_in">umask</span> 077; openssl genrsa -out jinheng.key 2048)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书签署请求，O 是组，CN 就是账号，这个账号被 k8s 用来识别身份，授权也需要授权这个账号</span></span><br><span class="line">openssl req -new -key jinheng.key -out jinheng.csr -subj <span class="string">"/CN=jinheng"</span></span><br><span class="line"><span class="comment">#penssl req -new -key jinheng.key -out jinheng.csr -subj "O=system:masters/CN=jinheng/"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 CA 签署证书，并且在 1800 天内有效</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> jinheng.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out jinheng.crt -days 1800</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> jinheng.crt -text -noout</span><br></pre></td></tr></table></figure>
<h3 id="添加SSL证书用户到config"><a href="#添加SSL证书用户到config" class="headerlink" title="添加SSL证书用户到config"></a>添加SSL证书用户到config</h3><ul>
<li>将 jinheng 用户添加到 k8s 的 config 中，设置客户端证书为 jinheng.crt，设置客户端私钥为：jinheng.key，使用 –embed-certs=true 来隐藏这些机密信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-credentials jinheng --client-certificate=./jinheng.crt --client-key=./jinheng.key --embed-certs=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="创建切换上下文"><a href="#创建切换上下文" class="headerlink" title="创建切换上下文"></a>创建切换上下文</h3><ul>
<li>创建上下文对象，授权 jinheng 用户访问名称为 kubernetes 的集群</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-context jinheng@kubernetes --cluster=kubernetes --user=jinheng</span><br></pre></td></tr></table></figure>
<ul>
<li>切换当前使用的上下文，到授权 jinheng 到 kubernetes 的上下文上</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config use-context jinheng@kubernetes</span><br></pre></td></tr></table></figure>
<ul>
<li>由于这个用户没有授权，所以这个用户是无法 get 到信息的，可以再切换回来</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">$ kubectl config use-context kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>
<h2 id="创建新-config-文件"><a href="#创建新-config-文件" class="headerlink" title="创建新 config 文件"></a>创建新 config 文件</h2><p>使用 kubectl config set-cluster 创建一个新的 config 文件，想要设定这个新创建的 config 文件可以使用 –kubeconfig=/tmp/test.conf 指明。</p>
<ul>
<li>设置集群的连接的 ca 机构证书，–kubeconfig 可以指定 kubectl 使用的配置文件位置，默认为用户家目录 .kube 目录中的 config</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-cluster k8s-cluster --server=https://172.16.100.101:6443 --certificate-authority=/etc/kubernetes/pki/ca.crt --embed-certs=<span class="literal">true</span> --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>将 jinheng 用户添加到 k8s 的 config 中，设置客户端证书为 jinheng.crt，设置客户端私钥为：jinheng.key，使用 –embed-certs=true 来隐藏这些机密信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-credentials jinheng --client-certificate=./jinheng.crt --client-key=./jinheng.key --embed-certs=<span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建上下文对象，授权 jinheng 用户访问名称为 kubernetes 的集群</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-context def-ns-admin@k8s-cluster --cluster=k8s-cluster --user=def-ns-admin --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>切换当前使用的上下文，到授权 jinheng 到 kubernetes 的上下文上</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config use-context def-ns-admin@k8s-cluster --kubeconfig=/tmp/test.con</span><br></pre></td></tr></table></figure>
<h2 id="基于-token-认证"><a href="#基于-token-认证" class="headerlink" title="基于 token 认证"></a>基于 token 认证</h2><h3 id="创建-serviceaccount"><a href="#创建-serviceaccount" class="headerlink" title="创建 serviceaccount"></a>创建 serviceaccount</h3><ul>
<li>为 POD 创建一个 serviceaccount 对象，它是 POD 访问 apiserver 的凭证</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create serviceaccount dashborad-admin -n kube-system</span><br></pre></td></tr></table></figure>
<h3 id="绑定集群管理员角色"><a href="#绑定集群管理员角色" class="headerlink" title="绑定集群管理员角色"></a>绑定集群管理员角色</h3><ul>
<li>创建 clusterrolebinding 将用户绑定至 cluster-admin 集群管理员（最高权限）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding dashborad-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashborad-admin</span><br></pre></td></tr></table></figure>
<h3 id="通过-serviceaccount-得到-Token"><a href="#通过-serviceaccount-得到-Token" class="headerlink" title="通过 serviceaccount 得到 Token"></a>通过 serviceaccount 得到 Token</h3><ul>
<li>找到刚才创建的 serviceaccount 对象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get secret -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>得到 serviceaccount 对象中的 Token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe secret -n kube-system dashborad-admin-token-skz95</span><br></pre></td></tr></table></figure>
<h1 id="用户权限系统"><a href="#用户权限系统" class="headerlink" title="用户权限系统"></a>用户权限系统</h1><p>在 k8s 中的用户权限系统是使用 RBAC 模式的，RBAC 是 Role-Based AC 的缩写，全称：基于角色的访问控制。</p>
<p>我们可以让一个用户扮演一个角色，而这个角色拥有权限，而这个用户就拥有了这个权限，所以在 RBAC 中，用户授权就是授权某个角色。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">用户（user）：用户可以拥有某个角色。</span><br><span class="line"></span><br><span class="line">角色（role）：角色可以拥有某些许可。</span><br><span class="line">	1. 操作</span><br><span class="line">	2. 对象</span><br><span class="line"></span><br><span class="line">许可（permission）： 在一个对象上能施加的操作组合起来，称之为一个许可权限。</span><br></pre></td></tr></table></figure>
<ul>
<li>用户类型</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Human User：              <span class="comment"># 用户账号</span></span><br><span class="line">Pod Service Account：     <span class="comment"># 服务账号</span></span><br></pre></td></tr></table></figure>
<ul>
<li>角色类型</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- rule（角色）、rolebinding（角色绑定）</span><br><span class="line">- clausterrole（集群角色）、clusterrolebinding（集群角色绑定）</span><br></pre></td></tr></table></figure>
<ul>
<li>授权类型</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- 用户通过 rolebinding 去 <span class="built_in">bind</span> rule，rolebinding 只能是当前命名空间中</span><br><span class="line">- 通过 clusterrolebinding 去 <span class="built_in">bind</span> clausterrole，clusterrolebinding会在所有名称空间生效</span><br><span class="line">- 通过 rolebinding 去 <span class="built_in">bind</span> clausterrole，由于 rolebinding 只在当前名称空间，所以 clausterrole 权限被限制为当前名称空间</span><br></pre></td></tr></table></figure>
<ul>
<li>通过 rolebinding 去 bind clausterrole 的好处</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">如果有很多名称空间、如果用 rolebinding 绑定 rule，那么则需要在每个名称空间都定义 role</span><br><span class="line">如果使用 rolebinding 绑定一个 clausterrole ，由于 clausterrole 拥有所有名称空间的权限，而 rolebinding  只能绑定当前名称空间，那么就省去为每个名称空间都新建一个 role 的过程了。</span><br></pre></td></tr></table></figure>
<h2 id="权限列表"><a href="#权限列表" class="headerlink" title="权限列表"></a>权限列表</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get clusterrole admin -o yaml</span><br></pre></td></tr></table></figure>
<h2 id="创建-Role"><a href="#创建-Role" class="headerlink" title="创建 Role"></a>创建 Role</h2><ul>
<li>命令行定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create role pods-reader --verb=get,list,watch --resource=pods</span><br></pre></td></tr></table></figure>
<ul>
<li>使用清单方式定义</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pods-reder</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span>                           <span class="comment"># 对哪些 api 群组内的资源进行操作</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">""</span></span><br><span class="line">  <span class="attr">resources:</span>                           <span class="comment"># 对哪些资源授权</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span>                               <span class="comment"># 授权做哪些操作</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br></pre></td></tr></table></figure>
<h2 id="创建-rolebinding"><a href="#创建-rolebinding" class="headerlink" title="创建 rolebinding"></a>创建 rolebinding</h2><ul>
<li>使用 rolebinding 对象创建，用户与 role 的绑定</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding jinheng-read-pods --role=pods-reader --user=jinheng</span><br></pre></td></tr></table></figure>
<ul>
<li>使用清单方式定义</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jinheng-read-pods</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pods-reader</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jinheng</span></span><br></pre></td></tr></table></figure>
<ul>
<li>切换用户和环境上下文</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl config use-context jinheng@kubernetes</span><br></pre></td></tr></table></figure>
<ul>
<li>测试用户是否拥有 get 权限</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>
<h2 id="创建-clusterrole"><a href="#创建-clusterrole" class="headerlink" title="创建 clusterrole"></a>创建 clusterrole</h2><ul>
<li>命令行定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrole cluster-reader --verb=get,list,watch --resource=pods</span><br></pre></td></tr></table></figure>
<ul>
<li>使用清单方式定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: cluster-reader</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - <span class="string">""</span></span><br><span class="line">  resources:</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br></pre></td></tr></table></figure>
<ul>
<li>系统内置有非常多的 clusterrole，详见：kubectl get clusterrole</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NAME                                                                   AGE</span><br><span class="line">admin                                                                  5d16h</span><br><span class="line">cluster-admin                                                          5d16h</span><br><span class="line">cluster-reader                                                         4m32s</span><br><span class="line">edit                                                                   5d16h</span><br><span class="line">flannel                                                                5d6h</span><br><span class="line">system:aggregate-to-admin                                              5d16h</span><br><span class="line">system:aggregate-to-edit                                               5d16h</span><br><span class="line">system:aggregate-to-view                                               5d16h</span><br><span class="line">system:auth-delegator                                                  5d16h</span><br><span class="line">system:aws-cloud-provider                                              5d16h</span><br><span class="line">system:basic-user                                                      5d16h</span><br><span class="line">system:certificates.k8s.io:certificatesigningrequests:nodeclient       5d16h</span><br><span class="line">system:certificates.k8s.io:certificatesigningrequests:selfnodeclient   5d16h</span><br><span class="line">system:controller:attachdetach-controller                              5d16h</span><br><span class="line">system:controller:certificate-controller                               5d16h</span><br><span class="line">system:controller:clusterrole-aggregation-controller                   5d16h</span><br><span class="line">system:controller:cronjob-controller                                   5d16h</span><br><span class="line">system:controller:daemon-set-controller                                5d16h</span><br></pre></td></tr></table></figure>
<h2 id="创建-clusterrolebinding"><a href="#创建-clusterrolebinding" class="headerlink" title="创建 clusterrolebinding"></a>创建 clusterrolebinding</h2><ul>
<li>命令行定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding jinheng-read-all-pods --clusterrole=cluster-reader --user=jinheng</span><br></pre></td></tr></table></figure>
<ul>
<li>清单定义</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jinheng-read-all-pods</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-reader</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jinheng</span></span><br></pre></td></tr></table></figure>
<ul>
<li>切换用户和环境上下文</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl config use-context jinheng@kubernetes</span><br></pre></td></tr></table></figure>
<ul>
<li>测试用户是否拥有 get 权限</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">$ kubectl config use-context kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>
<h2 id="rolebinding-与-clusterrole"><a href="#rolebinding-与-clusterrole" class="headerlink" title="rolebinding 与 clusterrole"></a>rolebinding 与 clusterrole</h2><p>如果使用 rolebinding 绑定一个 clausterrole ，由于 clausterrole 拥有所有名称空间的权限，而 rolebinding  只能绑定当前名称空间，那么就省去为每个名称空间都新建一个 role 的过程了。</p>
<ul>
<li>命令定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create rolebinding jinheng-cluster-reader --clusterrole=cluster-reader --user=jinheng</span><br></pre></td></tr></table></figure>
<ul>
<li>清单定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: RoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: jinheng-admin</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: admin</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: jinheng</span><br></pre></td></tr></table></figure>
<ul>
<li>切换用户和环境上下文</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl config use-context jinheng@kubernetes</span><br></pre></td></tr></table></figure>
<ul>
<li>测试用户是否拥有 get 权限，由于使用了 rolebinding ，所以 cluster-reader 被限制到当前命名空间</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods -n kube-system</span><br><span class="line">$ kubectl config use-context kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>
<h2 id="RBAC授权"><a href="#RBAC授权" class="headerlink" title="RBAC授权"></a>RBAC授权</h2><p>在 bind 授权的时候，可以绑定的用户主体有：user、group</p>
<ul>
<li>使用 rolebinding 和 clusterrolebinding 绑定</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">绑定到 user：表示只有这一个用户拥有 role 或者 clusterrole 的权限</span><br><span class="line">绑定到 group：表示这个组内的所有用户都具有了 role 或者 clusterrole 的权限</span><br></pre></td></tr></table></figure>
<ul>
<li>创建用户时候加入组，加入组后账户自动集成该组的权限</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建私钥</span></span><br><span class="line">(<span class="built_in">umask</span> 077; openssl genrsa -out jinheng.key 2048)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成证书签署请求，O 是组，CN 就是账号，这个账号被 k8s 用来识别身份，授权也需要授权这个账号</span></span><br><span class="line">openssl req -new -key jinheng.key -out jinheng.csr -subj <span class="string">"O=system:masters/CN=jinheng/"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 CA 签署证书，并且在 1800 天内有效</span></span><br><span class="line">openssl x509 -req -<span class="keyword">in</span> jinheng.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out jinheng.crt -days 1800</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> jinheng.crt -text -noout</span><br></pre></td></tr></table></figure>
<h1 id="dashboard"><a href="#dashboard" class="headerlink" title="dashboard"></a>dashboard</h1><p>它作为 k8s 集群的附件存在，是 kubernetes 官方的项目之一，详见：<a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard</a></p>
<h2 id="部署流程"><a href="#部署流程" class="headerlink" title="部署流程"></a>部署流程</h2><ul>
<li>为 dashboard 提供 ssl 证书</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 生成私钥</span></span><br><span class="line">(<span class="built_in">umask</span> 077; openssl genrsa -out dashboard.key 2048)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成一个自签证书，注意 CN 的值必须要与自己的域名完全一致</span></span><br><span class="line">openssl req -new -x509 -key dashboard.key -out dashboard.crt -subj <span class="string">"/O=dashboard/CN=k8s.dashboard.com"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看证书</span></span><br><span class="line">openssl x509 -<span class="keyword">in</span> dashboard.crt -text -noout</span><br></pre></td></tr></table></figure>
<ul>
<li>下载 dashboard 的清单文件</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">wget</span> <span class="string">https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml</span></span><br></pre></td></tr></table></figure>
<ul>
<li>为 dashboard 创建 secret 对象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl -n kube-system create secret generic kubernetes-dashboard-certs --from-file=dashboard.crt=./dashboard.crt --from-file=dashboard.key=./dashboard.key</span><br></pre></td></tr></table></figure>
<ul>
<li>修改 dashboard 清单中 service 的工作模式为 nodeport</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sed -i <span class="string">'/targetPort: 8443/a\ \ type: NodePort'</span> kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<ul>
<li>注释掉 kubernetes-dashboard.yaml 清单文件中的 Dashboard Secret 这个证书的清单定义</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ------------------- Dashboard Secret ------------------- #</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#apiVersion: v1</span></span><br><span class="line"><span class="comment">#kind: Secret</span></span><br><span class="line"><span class="comment">#metadata:</span></span><br><span class="line"><span class="comment">#  labels:</span></span><br><span class="line"><span class="comment">#    k8s-app: kubernetes-dashboard</span></span><br><span class="line"><span class="comment">#  name: kubernetes-dashboard-certs</span></span><br><span class="line"><span class="comment">#  namespace: kube-system</span></span><br><span class="line"><span class="comment">#type: Opaque</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#---</span></span><br></pre></td></tr></table></figure>
<ul>
<li>部署 dashboard 清单</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl apply -f kubernetes-dashboard.yaml</span><br></pre></td></tr></table></figure>
<ul>
<li>取得 service 运行的端口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get service -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 chrome 访问 dashboard</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">https://172.16.100.102:31097/</span><br></pre></td></tr></table></figure>
<h2 id="使用令牌登录"><a href="#使用令牌登录" class="headerlink" title="使用令牌登录"></a>使用令牌登录</h2><ul>
<li>为 POD 创建一个 serviceaccount 对象，它是 POD 访问 apiserver 的凭证</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create serviceaccount dashborad-admin -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 clusterrolebinding 将用户绑定至 cluster-admin 集群管理员（最高权限）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create clusterrolebinding dashborad-cluster-admin --clusterrole=cluster-admin --serviceaccount=kube-system:dashborad-admin</span><br></pre></td></tr></table></figure>
<ul>
<li>找到刚才创建的 serviceaccount 对象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get secret -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>得到 serviceaccount 对象中的 Token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe secret -n kube-system dashborad-admin</span><br></pre></td></tr></table></figure>
<h2 id="权限分级"><a href="#权限分级" class="headerlink" title="权限分级"></a>权限分级</h2><p>现在需要创建一个只能管理 default 名称空间的用户，那么我们可以用 rolebinding 去绑定 admin 这个 clusterrolue 对象，那么就获得了当前名称空间的管理员权限了。</p>
<ul>
<li>创建 serviceaccount 登录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create serviceaccount def-ns-admin -n default</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 rolebinding 对象，将 default 名称空间的 def-ns-admin 这个 serviceaccunt 与 admin 这个 clusterrole 绑定 </li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl create rolebinding def-ns-admin --clusterrole=admin --serviceaccount=default:def-ns-admin</span><br></pre></td></tr></table></figure>
<ul>
<li>找到刚才创建的 serviceaccount 对象</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get secret -n kube-system</span><br></pre></td></tr></table></figure>
<ul>
<li>得到 serviceaccount 对象中的 Token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe secret def-ns-admin</span><br></pre></td></tr></table></figure>
<h2 id="配置文件认证"><a href="#配置文件认证" class="headerlink" title="配置文件认证"></a>配置文件认证</h2><p>与之前基于 SSL 证书的 config 文件不同，这次使用是基于 Token 的 config 文件，可以不用创建证书了，使用已有的 serviceaccount 对象的 token。</p>
<ul>
<li>设置集群的连接的 ca 机构证书，–kubeconfig 可以指定 kubectl 使用的配置文件位置，默认为用户家目录 .kube 目录中的 config</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-cluster k8s-cluster --server=https://172.16.100.101:6443 --certificate-authority=/etc/kubernetes/pki/ca.crt --embed-certs=<span class="literal">true</span> --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>取得一个已经绑定角色的 serviceaccount 对象的 Token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl describe secret def-ns-admin</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 Token 来创建配置文件中的用户</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-credentials def-ns-admin --token=&lt;TOKEN&gt; --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>创建上下文对象，授权 jinheng 用户访问名称为 kubernetes 的集群</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config <span class="built_in">set</span>-context def-ns-admin@k8s-cluster --cluster=k8s-cluster --user=def-ns-admin --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>切换当前使用的上下文，到授权 jinheng 到 kubernetes 的上下文上</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl config use-context def-ns-admin@k8s-cluster --kubeconfig=/tmp/test.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>复制 /tmp/test.conf 这个文件到 dashboard 中就可以登录了</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/15/kubernetes/10.网络通信/" rel="next" title="K8S 网络基础">
                <i class="fa fa-chevron-left"></i> K8S 网络基础
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/17/kubernetes/13.prometheus监控/" rel="prev" title="prometheus">
                prometheus <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Jin Heng">
            
              <p class="site-author-name" itemprop="name">Jin Heng</p>
              <p class="site-description motion-element" itemprop="description">越努力越幸运</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">86</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yangjinheng" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:jinhengyang@foxmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          
        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#用户认证系统"><span class="nav-number">1.</span> <span class="nav-text">用户认证系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#用户的类型"><span class="nav-number">1.1.</span> <span class="nav-text">用户的类型</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#POD如何连接集群"><span class="nav-number">1.2.</span> <span class="nav-text">POD如何连接集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serviceaccount-对象"><span class="nav-number">1.3.</span> <span class="nav-text">serviceaccount 对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在-POD-中使用-serviceaccount"><span class="nav-number">1.3.1.</span> <span class="nav-text">在 POD 中使用 serviceaccount</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubectl-配置文件"><span class="nav-number">1.4.</span> <span class="nav-text">kubectl 配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加证书用户到-config"><span class="nav-number">1.5.</span> <span class="nav-text">添加证书用户到 config</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建SSL证书用户"><span class="nav-number">1.5.1.</span> <span class="nav-text">创建SSL证书用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加SSL证书用户到config"><span class="nav-number">1.5.2.</span> <span class="nav-text">添加SSL证书用户到config</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建切换上下文"><span class="nav-number">1.5.3.</span> <span class="nav-text">创建切换上下文</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建新-config-文件"><span class="nav-number">1.6.</span> <span class="nav-text">创建新 config 文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#基于-token-认证"><span class="nav-number">1.7.</span> <span class="nav-text">基于 token 认证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建-serviceaccount"><span class="nav-number">1.7.1.</span> <span class="nav-text">创建 serviceaccount</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#绑定集群管理员角色"><span class="nav-number">1.7.2.</span> <span class="nav-text">绑定集群管理员角色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过-serviceaccount-得到-Token"><span class="nav-number">1.7.3.</span> <span class="nav-text">通过 serviceaccount 得到 Token</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#用户权限系统"><span class="nav-number">2.</span> <span class="nav-text">用户权限系统</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#权限列表"><span class="nav-number">2.1.</span> <span class="nav-text">权限列表</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建-Role"><span class="nav-number">2.2.</span> <span class="nav-text">创建 Role</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建-rolebinding"><span class="nav-number">2.3.</span> <span class="nav-text">创建 rolebinding</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建-clusterrole"><span class="nav-number">2.4.</span> <span class="nav-text">创建 clusterrole</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建-clusterrolebinding"><span class="nav-number">2.5.</span> <span class="nav-text">创建 clusterrolebinding</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rolebinding-与-clusterrole"><span class="nav-number">2.6.</span> <span class="nav-text">rolebinding 与 clusterrole</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RBAC授权"><span class="nav-number">2.7.</span> <span class="nav-text">RBAC授权</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dashboard"><span class="nav-number">3.</span> <span class="nav-text">dashboard</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署流程"><span class="nav-number">3.1.</span> <span class="nav-text">部署流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用令牌登录"><span class="nav-number">3.2.</span> <span class="nav-text">使用令牌登录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#权限分级"><span class="nav-number">3.3.</span> <span class="nav-text">权限分级</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置文件认证"><span class="nav-number">3.4.</span> <span class="nav-text">配置文件认证</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jin Heng</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  













  





  

  

  

  
  

  

  

  

</body>
</html>
